
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Food Game Weekly Wrap</title>

<!-- PWA -->
<meta name="application-name" content="FGWW">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FGWW">
<meta name="theme-color" content="#0f1f38">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="Food Game Weekly Wrap ‚Äî Newsletter Engine">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzBmMWYzOCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxYTJmNTIiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiByeD0iNDAiIGZpbGw9InVybCgjYmcpIi8+CiAgPHJlY3QgeD0iMjgiIHk9IjI4IiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgcng9IjI4IiBmaWxsPSJub25lIiBzdHJva2U9IiNmNGE3YjkiIHN0cm9rZS13aWR0aD0iMS41IiBvcGFjaXR5PSIwLjI1Ii8+CiAgPHRleHQgeD0iMTI4IiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJHZW9yZ2lhLCBzZXJpZiIgZm9udC1zaXplPSIzOCIgZm9udC13ZWlnaHQ9IjkwMCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgbGV0dGVyLXNwYWNpbmc9Ii0wLjUiPkZvb2Q8L3RleHQ+CiAgPHRleHQgeD0iMTI4IiB5PSIxNDMiIGZvbnQtZmFtaWx5PSJHZW9yZ2lhLCBzZXJpZiIgZm9udC1zaXplPSIzOCIgZm9udC13ZWlnaHQ9IjkwMCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgbGV0dGVyLXNwYWNpbmc9Ii0wLjUiPkdhbWU8L3RleHQ+CiAgPHJlY3QgeD0iODgiIHk9IjE1NSIgd2lkdGg9IjgwIiBoZWlnaHQ9IjIiIGZpbGw9IiNmNGE3YjkiIG9wYWNpdHk9IjAuNiIgcng9IjEiLz4KICA8dGV4dCB4PSIxMjgiIHk9IjE4MyIgZm9udC1mYW1pbHk9Ikdlb3JnaWEsIHNlcmlmIiBmb250LXNpemU9IjIyIiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjZjRhN2I5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5XZWVrbHk8L3RleHQ+CiAgPHRleHQgeD0iMTI4IiB5PSIyMTAiIGZvbnQtZmFtaWx5PSJHZW9yZ2lhLCBzZXJpZiIgZm9udC1zaXplPSIyMiIgZm9udC13ZWlnaHQ9IjkwMCIgZmlsbD0iI2Y0YTdiOSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+V3JhcDwvdGV4dD4KPC9zdmc+">

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkZvb2QgR2FtZSBXZWVrbHkgV3JhcCIsICJzaG9ydF9uYW1lIjogIkZHV1ciLCAiZGVzY3JpcHRpb24iOiAiQXVzdHJhbGlhbiBIb3NwaXRhbGl0eSBJbnRlbGxpZ2VuY2UgXHUyMDE0IE5ld3NsZXR0ZXIgRW5naW5lIiwgInN0YXJ0X3VybCI6ICIuL2luZGV4Lmh0bWwiLCAic2NvcGUiOiAiLi8iLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMWYzOCIsICJ0aGVtZV9jb2xvciI6ICIjMGYxZjM4IiwgIm9yaWVudGF0aW9uIjogImFueSIsICJpY29ucyI6IFt7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQjJhV1YzUW05NFBTSXdJREFnTWpVMklESTFOaUkrQ2lBZ1BHUmxabk0rQ2lBZ0lDQThiR2x1WldGeVIzSmhaR2xsYm5RZ2FXUTlJbUpuSWlCNE1UMGlNQ1VpSUhreFBTSXdKU0lnZURJOUlqRXdNQ1VpSUhreVBTSXhNREFsSWo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXdKU0lnYzNSNWJHVTlJbk4wYjNBdFkyOXNiM0k2SXpCbU1XWXpPQ0l2UGdvZ0lDQWdJQ0E4YzNSdmNDQnZabVp6WlhROUlqRXdNQ1VpSUhOMGVXeGxQU0p6ZEc5d0xXTnZiRzl5T2lNeFlUSm1OVElpTHo0S0lDQWdJRHd2YkdsdVpXRnlSM0poWkdsbGJuUStDaUFnUEM5a1pXWnpQZ29nSUR4eVpXTjBJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQnllRDBpTkRBaUlHWnBiR3c5SW5WeWJDZ2pZbWNwSWk4K0NpQWdQSEpsWTNRZ2VEMGlNamdpSUhrOUlqSTRJaUIzYVdSMGFEMGlNakF3SWlCb1pXbG5hSFE5SWpJd01DSWdjbmc5SWpJNElpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5tTkdFM1lqa2lJSE4wY205clpTMTNhV1IwYUQwaU1TNDFJaUJ2Y0dGamFYUjVQU0l3TGpJMUlpOCtDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l4TURBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l6T0NJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJabVptWm1aaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJZ2JHVjBkR1Z5TFhOd1lXTnBibWM5SWkwd0xqVWlQa1p2YjJROEwzUmxlSFErQ2lBZ1BIUmxlSFFnZUQwaU1USTRJaUI1UFNJeE5ETWlJR1p2Ym5RdFptRnRhV3g1UFNKSFpXOXlaMmxoTENCelpYSnBaaUlnWm05dWRDMXphWHBsUFNJek9DSWdabTl1ZEMxM1pXbG5hSFE5SWprd01DSWdabWxzYkQwaUkyWm1abVptWmlJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSWdiR1YwZEdWeUxYTndZV05wYm1jOUlpMHdMalVpUGtkaGJXVThMM1JsZUhRK0NpQWdQSEpsWTNRZ2VEMGlPRGdpSUhrOUlqRTFOU0lnZDJsa2RHZzlJamd3SWlCb1pXbG5hSFE5SWpJaUlHWnBiR3c5SWlObU5HRTNZamtpSUc5d1lXTnBkSGs5SWpBdU5pSWdjbmc5SWpFaUx6NEtJQ0E4ZEdWNGRDQjRQU0l4TWpnaUlIazlJakU0TXlJZ1ptOXVkQzFtWVcxcGJIazlJa2RsYjNKbmFXRXNJSE5sY21sbUlpQm1iMjUwTFhOcGVtVTlJakl5SWlCbWIyNTBMWGRsYVdkb2REMGlPVEF3SWlCbWFXeHNQU0lqWmpSaE4ySTVJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1WFpXVnJiSGs4TDNSbGVIUStDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l5TVRBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l5TWlJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJZMFlUZGlPU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1YzSmhjRHd2ZEdWNGRENEtQQzl6ZG1jKyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsICJwdXJwb3NlIjogImFueSJ9LCB7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQjJhV1YzUW05NFBTSXdJREFnTWpVMklESTFOaUkrQ2lBZ1BHUmxabk0rQ2lBZ0lDQThiR2x1WldGeVIzSmhaR2xsYm5RZ2FXUTlJbUpuSWlCNE1UMGlNQ1VpSUhreFBTSXdKU0lnZURJOUlqRXdNQ1VpSUhreVBTSXhNREFsSWo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXdKU0lnYzNSNWJHVTlJbk4wYjNBdFkyOXNiM0k2SXpCbU1XWXpPQ0l2UGdvZ0lDQWdJQ0E4YzNSdmNDQnZabVp6WlhROUlqRXdNQ1VpSUhOMGVXeGxQU0p6ZEc5d0xXTnZiRzl5T2lNeFlUSm1OVElpTHo0S0lDQWdJRHd2YkdsdVpXRnlSM0poWkdsbGJuUStDaUFnUEM5a1pXWnpQZ29nSUR4eVpXTjBJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQnllRDBpTkRBaUlHWnBiR3c5SW5WeWJDZ2pZbWNwSWk4K0NpQWdQSEpsWTNRZ2VEMGlNamdpSUhrOUlqSTRJaUIzYVdSMGFEMGlNakF3SWlCb1pXbG5hSFE5SWpJd01DSWdjbmc5SWpJNElpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5tTkdFM1lqa2lJSE4wY205clpTMTNhV1IwYUQwaU1TNDFJaUJ2Y0dGamFYUjVQU0l3TGpJMUlpOCtDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l4TURBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l6T0NJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJabVptWm1aaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJZ2JHVjBkR1Z5TFhOd1lXTnBibWM5SWkwd0xqVWlQa1p2YjJROEwzUmxlSFErQ2lBZ1BIUmxlSFFnZUQwaU1USTRJaUI1UFNJeE5ETWlJR1p2Ym5RdFptRnRhV3g1UFNKSFpXOXlaMmxoTENCelpYSnBaaUlnWm05dWRDMXphWHBsUFNJek9DSWdabTl1ZEMxM1pXbG5hSFE5SWprd01DSWdabWxzYkQwaUkyWm1abVptWmlJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSWdiR1YwZEdWeUxYTndZV05wYm1jOUlpMHdMalVpUGtkaGJXVThMM1JsZUhRK0NpQWdQSEpsWTNRZ2VEMGlPRGdpSUhrOUlqRTFOU0lnZDJsa2RHZzlJamd3SWlCb1pXbG5hSFE5SWpJaUlHWnBiR3c5SWlObU5HRTNZamtpSUc5d1lXTnBkSGs5SWpBdU5pSWdjbmc5SWpFaUx6NEtJQ0E4ZEdWNGRDQjRQU0l4TWpnaUlIazlJakU0TXlJZ1ptOXVkQzFtWVcxcGJIazlJa2RsYjNKbmFXRXNJSE5sY21sbUlpQm1iMjUwTFhOcGVtVTlJakl5SWlCbWIyNTBMWGRsYVdkb2REMGlPVEF3SWlCbWFXeHNQU0lqWmpSaE4ySTVJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1WFpXVnJiSGs4TDNSbGVIUStDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l5TVRBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l5TWlJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJZMFlUZGlPU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1YzSmhjRHd2ZEdWNGRENEtQQzl6ZG1jKyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsICJwdXJwb3NlIjogImFueSJ9LCB7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQjJhV1YzUW05NFBTSXdJREFnTWpVMklESTFOaUkrQ2lBZ1BHUmxabk0rQ2lBZ0lDQThiR2x1WldGeVIzSmhaR2xsYm5RZ2FXUTlJbUpuSWlCNE1UMGlNQ1VpSUhreFBTSXdKU0lnZURJOUlqRXdNQ1VpSUhreVBTSXhNREFsSWo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXdKU0lnYzNSNWJHVTlJbk4wYjNBdFkyOXNiM0k2SXpCbU1XWXpPQ0l2UGdvZ0lDQWdJQ0E4YzNSdmNDQnZabVp6WlhROUlqRXdNQ1VpSUhOMGVXeGxQU0p6ZEc5d0xXTnZiRzl5T2lNeFlUSm1OVElpTHo0S0lDQWdJRHd2YkdsdVpXRnlSM0poWkdsbGJuUStDaUFnUEM5a1pXWnpQZ29nSUR4eVpXTjBJSGRwWkhSb1BTSXlOVFlpSUdobGFXZG9kRDBpTWpVMklpQnllRDBpTkRBaUlHWnBiR3c5SW5WeWJDZ2pZbWNwSWk4K0NpQWdQSEpsWTNRZ2VEMGlNamdpSUhrOUlqSTRJaUIzYVdSMGFEMGlNakF3SWlCb1pXbG5hSFE5SWpJd01DSWdjbmc5SWpJNElpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5tTkdFM1lqa2lJSE4wY205clpTMTNhV1IwYUQwaU1TNDFJaUJ2Y0dGamFYUjVQU0l3TGpJMUlpOCtDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l4TURBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l6T0NJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJabVptWm1aaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJZ2JHVjBkR1Z5TFhOd1lXTnBibWM5SWkwd0xqVWlQa1p2YjJROEwzUmxlSFErQ2lBZ1BIUmxlSFFnZUQwaU1USTRJaUI1UFNJeE5ETWlJR1p2Ym5RdFptRnRhV3g1UFNKSFpXOXlaMmxoTENCelpYSnBaaUlnWm05dWRDMXphWHBsUFNJek9DSWdabTl1ZEMxM1pXbG5hSFE5SWprd01DSWdabWxzYkQwaUkyWm1abVptWmlJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSWdiR1YwZEdWeUxYTndZV05wYm1jOUlpMHdMalVpUGtkaGJXVThMM1JsZUhRK0NpQWdQSEpsWTNRZ2VEMGlPRGdpSUhrOUlqRTFOU0lnZDJsa2RHZzlJamd3SWlCb1pXbG5hSFE5SWpJaUlHWnBiR3c5SWlObU5HRTNZamtpSUc5d1lXTnBkSGs5SWpBdU5pSWdjbmc5SWpFaUx6NEtJQ0E4ZEdWNGRDQjRQU0l4TWpnaUlIazlJakU0TXlJZ1ptOXVkQzFtWVcxcGJIazlJa2RsYjNKbmFXRXNJSE5sY21sbUlpQm1iMjUwTFhOcGVtVTlJakl5SWlCbWIyNTBMWGRsYVdkb2REMGlPVEF3SWlCbWFXeHNQU0lqWmpSaE4ySTVJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1WFpXVnJiSGs4TDNSbGVIUStDaUFnUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l5TVRBaUlHWnZiblF0Wm1GdGFXeDVQU0pIWlc5eVoybGhMQ0J6WlhKcFppSWdabTl1ZEMxemFYcGxQU0l5TWlJZ1ptOXVkQzEzWldsbmFIUTlJamt3TUNJZ1ptbHNiRDBpSTJZMFlUZGlPU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1YzSmhjRHd2ZEdWNGRENEtQQzl6ZG1jKyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsICJwdXJwb3NlIjogIm1hc2thYmxlIn1dfQ==">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0f1f38;
    --navy-mid: #1a2f52;
    --navy-light: #243b6b;
    --pink: #f4a7b9;
    --pink-light: #fce4ec;
    --pink-bright: #e91e8c;
    --white: #ffffff;
    --cream: #fdf8f5;
    --grey: #8a9ab5;
    --green: #4ade80;
    --amber: #fbbf24;
    --red: #f87171;
    --border: rgba(244,167,185,0.22);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--navy); color: var(--white); min-height: 100vh; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .engine { display: grid; grid-template-columns: 310px 1fr; min-height: 100vh; }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    background: var(--navy-mid);
    border-right: 1px solid var(--border);
    padding: 24px 20px;
    position: sticky; top: 0; height: 100vh;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 0;
  }
  .brand { margin-bottom: 20px; }
  .brand-eyebrow { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--pink); margin-bottom: 5px; }
  .brand-name { font-family: 'Playfair Display', serif; font-size: 19px; font-weight: 900; line-height: 1.1; }
  .brand-name span { color: var(--pink); }
  .brand-version { font-size: 10px; color: var(--grey); margin-top: 3px; }
  .divider { height: 1px; background: var(--border); margin: 14px 0; }

  /* Calendar widget */
  .cal-widget {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 14px;
  }
  .cal-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .cal-month { font-size: 13px; font-weight: 600; color: var(--white); }
  .cal-nav { background: none; border: none; color: var(--grey); cursor: pointer; font-size: 16px; padding: 2px 6px; transition: color 0.2s; }
  .cal-nav:hover { color: var(--pink); }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .cal-dow { font-size: 9px; text-align: center; color: var(--grey); padding: 2px; letter-spacing: 0.5px; }
  .cal-day {
    font-size: 11px; text-align: center; padding: 4px 2px; border-radius: 4px; cursor: pointer;
    color: rgba(255,255,255,0.6); transition: all 0.15s;
  }
  .cal-day:hover { background: rgba(244,167,185,0.15); color: var(--white); }
  .cal-day.today { background: rgba(244,167,185,0.15); color: var(--pink); font-weight: 600; }
  .cal-day.selected { background: var(--pink); color: var(--navy); font-weight: 700; }

  /* Workflow next-steps bar */
  .workflow-bar {
    background: linear-gradient(135deg, rgba(233,30,140,0.12), rgba(244,167,185,0.06));
    border: 1px solid rgba(244,167,185,0.25);
    border-radius: 10px;
    padding: 14px 18px;
    margin: 16px 0;
    display: none;
  }
  .workflow-bar.active { display: block; }
  .workflow-bar .wf-label {
    font-size: 9px; letter-spacing: 2.5px; text-transform: uppercase;
    color: #f4a7b9; font-weight: 700; margin-bottom: 8px;
  }
  .workflow-bar .wf-status {
    font-size: 11px; color: rgba(138,154,181,0.8); line-height: 1.5; margin-bottom: 12px;
  }
  .workflow-bar .wf-status .done { color: #4ade80; }
  .workflow-bar .wf-status .pending { color: rgba(138,154,181,0.45); }
  .workflow-bar .wf-btn {
    background: linear-gradient(135deg, #e91e8c, #c2185b);
    color: #fff; border: none; border-radius: 8px;
    padding: 10px 20px; font-size: 12px; font-weight: 600;
    cursor: pointer; font-family: 'DM Sans', sans-serif;
    letter-spacing: 0.3px; margin-right: 8px;
    box-shadow: 0 2px 10px rgba(233,30,140,0.25);
    transition: opacity 0.2s;
  }
  .workflow-bar .wf-btn:hover { opacity: 0.85; }
  .workflow-bar .wf-btn.secondary {
    background: rgba(255,255,255,0.08);
    box-shadow: none; border: 1px solid rgba(255,255,255,0.15);
  }
  .workflow-bar .wf-btn.secondary:hover { background: rgba(255,255,255,0.12); }
  .date-mode-badge { display:inline-block;font-size:9px;letter-spacing:1.2px;text-transform:uppercase;font-weight:700;padding:3px 8px;border-radius:4px; }
  .badge-current       { background:rgba(74,222,128,0.15);color:#4ade80; }
  .badge-historical    { background:rgba(251,191,36,0.15);color:#fbbf24; }
  .badge-retrospective { background:rgba(248,113,113,0.15);color:#f87171; }
  .badge-future        { background:rgba(138,154,181,0.15);color:#8a9ab5; }
  .cal-day.publish-day { border-bottom:2px solid #e91e8c;font-weight:600; }
  .cal-day.empty:hover { background: none; }
  .publish-track {
    margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);
    font-size: 11px; color: var(--grey);
  }
  .next-publish { color: var(--green); font-weight: 600; font-size: 12px; }
  .countdown { font-size: 10px; color: var(--grey); }

  /* Issue meta */
  .sidebar-label { font-size: 9px; letter-spacing: 2.5px; text-transform: uppercase; color: var(--pink); margin-bottom: 10px; display: block; }
  .meta-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }
  .meta-input {
    background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 7px;
    padding: 9px 12px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 12px; width: 100%;
  }
  .meta-input:focus { outline: none; border-color: var(--pink); }
  .meta-input::placeholder { color: var(--grey); }

  /* Section nav */
  .section-nav { display: flex; flex-direction: column; gap: 3px; flex: 1; }
  .nav-item {
    display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 7px;
    cursor: pointer; transition: all 0.2s; font-size: 12px; color: var(--grey);
    border: 1px solid transparent; justify-content: space-between;
  }
  .nav-item:hover { background: rgba(244,167,185,0.08); color: var(--white); }
  .nav-item.active { background: rgba(244,167,185,0.12); color: var(--pink); border-color: var(--border); }
  .nav-left { display: flex; align-items: center; gap: 8px; }
  .nav-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--grey); flex-shrink: 0; transition: background 0.2s; }
  .nav-item.active .nav-dot { background: var(--pink); }
  .nav-item.filled .nav-dot { background: var(--green); }
  .nav-wc { font-size: 9px; color: var(--grey); background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1px 6px; }

  /* Checklist */
  .checklist { margin-bottom: 14px; }
  .check-row {
    display: flex; align-items: center; gap: 8px; padding: 5px 0;
    font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .check-icon { font-size: 13px; flex-shrink: 0; }
  .check-label { color: var(--grey); flex: 1; }
  .check-row.done .check-label { color: rgba(255,255,255,0.5); text-decoration: line-through; }
  .check-row[onclick]:hover { background: rgba(244,167,185,0.08); border-radius: 4px; }

  /* Sidebar actions */
  .sidebar-actions { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
  .btn { padding: 10px 16px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; letter-spacing: 0.3px; width: 100%; }
  .btn-primary { background: var(--pink); color: var(--navy); }
  .btn-primary:hover { background: var(--pink-bright); color: var(--white); transform: translateY(-1px); }
  .btn-secondary { background: transparent; color: var(--grey); border: 1px solid var(--border); }
  .btn-secondary:hover { color: var(--white); border-color: var(--pink); }
  .btn-archive { background: rgba(244,167,185,0.08); color: var(--pink); border: 1px solid var(--border); }
  .btn-archive:hover { background: rgba(244,167,185,0.18); }
  .btn-editorial { background: linear-gradient(135deg, #1a1a3e, #0f1f38); color: #f4a7b9; border: 1px solid rgba(244,167,185,0.3); }
  .btn-editorial:hover { background: linear-gradient(135deg, #2a1a4e, #1a2f48); border-color: #f4a7b9; }
  .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { display: flex; flex-direction: column; }
  .top-bar {
    background: var(--navy-mid); border-bottom: 1px solid var(--border);
    padding: 12px 32px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 10;
  }
  .top-left { display: flex; align-items: center; gap: 12px; }
  .issue-badge { font-size: 10px; color: var(--pink); background: rgba(244,167,185,0.12); border: 1px solid var(--border); border-radius: 20px; padding: 3px 10px; }
  .wc-bar { font-size: 10px; color: var(--grey); }
  .wc-val { color: var(--white); font-weight: 600; }
  .rt-badge { font-size: 10px; color: var(--amber); background: rgba(251,191,36,0.1); border-radius: 20px; padding: 3px 10px; }
  .mode-toggle { display: flex; gap: 3px; background: rgba(255,255,255,0.06); border-radius: 7px; padding: 3px; }
  .mode-btn { padding: 5px 12px; border-radius: 5px; font-size: 11px; cursor: pointer; border: none; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; background: transparent; color: var(--grey); }
  .mode-btn.active { background: var(--navy); color: var(--white); }

  /* ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ */
  .editor-area { flex: 1; padding: 32px 44px; overflow-y: auto; }
  .panel { display: none; animation: fadeUp 0.25s ease; }
  .panel.active { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  .panel-header { margin-bottom: 24px; }
  .panel-tag { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--pink); margin-bottom: 6px; }
  .panel-title { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; line-height: 1.1; }
  .panel-desc { font-size: 12px; color: var(--grey); margin-top: 6px; line-height: 1.6; }

  .field-group { margin-bottom: 22px; }
  .field-label { font-size: 11px; font-weight: 600; color: var(--pink); letter-spacing: 0.4px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
  .field-hint { font-size: 10px; color: var(--grey); font-weight: 400; }
  .field-input, .field-textarea {
    width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 9px;
    padding: 12px 16px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 13px; line-height: 1.6;
    transition: border-color 0.2s, background 0.2s; resize: vertical;
  }
  .field-input:focus, .field-textarea:focus { outline: none; border-color: var(--pink); background: rgba(244,167,185,0.04); }
  .field-input::placeholder, .field-textarea::placeholder { color: rgba(138,154,181,0.65); }
  .field-textarea { min-height: 110px; }
  .field-textarea.tall { min-height: 190px; }

  /* Word counter per field */
  .field-wc { font-size: 10px; color: var(--grey); text-align: right; margin-top: 4px; }

  /* Formatting hint ‚Äî editor only, not published */
  .format-hint {
    font-size: 9px;
    color: rgba(138,154,181,0.45);
    margin-top: 5px;
    padding: 4px 0;
    letter-spacing: 0.2px;
    line-height: 1.5;
  }
  .format-hint strong { color: rgba(138,154,181,0.6); font-weight: 600; }
  .format-hint code { background: rgba(255,255,255,0.06); padding: 1px 4px; border-radius: 3px; font-size: 9px; color: rgba(138,154,181,0.6); }

  /* Game Angle box */
  .angle-box { background: rgba(233,30,140,0.07); border: 1px solid rgba(233,30,140,0.25); border-left: 4px solid #e91e8c; border-radius: 0 9px 9px 0; padding: 16px; margin-bottom: 22px; }
  .angle-label { font-size: 9px; letter-spacing: 2.5px; text-transform: uppercase; color: #e91e8c; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
  .angle-suggest-btn { background: rgba(233,30,140,0.15); border: 1px solid rgba(233,30,140,0.3); color: #e91e8c; border-radius: 5px; padding: 3px 8px; font-size: 10px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
  .angle-suggest-btn:hover { background: rgba(233,30,140,0.3); }
  .angle-hint { font-size: 10px; color: rgba(138,154,181,0.7); font-weight: 400; margin-bottom: 8px; }
  .angle-suggestion { background: rgba(233,30,140,0.1); border: 1px solid rgba(233,30,140,0.2); border-radius: 6px; padding: 10px 12px; font-size: 12px; color: rgba(255,255,255,0.8); font-style: italic; line-height: 1.6; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; display: none; }
  .angle-suggestion:hover { background: rgba(233,30,140,0.18); }
  .angle-suggestion.visible { display: block; }

  /* News items */
  .news-items { display: flex; flex-direction: column; gap: 14px; }
  .news-item { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
  .news-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .news-item-num { font-size: 10px; color: var(--pink); font-weight: 600; letter-spacing: 1px; }
  .remove-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--grey); border-radius: 5px; padding: 3px 8px; font-size: 11px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
  .remove-btn:hover { color: var(--red); border-color: var(--red); }
  .add-item-btn { margin-top: 10px; background: transparent; border: 1px dashed var(--border); color: var(--grey); border-radius: 9px; padding: 10px; width: 100%; font-family: 'DM Sans', sans-serif; font-size: 12px; cursor: pointer; transition: all 0.2s; }
  .add-item-btn:hover { border-color: var(--pink); color: var(--pink); }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* Inner field spacing */
  .inner-field { margin-bottom: 10px; }
  .inner-label { font-size: 10px; color: var(--pink); font-weight: 600; margin-bottom: 5px; letter-spacing: 0.3px; }
  .inner-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 7px; padding: 9px 12px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 12px; }
  .inner-input:focus { outline: none; border-color: var(--pink); }
  .inner-input::placeholder { color: rgba(138,154,181,0.6); }
  .inner-textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 7px; padding: 9px 12px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 12px; line-height: 1.5; min-height: 70px; resize: vertical; }
  .inner-textarea:focus { outline: none; border-color: var(--pink); }
  .inner-textarea::placeholder { color: rgba(138,154,181,0.6); }
  .inner-angle { width: 100%; background: rgba(233,30,140,0.05); border: 1px solid rgba(233,30,140,0.2); border-left: 3px solid rgba(233,30,140,0.5); border-radius: 0 7px 7px 0; padding: 9px 12px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 12px; line-height: 1.5; min-height: 55px; resize: vertical; }
  .inner-angle:focus { outline: none; border-color: #e91e8c; }
  .inner-angle::placeholder { color: rgba(138,154,181,0.6); }
  .angle-inner-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: #e91e8c; font-weight: 700; margin-bottom: 5px; }

  /* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ */
  .preview-area { display: none; padding: 32px 44px; flex: 1; }
  .preview-area.active { display: block; }
  .preview-frame { background: var(--white); border-radius: 14px; overflow: hidden; box-shadow: 0 32px 70px rgba(0,0,0,0.4); max-width: 660px; margin: 0 auto; font-family: 'DM Sans', Arial, sans-serif; color: #1a1a2e; }

  /* ‚îÄ‚îÄ ARCHIVE PANEL ‚îÄ‚îÄ */
  .archive-panel { display: none; padding: 32px 44px; flex: 1; overflow-y: auto; }
  .archive-panel.active { display: block; }
  .archive-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 20px; }
  .archive-card { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 18px; cursor: pointer; transition: all 0.2s; }
  .archive-card:hover { border-color: var(--pink); background: rgba(244,167,185,0.06); }
  .archive-card-num { font-size: 10px; color: var(--pink); letter-spacing: 2px; margin-bottom: 6px; }
  .archive-card-title { font-family: 'Playfair Display', serif; font-size: 16px; margin-bottom: 6px; }
  .archive-card-date { font-size: 11px; color: var(--grey); }
  .archive-card-actions { display: flex; gap: 8px; margin-top: 12px; }
  .archive-action { font-size: 11px; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-family: 'DM Sans', sans-serif; border: 1px solid var(--border); background: transparent; color: var(--grey); transition: all 0.2s; }
  .archive-action:hover { color: var(--white); border-color: var(--pink); }
  .archive-action.del:hover { color: var(--red); border-color: var(--red); }
  .archive-empty { text-align: center; padding: 60px 20px; color: var(--grey); }
  .archive-empty-icon { font-size: 40px; margin-bottom: 12px; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: var(--navy-mid); border: 1px solid var(--border); border-radius: 14px; padding: 32px; max-width: 620px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 22px; margin-bottom: 6px; }
  .modal-sub { font-size: 12px; color: var(--grey); margin-bottom: 18px; }
  .code-block { background: #0a1628; border: 1px solid var(--border); border-radius: 9px; padding: 18px; font-size: 11px; font-family: 'Courier New', monospace; color: #b8d4ff; white-space: pre-wrap; max-height: 280px; overflow-y: auto; line-height: 1.5; margin-bottom: 14px; }
  .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
  .modal-btn { padding: 10px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; border: none; transition: all 0.2s; }
  .modal-btn-primary { background: var(--pink); color: var(--navy); }
  .modal-btn-primary:hover { background: var(--pink-bright); color: var(--white); }
  .modal-btn-secondary { background: transparent; color: var(--grey); border: 1px solid var(--border); }
  .modal-btn-secondary:hover { color: var(--white); border-color: var(--pink); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

  /* Toast */
  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--navy-mid); border: 1px solid var(--pink); border-radius: 8px; padding: 12px 18px; font-size: 13px; color: var(--white); z-index: 200; transform: translateY(80px); opacity: 0; transition: all 0.3s; pointer-events: none; }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* Scan Archive */
  .scan-week { background: var(--white); border-radius: 10px; margin-bottom: 12px; overflow: hidden; }
  .scan-week-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; cursor: pointer; transition: background 0.15s; }
  .scan-week-header:hover { background: rgba(0,0,0,0.02); }
  .scan-expand-icon { font-size: 12px; color: #888; transition: transform 0.2s; }
  .scan-week.expanded .scan-expand-icon { transform: rotate(90deg); }
  .scan-week-stories { display: none; padding: 0 18px 14px; }
  .scan-week.expanded .scan-week-stories { display: block; }
  .scan-story { padding: 12px 0; border-top: 1px solid #f0f0f0; }
  .scan-story:first-child { border-top: none; }

  /* .ai-find-btn defined in AI SYSTEM section below */

/* Legacy classes removed in v4 cleanup */
/* Duplicate finder CSS removed ‚Äî defined in AI SYSTEM section below */



/* ‚îÄ‚îÄ AI SYSTEM ‚îÄ‚îÄ */
.build-btn {
  background: linear-gradient(135deg,#e91e8c,#c2185b);
  color:#fff;border:none;border-radius:10px;padding:10px 20px;
  font-size:12px;font-weight:700;letter-spacing:0.5px;cursor:pointer;
  margin-left:12px;box-shadow:0 4px 16px rgba(233,30,140,0.35);transition:all 0.2s;
}
.build-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(233,30,140,0.45);}
.ai-find-btn {
  background:linear-gradient(135deg,#1a1a3e,#0f1f38);color:#f4a7b9;
  border:1px solid rgba(244,167,185,0.3);border-radius:8px;padding:8px 14px;
  font-size:11px;font-weight:600;letter-spacing:0.5px;cursor:pointer;
  margin-left:8px;transition:all 0.2s;
}
.ai-find-btn:hover{border-color:#f4a7b9;background:linear-gradient(135deg,#2a1a4e,#1a2f48);}
.ai-find-btn:disabled{opacity:0.5;cursor:not-allowed;}
.ai-modal {
  display:none;position:fixed;inset:0;background:rgba(5,10,20,0.92);
  z-index:2000;align-items:flex-start;justify-content:center;
  backdrop-filter:blur(6px);overflow-y:auto;padding:32px 16px;
}
.ai-modal.active{display:flex;}
.ai-box {
  background:#0a1628;border:1px solid rgba(244,167,185,0.2);
  border-radius:20px;padding:32px;width:700px;max-width:96vw;
}
.ai-box-title{font-family:'Playfair Display',serif;font-size:24px;color:#fff;margin-bottom:6px;}
.ai-box-sub{font-size:12px;color:rgba(138,154,181,0.7);margin-bottom:24px;line-height:1.6;}
.ai-phase{display:none;}
.ai-phase.active{display:block;}
.ai-field label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(138,154,181,0.6);font-weight:700;margin-bottom:6px;}
.ai-field input,.ai-field select{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(244,167,185,0.2);border-radius:8px;padding:10px 12px;color:#fff;font-size:12px;font-family:'DM Sans',sans-serif;box-sizing:border-box;outline:none;}
.ai-field input:focus,.ai-field select:focus{border-color:#f4a7b9;}
.ai-field select option{background:#0f1f38;}
.ai-config{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
.ai-run-btn{background:linear-gradient(135deg,#e91e8c,#c2185b);color:#fff;border:none;border-radius:10px;padding:14px 28px;font-size:13px;font-weight:700;cursor:pointer;width:100%;margin-bottom:16px;transition:opacity 0.2s;}
.ai-run-btn:hover{opacity:0.88;}
.ai-run-btn:disabled{opacity:0.45;cursor:not-allowed;}
.ai-progress-wrap{height:5px;background:rgba(255,255,255,0.08);border-radius:3px;margin-bottom:10px;overflow:hidden;}
.ai-progress-bar{height:100%;background:linear-gradient(90deg,#e91e8c,#f4a7b9);border-radius:3px;width:0%;transition:width 0.4s ease;}
.ai-log{font-size:11px;color:rgba(138,154,181,0.7);font-family:'Courier New',monospace;line-height:1.7;max-height:100px;overflow-y:auto;margin-bottom:14px;}
.log-active{color:#f4a7b9;}
.log-done{color:#4ade80;}
.log-error{color:#f87171;}
.master-card{background:rgba(255,255,255,0.04);border:1px solid rgba(244,167,185,0.12);border-radius:10px;padding:14px;margin-bottom:10px;transition:all 0.2s;}
.master-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px;}
.master-check{display:flex;align-items:flex-start;gap:8px;cursor:pointer;flex:1;}
.master-check input[type=checkbox]{margin-top:2px;accent-color:#e91e8c;flex-shrink:0;}
.master-headline{font-size:13px;font-weight:600;color:#fff;line-height:1.4;}
.master-tag{display:inline-block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;padding:3px 8px;border-radius:4px;flex-shrink:0;}
.master-source{font-size:10px;color:rgba(138,154,181,0.6);margin-bottom:5px;}
.master-relevance{font-size:11px;color:rgba(138,154,181,0.8);line-height:1.5;margin-bottom:8px;}
.master-classify{display:none;align-items:center;gap:14px;padding:8px 0 2px;flex-wrap:wrap;}
.classify-opt{display:flex;align-items:center;gap:5px;font-size:11px;color:rgba(138,154,181,0.8);cursor:pointer;}
.classify-opt input[type=radio]{accent-color:#e91e8c;}
.build-result-card{background:rgba(255,255,255,0.04);border:1px solid rgba(244,167,185,0.12);border-radius:10px;padding:14px;margin-bottom:10px;}
.build-result-tag{display:inline-block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;padding:3px 8px;border-radius:4px;margin-bottom:8px;}
.build-result-tag.industry{background:rgba(233,30,140,0.2);color:#f4a7b9;}
.build-result-tag.economics{background:rgba(21,101,192,0.25);color:#90caf9;}
.build-result-tag.deepdive{background:rgba(251,191,36,0.2);color:#fbbf24;}
.build-result-headline{font-size:13px;font-weight:600;color:#fff;margin-bottom:4px;line-height:1.4;}
.build-result-url{font-size:10px;color:rgba(138,154,181,0.6);margin-bottom:6px;}
.build-result-preview{font-size:11px;color:rgba(138,154,181,0.75);line-height:1.6;}
.ai-actions{display:flex;gap:10px;margin-top:20px;}
.ai-accept-btn{flex:1;background:#e91e8c;color:#fff;border:none;border-radius:8px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;transition:opacity 0.2s;}
.ai-accept-btn:hover{opacity:0.85;}
.ai-close-btn{background:transparent;border:1px solid rgba(244,167,185,0.2);color:rgba(138,154,181,0.7);border-radius:8px;padding:12px 20px;font-size:12px;cursor:pointer;}
.ai-finder-input{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(244,167,185,0.2);border-radius:8px;padding:12px 14px;color:#fff;font-size:13px;font-family:'DM Sans',sans-serif;box-sizing:border-box;margin-bottom:12px;outline:none;}
.ai-finder-input:focus{border-color:#f4a7b9;}
.ai-finder-status{font-size:12px;color:rgba(138,154,181,0.7);text-align:center;padding:16px 0;font-style:italic;}
.ai-result-card{background:rgba(255,255,255,0.05);border:1px solid rgba(244,167,185,0.15);border-radius:10px;padding:14px;margin-bottom:10px;}
.ai-result-headline{font-size:13px;font-weight:600;color:#fff;margin-bottom:4px;line-height:1.4;}
.ai-result-url{font-size:10px;color:#e91e8c;margin-bottom:6px;}
.ai-result-desc{font-size:11px;color:rgba(138,154,181,0.8);line-height:1.5;}
.ai-result-use-btn{background:#e91e8c;color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:10px;font-weight:600;cursor:pointer;margin-top:8px;}
.selection-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:10px 14px;background:rgba(255,255,255,0.04);border-radius:8px;}
.selection-count{font-size:12px;color:#f4a7b9;font-weight:600;}
.selection-hint{font-size:11px;color:rgba(138,154,181,0.6);}
</style>
</head>
<body>

<div class="engine">

<!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
<aside class="sidebar">
  <div class="brand">
    <div class="brand-eyebrow">Newsletter Engine</div>
    <div class="brand-name">Food Game <span>Weekly Wrap</span></div>
    <div class="brand-version">v4.0 ¬∑ Australia's Hospitality Intelligence</div>
  </div>

  <!-- CALENDAR -->
  <div class="cal-widget">
    <div class="cal-header">
      <button class="cal-nav" onclick="calNav(-1)">‚Äπ</button>
      <span class="cal-month" id="calMonth"></span>
      <button class="cal-nav" onclick="calNav(1)">‚Ä∫</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="publish-track">
      <div class="next-publish" id="nextPublish"></div>
      <div class="countdown" id="countdown"></div>
    </div>
  </div>

  <div class="divider"></div>
  <span class="sidebar-label">Issue Details</span>
  <div class="meta-row">
    <input class="meta-input" id="issueNumber" placeholder="Issue # (e.g. 001)" oninput="updateBadge()"/>
    <div style="margin-top:6px;">
      <div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(138,154,181,0.5);font-weight:700;margin-bottom:4px;">Week ending</div>
      <input class="meta-input" id="issueDate" placeholder="Click a Friday in the calendar" readonly style="width:100%;box-sizing:border-box;margin-top:0;"/>
      <div id="dateModeBlip" style="margin-top:5px;min-height:20px;"></div>
    </div>
  </div>

  <div class="divider"></div>
  <span class="sidebar-label">Sections</span>
  <nav class="section-nav" id="sectionNav">
    <div class="nav-item active" data-panel="intro" onclick="switchPanel('intro',this)">
      <div class="nav-left"><span class="nav-dot"></span>Editorial Intro</div>
      <span class="nav-wc" id="wc-intro">0w</span>
    </div>
    <div class="nav-item" data-panel="news" onclick="switchPanel('news',this)">
      <div class="nav-left"><span class="nav-dot"></span>Industry News</div>
      <span class="nav-wc" id="wc-news">0w</span>
    </div>
    <div class="nav-item" data-panel="econ" onclick="switchPanel('econ',this)">
      <div class="nav-left"><span class="nav-dot"></span>Economics</div>
      <span class="nav-wc" id="wc-econ">0w</span>
    </div>
    <div class="nav-item" data-panel="deepdive" onclick="switchPanel('deepdive',this)">
      <div class="nav-left"><span class="nav-dot"></span>Deep Dive</div>
      <span class="nav-wc" id="wc-deepdive">0w</span>
    </div>
    <div class="nav-item" data-panel="resources" onclick="switchPanel('resources',this)">
      <div class="nav-left"><span class="nav-dot"></span>Resources</div>
      <span class="nav-wc" id="wc-resources">0w</span>
    </div>
    <div class="nav-item" data-panel="spotlight" onclick="switchPanel('spotlight',this)">
      <div class="nav-left"><span class="nav-dot"></span>Spotlight</div>
      <span class="nav-wc" id="wc-spotlight">0w</span>
    </div>
  </nav>

  <div class="divider"></div>
  <div style="padding:0 4px;">
    <button onclick="loadDemoIssue()" style="width:100%;background:transparent;border:1px dashed rgba(255,255,255,0.15);color:rgba(138,154,181,0.5);border-radius:6px;padding:7px;font-size:10px;cursor:pointer;letter-spacing:0.5px;">Load Issue 001 Demo</button>
  </div>

  <div class="divider"></div>
  <span class="sidebar-label">Pre-flight Checklist</span>
  <div class="checklist" id="checklist"></div>

  <div class="sidebar-actions">
    <button class="btn btn-editorial" onclick="openEditorialWriter()">‚ú¶ Write Editorial & Game Angle</button>
    <button class="btn btn-primary" onclick="showPreview()">Preview Issue</button>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="saveToArchive()">Save Issue</button>
      <button class="btn btn-secondary" onclick="exportHTML()">Export HTML</button>
    </div>
    <button class="btn btn-archive" onclick="showArchive()">üìÅ Issue Archive</button>
    <button class="btn btn-archive" onclick="showScanArchive()">üîç Scan Archive</button>
    <button class="btn btn-archive" onclick="document.getElementById('sidebarFileInput').click()">üì§ Import Issue</button>
    <input type="file" id="sidebarFileInput" accept=".html,.htm" style="display:none;" onchange="handleIssueUpload(event)">
    <button class="btn btn-secondary" onclick="resetAll()">Clear & New Issue</button>
  </div>
</aside>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main class="main">
  <div class="top-bar">
    <div class="top-left">
      <span class="issue-badge" id="issueBadge">New Issue</span>
      <span class="wc-bar">Total: <span class="wc-val" id="totalWC">0</span> words</span>
      <span class="rt-badge" id="rtBadge">~0 min read</span>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="editModeBtn" onclick="setMode('edit')">Edit</button>
      <button class="mode-btn" id="previewModeBtn" onclick="setMode('preview')" style="display:none">Preview</button>
      <button class="mode-btn" id="archiveModeBtn" onclick="setMode('archive')" style="display:none">Archive</button>
    </div>
  </div>

  <!-- EDITOR -->
  <div class="editor-area" id="editorArea">

  <!-- EMPTY STATE -->
  <div id="emptyState" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;padding:40px;">
    <div style="font-size:48px;margin-bottom:20px;opacity:0.4;">‚ö°</div>
    <div style="font-family:'Playfair Display',serif;font-size:28px;color:#0f1f38;font-weight:700;margin-bottom:12px;">Ready to build.</div>
    <div style="font-size:14px;color:#888;max-width:420px;line-height:1.7;margin-bottom:32px;">Set your issue number and date in the sidebar, then click <strong>Build This Issue</strong> to scan this week's news, select stories, and generate the full issue in one flow.</div>
    <button onclick="openBuildModal()" style="background:linear-gradient(135deg,#e91e8c,#c2185b);color:#fff;border:none;border-radius:12px;padding:16px 36px;font-size:15px;font-weight:700;cursor:pointer;letter-spacing:0.3px;box-shadow:0 4px 20px rgba(233,30,140,0.3);margin-bottom:12px;">‚ö° Build This Issue</button>
    <div style="display:flex;gap:10px;margin-bottom:12px;">
      <button onclick="showArchive()" style="background:transparent;color:#8a9ab5;border:1px solid rgba(138,154,181,0.3);border-radius:12px;padding:12px 28px;font-size:13px;font-weight:600;cursor:pointer;letter-spacing:0.3px;">üìÅ Load from Archive</button>
      <button onclick="document.getElementById('issueFileInput').click()" style="background:transparent;color:#8a9ab5;border:1px solid rgba(138,154,181,0.3);border-radius:12px;padding:12px 28px;font-size:13px;font-weight:600;cursor:pointer;letter-spacing:0.3px;">üì§ Import Issue</button>
    </div>
    <input type="file" id="issueFileInput" accept=".html,.htm" style="display:none;" onchange="handleIssueUpload(event)">
    <div style="font-size:11px;color:#bbb;">Or navigate to any section in the sidebar to write manually</div>
    <div style="margin-top:48px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-width:500px;width:100%;">
      <div style="background:#fff;border-radius:10px;padding:16px;border:1px solid #eee;"><div style="font-size:18px;font-weight:700;color:#e91e8c;margin-bottom:8px;">1</div><div style="font-size:11px;font-weight:600;color:#0f1f38;margin-bottom:4px;">Scan</div><div style="font-size:11px;color:#888;line-height:1.5;">AI finds 12 real stories from the past 7 days</div></div>
      <div style="background:#fff;border-radius:10px;padding:16px;border:1px solid #eee;"><div style="font-size:18px;font-weight:700;color:#e91e8c;margin-bottom:8px;">2</div><div style="font-size:11px;font-weight:600;color:#0f1f38;margin-bottom:4px;">Select</div><div style="font-size:11px;color:#888;line-height:1.5;">You pick 4 to 6 and classify each one</div></div>
      <div style="background:#fff;border-radius:10px;padding:16px;border:1px solid #eee;"><div style="font-size:18px;font-weight:700;color:#e91e8c;margin-bottom:8px;">3</div><div style="font-size:11px;font-weight:600;color:#0f1f38;margin-bottom:4px;">Review</div><div style="font-size:11px;color:#888;line-height:1.5;">AI writes everything. You review and publish.</div></div>
    </div>
  </div>

    <!-- WORKFLOW NEXT STEPS BAR -->
    <div class="workflow-bar" id="workflowBar">
      <div class="wf-label">Build Progress</div>
      <div class="wf-status" id="workflowStatus"></div>
      <div id="workflowActions"></div>
    </div>

    <!-- INTRO -->
    <div class="panel active" id="panel-intro">
      <div class="panel-header">
        <div class="panel-tag">Section 01 - Editorial</div>
        <div class="panel-title">Editorial Intro</div>
        <div class="panel-desc">Your opening note. Direct. Authoritative. Sets the frame for everything that follows.</div>
      </div>
      <div class="field-group">
        <div class="field-label">Opening Hook <span class="field-hint">The first sentence. Make it land.</span></div>
        <input class="field-input" id="introHook" oninput="updateCounts()" placeholder="e.g. The RBA's first rate hike since 2023 landed Tuesday. It did not land quietly."/>
        <div class="field-wc" id="fwc-introHook"></div>
      </div>
      <div class="field-group">
        <div class="field-label">Editorial Body <span class="field-hint">2‚Äì4 sentences. Your voice, your read on the week.</span></div>
        <textarea class="field-textarea" id="introBody" oninput="updateCounts()" placeholder="Write your editorial note here..."></textarea>
        <div class="format-hint">Formatting you can use in this field: &nbsp; <strong>[link text](url)</strong> creates a clickable hyperlink, e.g. <code>[Fair Work](https://fairwork.gov.au)</code> &nbsp;¬∑&nbsp; <strong>**bold text**</strong> wraps words in bold &nbsp;¬∑&nbsp; <strong>*italic text*</strong> wraps words in italic &nbsp;¬∑&nbsp; <strong>![description](image-url)</strong> inserts a centred image, e.g. <code>![Venue photo](https://example.com/photo.jpg)</code> &nbsp;¬∑&nbsp; Leave a blank line between paragraphs to separate them</div>
        <div class="field-wc" id="fwc-introBody"></div>
      </div>
      <div class="field-group">
        <div class="field-label">Sign-off Name</div>
        <input class="field-input" id="introSignoff" oninput="updateCounts()" placeholder="e.g. JB"/>
      </div>
      <div class="angle-box">
        <div class="angle-label">
          üéØ The Game Angle - Issue Wide
          <button class="angle-suggest-btn" onclick="suggestAngle('intro')">‚ú¶ Suggest</button>
        </div>
        <div class="angle-hint">The behavioural or systems-level insight this whole issue surfaces, if one is there. Leave blank if not.</div>
        <div class="angle-suggestion" id="angle-suggest-intro" onclick="useAngleSuggestion('introGameAngle','angle-suggest-intro')"></div>
        <textarea class="field-textarea" id="introGameAngle" oninput="updateCounts()" style="min-height:90px;" placeholder="e.g. The RBA hike does not kill hospitality directly. It squeezes the margin on the mortgage the operator took to fund the fitout. That is the feedback loop nobody is pricing in yet."></textarea>
      </div>
    </div>

    <!-- NEWS -->
    <div class="panel" id="panel-news">
      <div class="panel-header">
        <div class="panel-tag">Section 02 - Industry News</div>
        <div class="panel-title">Top News Roundup</div>
        <div class="panel-desc">Australia's hospitality headlines this week. 3 to 5 stories. Each gets a headline, 2 to 3 paragraphs of commentary, and a Game Angle if a pattern emerges. Write it like a briefing, not a summary.</div>
      </div>
      <div class="news-items" id="newsItems"></div>
      <button class="add-item-btn" onclick="addNewsItem('newsItems','Industry')">+ Add Story</button>
    <button class="ai-find-btn" onclick="openAIFinder('newsItems','Industry')">‚ú¶ AI Find Story</button>
    </div>

    <!-- ECON -->
    <div class="panel" id="panel-econ">
      <div class="panel-header">
        <div class="panel-tag">Section 03 - Economics</div>
        <div class="panel-title">Economics Roundup</div>
        <div class="panel-desc">Macro and sector-level economics that directly affect the hospitality game. 2 to 4 stories. Each gets a headline, 2 to 3 paragraphs of real analysis, and a Game Angle where the systems insight is visible.</div>
      </div>
      <div class="news-items" id="econItems"></div>
      <button class="add-item-btn" onclick="addNewsItem('econItems','Economics')">+ Add Economic Story</button>
    <button class="ai-find-btn" onclick="openAIFinder('econItems','Economics')">‚ú¶ AI Find Story</button>
    </div>

    <!-- DEEP DIVE -->
    <div class="panel" id="panel-deepdive">
      <div class="panel-header">
        <div class="panel-tag">Section 04 - Feature</div>
        <div class="panel-title">Deep Dive Feature</div>
        <div class="panel-desc">Your signature piece. Long-form analysis, a strong point of view, and the kind of insight that earns loyalty.</div>
        <button class="ai-find-btn" style="margin-top:12px;" onclick="openDeepDiveFinder()">‚ú¶ AI Find Deep Dive</button>
      </div>
      <div class="field-group">
        <div class="field-label">Feature Headline</div>
        <input class="field-input" id="deepTitle" oninput="updateCounts()" placeholder="e.g. The RBA Hike and the Hospitality Operator: Why This One Is Different"/>
      </div>
      <div class="field-group">
        <div class="field-label">Source Article URL <span class="field-hint">Direct link to the article this feature is based on</span></div>
        <input class="field-input" id="deepUrl" placeholder="https://exact-article-url.com/story" oninput="var p=this.nextElementSibling;p.href=this.value;p.style.display=this.value?'inline-block':'none'"/>
        <a href="" target="_blank" style="display:none;font-size:10px;color:#e91e8c;margin-top:4px;text-decoration:underline;">Test link ‚Üó</a>
      </div>
      <div class="field-group">
        <div class="field-label">Deck / Subheadline <span class="field-hint">One sentence that carries the weight</span></div>
        <input class="field-input" id="deepDeck" oninput="updateCounts()" placeholder="e.g. This is not just a borrowing cost story. It is a demand signal, a sentiment shift, and a margin squeeze arriving at the same time."/>
      </div>
      <div class="field-group">
        <div class="field-label">Feature Body <span class="field-hint">200‚Äì500 words. Analysis, context, your take.</span></div>
        <textarea class="field-textarea tall" id="deepBody" oninput="updateCounts()" placeholder="Write your feature here..."></textarea>
        <div class="format-hint">Formatting you can use in this field: &nbsp; <strong>[link text](url)</strong> creates a clickable hyperlink, e.g. <code>[Fair Work](https://fairwork.gov.au)</code> &nbsp;¬∑&nbsp; <strong>**bold text**</strong> wraps words in bold &nbsp;¬∑&nbsp; <strong>*italic text*</strong> wraps words in italic &nbsp;¬∑&nbsp; <strong>![description](image-url)</strong> inserts a centred image, e.g. <code>![Venue photo](https://example.com/photo.jpg)</code> &nbsp;¬∑&nbsp; Leave a blank line between paragraphs to separate them</div>
        <div class="field-wc" id="fwc-deepBody"></div>
      </div>
      <div class="field-group">
        <div class="field-label">Key Takeaway <span class="field-hint">One line. The reader should walk away with this.</span></div>
        <input class="field-input" id="deepTakeaway" oninput="updateCounts()" placeholder="e.g. The operators who survive this cycle will be those who repriced before the hike, not after it."/>
      </div>
      <div class="angle-box">
        <div class="angle-label">
          üéØ The Game Angle - Feature
          <button class="angle-suggest-btn" onclick="suggestAngle('deep')">‚ú¶ Suggest</button>
        </div>
        <div class="angle-hint">The behavioural or systems extrapolation this feature unlocks. This is your editorial signature.</div>
        <div class="angle-suggestion" id="angle-suggest-deep" onclick="useAngleSuggestion('deepGameAngle','angle-suggest-deep')"></div>
        <textarea class="field-textarea" id="deepGameAngle" oninput="updateCounts()" style="min-height:90px;" placeholder="e.g. The deeper pattern here is one of cognitive lag. Operators build mental models of their cost structure during calm periods and run those models long after the ground has shifted. The rate hike isn't the problem. The delayed repricing response is."></textarea>
      </div>
    </div>

    <!-- RESOURCES -->
    <div class="panel" id="panel-resources">
      <div class="panel-header">
        <div class="panel-tag">Section 05 - Resources</div>
        <div class="panel-title">Curated Resources</div>
        <div class="panel-desc">These resources are semi-permanent. Only swap or add when something genuinely significant appears. Three solid standing resources are worth more than a fresh list every week that half your readers ignore. Update the note below when you do change one.</div>
        <button class="ai-find-btn" style="margin-top:12px;" onclick="runAutoResources(this)">‚ú¶ AI Suggest Resources</button>
      </div>
      <div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-left:3px solid #fbbf24;border-radius:0 8px 8px 0;padding:12px 14px;margin-bottom:18px;">
        <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#fbbf24;font-weight:700;margin-bottom:6px;">Standing Resources</div>
        <div style="font-size:11px;color:rgba(138,154,181,0.85);line-height:1.6;">These carry over each week unless you remove or replace them. Only change when something genuinely significant arrives. Add a note below if you do update this section.</div>
      </div>
      <div class="news-items" id="resourceItems"></div>
      <div class="field-group" style="margin-top:14px;">
        <div class="field-label" style="color:#fbbf24;font-size:10px;">Update Note <span class="field-hint">Optional. Note here if you changed a resource this week and why.</span></div>
        <input class="field-input" id="resourceNote" oninput="updateCounts()" placeholder="e.g. Replaced the Fair Work guide with the updated July 2026 pay guide following the annual wage review." style="font-size:12px;"/>
      </div>
      <button class="add-item-btn" onclick="addResourceItem()">+ Add Resource</button>
    </div>

    <!-- SPOTLIGHT -->
    <div class="panel" id="panel-spotlight">
      <div class="panel-header">
        <div class="panel-tag">Section 06 - Community</div>
        <div class="panel-title">Community Spotlight</div>
        <div class="panel-desc">One venue, operator, or person doing something the industry should know about. Make them real.</div>
        <button class="ai-find-btn" style="margin-top:12px;" onclick="openSpotlightFinder()">‚ú¶ AI Find Spotlight</button>
      </div>
      <div class="field-group">
        <div class="field-label">Subject Name</div>
        <input class="field-input" id="spotlightName" oninput="updateCounts()" placeholder="e.g. Rosheen Kaul, Chef & Author"/>
      </div>
      <div class="field-group">
        <div class="field-label">Their Story <span class="field-hint">Why them, why now, what can the industry learn?</span></div>
        <textarea class="field-textarea" id="spotlightStory" oninput="updateCounts()" placeholder="Tell their story with authority..."></textarea>
        <div class="format-hint">Formatting you can use in this field: &nbsp; <strong>[link text](url)</strong> creates a clickable hyperlink, e.g. <code>[Fair Work](https://fairwork.gov.au)</code> &nbsp;¬∑&nbsp; <strong>**bold text**</strong> wraps words in bold &nbsp;¬∑&nbsp; <strong>*italic text*</strong> wraps words in italic &nbsp;¬∑&nbsp; <strong>![description](image-url)</strong> inserts a centred image, e.g. <code>![Venue photo](https://example.com/photo.jpg)</code> &nbsp;¬∑&nbsp; Leave a blank line between paragraphs to separate them</div>
        <div class="field-wc" id="fwc-spotlightStory"></div>
      </div>
      <div class="two-col">
        <div class="field-group">
          <div class="field-label">Location</div>
          <input class="field-input" id="spotlightLocation" oninput="updateCounts()" placeholder="e.g. Melbourne, VIC"/>
        </div>
        <div class="field-group">
          <div class="field-label">Category</div>
          <input class="field-input" id="spotlightCategory" oninput="updateCounts()" placeholder="e.g. Chef / Operator"/>
        </div>
      </div>
      <div class="field-group">
        <div class="field-label">Link <span class="field-hint">Website, article, or social profile for this subject</span></div>
        <input class="field-input" id="spotlightUrl" placeholder="https://venue-or-article-url.com" oninput="var p=this.nextElementSibling;p.href=this.value;p.style.display=this.value?'inline-block':'none'"/>
        <a href="" target="_blank" style="display:none;font-size:10px;color:#e91e8c;margin-top:4px;text-decoration:underline;">Test link ‚Üó</a>
      </div>
    </div>

  </div><!-- /editor-area -->

  <!-- PREVIEW -->
  <div class="preview-area" id="previewArea">
    <div style="max-width:660px;margin:0 auto 14px;display:flex;align-items:center;gap:10px;">
      <button onclick="setMode('edit')" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#f4a7b9;border-radius:8px;padding:8px 16px;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background 0.2s;">‚Üê Back to Editor</button>
      <span style="font-size:10px;color:rgba(138,154,181,0.5);letter-spacing:1px;text-transform:uppercase;">Preview Mode</span>
    </div>
    <div class="preview-frame" id="previewFrame"></div>
  </div>

  <!-- ARCHIVE -->
  <div class="archive-panel" id="archivePanel">
    <div class="panel-header">
      <div class="panel-tag">Issue Archive</div>
      <div class="panel-title">Saved Issues</div>
      <div class="panel-desc">Load, preview, or delete past issues. All data is stored locally in your browser.</div>
    </div>
    <div class="archive-grid" id="archiveGrid"></div>
  </div>

  <!-- SCAN ARCHIVE -->
  <div class="archive-panel" id="scanArchivePanel">
    <div class="panel-header">
      <div class="panel-tag">Scan Archive</div>
      <div class="panel-title">Past Scan Results</div>
      <div class="panel-desc">Every scan's 12-story shortlist, saved automatically. Click any story to pull it into the current issue.</div>
    </div>
    <div id="scanArchiveList"></div>
  </div>

</main>
</div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="exportModal">
  <div class="modal">
    <div class="modal-title">Export Newsletter HTML</div>
    <div class="modal-sub">Paste into Substack's HTML block or save as a .html file for your website.</div>
    <div class="code-block" id="exportCode"></div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-primary" onclick="copyHTML()">Copy to Clipboard</button>
      <button class="modal-btn modal-btn-secondary" onclick="downloadHTML()">Download .html</button>
      <button class="modal-btn modal-btn-secondary" onclick="closeModal('exportModal')">Close</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calDate = new Date();
let selectedDate = new Date();
let publishDates = []; // Wednesdays by default

function getPublishDates(year, month) {
  // Fridays = week-ending reference day
  const dates = [];
  const d = new Date(year, month, 1);
  while (d.getMonth() === month) {
    if (d.getDay() === 5) dates.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  return dates;
}

function nearestUpcomingFriday() {
  const today = new Date(); today.setHours(0,0,0,0);
  const day = today.getDay();
  const daysUntil = day <= 5 ? 5 - day : -1; // Mon-Fri ‚Üí this Fri; Sat ‚Üí yesterday (Fri); Sun included in <=5 ‚Üí +5
  const fri = new Date(today);
  fri.setDate(today.getDate() + daysUntil);
  return fri;
}

function classifyDate(friday) {
  const today = new Date(); today.setHours(0,0,0,0);
  const diffDays = Math.round((friday - today) / 86400000);
  if (diffDays >= 0 && diffDays <= 7) return 'current';
  if (diffDays > 7)                   return 'future';
  if (diffDays >= -56)                return 'historical';
  return 'retrospective';
}

function setDateMode(friday) {
  const mode = classifyDate(friday);
  const blip = document.getElementById('dateModeBlip');
  if (!blip) return mode;
  const map = {
    current:       ['badge-current',       'Live search ‚Äî current week'],
    future:        ['badge-future',        'Future date ‚Äî will search current week instead'],
    historical:    ['badge-historical',    'Historical ‚Äî verify all links carefully'],
    retrospective: ['badge-retrospective', 'Retrospective ‚Äî commentary mode, URLs unreliable']
  };
  const [cls, text] = map[mode];
  blip.innerHTML = '<span class="date-mode-badge ' + cls + '">' + text + '</span>';
  return mode;
}

function renderCalendar() {
  const y = calDate.getFullYear(), m = calDate.getMonth();
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonth').textContent = months[m] + ' ' + y;

  publishDates = getPublishDates(y, m);
  const first = new Date(y, m, 1).getDay();
  const days = new Date(y, m + 1, 0).getDate();
  const today = new Date(); today.setHours(0,0,0,0);

  const grid = document.getElementById('calGrid');
  // Header row ‚Äî highlight Friday column
  grid.innerHTML = ['M','T','W','T','F','S','S'].map(function(d, i) {
    return '<div class="cal-dow" style="' + (i === 4 ? 'color:#e91e8c;font-weight:700;' : '') + '">' + d + '</div>';
  }).join('');

  const offset = (first === 0 ? 6 : first - 1);
  for (let i = 0; i < offset; i++) grid.innerHTML += '<div class="cal-day empty"></div>';

  for (let day = 1; day <= days; day++) {
    const date = new Date(y, m, day); date.setHours(0,0,0,0);
    const isToday    = date.toDateString() === today.toDateString();
    const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
    const isFriday   = date.getDay() === 5;
    let cls = 'cal-day';
    if (isFriday)   cls += ' publish-day';
    if (isToday)    cls += ' today';
    if (isSelected) cls += ' selected';
    grid.innerHTML += '<div class="' + cls + '" onclick="selectDay(' + y + ',' + m + ',' + day + ')">' + day + '</div>';
  }

  updatePublishTrack();
}

function selectDay(y, m, d) {
  const clicked = new Date(y, m, d); clicked.setHours(0,0,0,0);
  // Snap to Friday of the clicked week (Mon=start of week)
  const dow = clicked.getDay(); // 0=Sun,1=Mon...5=Fri,6=Sat
  const daysToFri = dow === 5 ? 0 : dow === 6 ? -1 : dow === 0 ? -2 : (5 - dow);
  const friday = new Date(clicked);
  friday.setDate(clicked.getDate() + daysToFri);
  selectedDate = friday;
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('issueDate').value = friday.getDate() + ' ' + months[friday.getMonth()] + ' ' + friday.getFullYear();
  setDateMode(friday);
  renderCalendar();
  updateBadge();
}

function calNav(dir) {
  calDate.setMonth(calDate.getMonth() + dir);
  renderCalendar();
}

function updatePublishTrack() {
  const today = new Date(); today.setHours(0,0,0,0);
  const fri = nearestUpcomingFriday();
  const daysUntil = Math.round((fri - today) / 86400000);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('nextPublish').textContent = 'Week ending: ' + fri.getDate() + ' ' + months[fri.getMonth()];
  document.getElementById('countdown').textContent = daysUntil === 0 ? 'This Friday.' : daysUntil === 1 ? 'Tomorrow.' : daysUntil + ' days away';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANEL SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPanel(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  el.classList.add('active');
  setMode('edit');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(mode) {
  const editor = document.getElementById('editorArea');
  const preview = document.getElementById('previewArea');
  const archive = document.getElementById('archivePanel');
  const scanArchive = document.getElementById('scanArchivePanel');
  [editor, preview, archive, scanArchive].forEach(el => { el.style.display = 'none'; el.classList.remove('active'); });
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));

  if (mode === 'preview') {
    renderPreview(); preview.style.display = 'block'; preview.classList.add('active');
    document.getElementById('previewModeBtn').classList.add('active');
  } else if (mode === 'archive') {
    renderArchive(); archive.style.display = 'block'; archive.classList.add('active');
    document.getElementById('archiveModeBtn').classList.add('active');
  } else if (mode === 'scanArchive') {
    renderScanArchive(); scanArchive.style.display = 'block'; scanArchive.classList.add('active');
  } else {
    editor.style.display = 'block';
    document.getElementById('editModeBtn').classList.add('active');
  }
}

function showPreview() { setMode('preview'); }
function showArchive() { setMode('archive'); }
function showScanArchive() { setMode('scanArchive'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCAN ARCHIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveScanToArchive(stories, fridayLabel) {
  try {
    const archive = JSON.parse(localStorage.getItem('fgww_scans') || '[]');
    // Don't duplicate if same date already exists ‚Äî replace it
    const existing = archive.findIndex(function(s) { return s.weekEnding === fridayLabel; });
    const entry = {
      weekEnding: fridayLabel,
      scannedAt: new Date().toISOString(),
      stories: stories
    };
    if (existing >= 0) {
      archive[existing] = entry;
    } else {
      archive.unshift(entry);
    }
    // Keep last 52 weeks max
    if (archive.length > 52) archive.length = 52;
    localStorage.setItem('fgww_scans', JSON.stringify(archive));
  } catch(e) {
    // Silent fail ‚Äî scan archive is non-critical
  }
}

function renderScanArchive() {
  const archive = JSON.parse(localStorage.getItem('fgww_scans') || '[]');
  const container = document.getElementById('scanArchiveList');

  if (archive.length === 0) {
    container.innerHTML = '<div class="archive-empty" style="grid-column:1/-1;"><div class="archive-empty-icon">üîç</div><div>No scans saved yet. Run your first Build This Issue scan and it will appear here automatically.</div></div>';
    return;
  }

  container.innerHTML = archive.map(function(scan, scanIdx) {
    const scannedDate = new Date(scan.scannedAt).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    const industryCount = scan.stories.filter(function(s) { return s.section === 'Industry'; }).length;
    const econCount = scan.stories.length - industryCount;

    const storiesHTML = scan.stories.map(function(s, storyIdx) {
      const tagColor = s.section === 'Economics' ? '#1565c0' : '#880e4f';
      const tagBg = s.section === 'Economics' ? 'rgba(21,101,192,0.15)' : 'rgba(136,14,79,0.15)';
      const urlLink = s.url ? '<a href="' + encodeURI(s.url) + '" target="_blank" rel="noopener" style="color:#e91e8c;font-size:10px;text-decoration:none;">Source ‚Üó</a>' : '';
      return '<div class="scan-story">'
        + '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">'
        + '<div style="flex:1;min-width:0;">'
        + '<div style="font-size:13px;font-weight:600;color:#0f1f38;margin-bottom:3px;">' + escapeHtml(s.headline) + '</div>'
        + '<div style="font-size:10px;color:#888;margin-bottom:4px;">' + escapeHtml(s.source || '') + ' &nbsp;' + urlLink + '</div>'
        + '<div style="font-size:11px;color:#666;line-height:1.5;">' + escapeHtml(s.relevance || '') + '</div>'
        + '</div>'
        + '<div style="flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">'
        + '<span style="font-size:9px;padding:2px 8px;border-radius:4px;font-weight:600;background:' + tagBg + ';color:' + tagColor + ';">' + escapeHtml(s.section) + '</span>'
        + '<button onclick="pullScanStory(' + scanIdx + ',' + storyIdx + ')" style="font-size:9px;padding:3px 10px;border-radius:5px;border:1px solid #e91e8c;background:transparent;color:#e91e8c;cursor:pointer;font-family:\'DM Sans\',sans-serif;font-weight:600;white-space:nowrap;">+ Add to issue</button>'
        + '</div>'
        + '</div>'
        + '</div>';
    }).join('');

    return '<div class="scan-week">'
      + '<div class="scan-week-header" onclick="this.parentElement.classList.toggle(\'expanded\')">'
      + '<div>'
      + '<div style="font-size:14px;font-weight:700;color:#0f1f38;">Week ending ' + escapeHtml(scan.weekEnding) + '</div>'
      + '<div style="font-size:10px;color:#888;margin-top:2px;">Scanned ' + scannedDate + ' &nbsp;¬∑&nbsp; ' + scan.stories.length + ' stories (' + industryCount + ' industry, ' + econCount + ' economics)</div>'
      + '</div>'
      + '<span class="scan-expand-icon">‚ñ∏</span>'
      + '</div>'
      + '<div class="scan-week-stories">' + storiesHTML + '</div>'
      + '</div>';
  }).join('');
}

function pullScanStory(scanIdx, storyIdx) {
  const archive = JSON.parse(localStorage.getItem('fgww_scans') || '[]');
  if (!archive[scanIdx] || !archive[scanIdx].stories[storyIdx]) return;

  const s = archive[scanIdx].stories[storyIdx];
  const containerId = s.section === 'Economics' ? 'econItems' : 'newsItems';
  const type = s.section === 'Economics' ? 'Economics' : 'Industry';

  addNewsItem(containerId, type, {
    headline: s.headline || '',
    url: s.url || '',
    blurb: '',
    ref: s.source || '',
    angle: ''
  });

  updateCounts();
  hideEmptyState();
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';

  // Switch to editor on the relevant panel
  const panelId = s.section === 'Economics' ? 'econ' : 'news';
  setMode('edit');
  switchPanel(panelId, document.querySelector('[data-panel="' + panelId + '"]'));
  showToast('Story added: ' + (s.headline || '').substring(0, 50) + '...');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORD COUNT & READ TIME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function countWords(str) {
  return str.trim() === '' ? 0 : str.trim().split(/\s+/).length;
}

function updateFieldWC(fieldId, wcId) {
  const el = document.getElementById(fieldId);
  const wc = document.getElementById(wcId);
  if (el && wc) {
    const w = countWords(el.value);
    wc.textContent = `${w} word${w !== 1 ? 's' : ''}`;
  }
}

function updateCounts() {
  // Per-field
  updateFieldWC('introHook','fwc-introHook');
  updateFieldWC('introBody','fwc-introBody');
  updateFieldWC('deepBody','fwc-deepBody');
  updateFieldWC('spotlightStory','fwc-spotlightStory');

  // Per-section totals for sidebar
  const sections = {
    intro: ['introHook','introBody','introSignoff','introGameAngle'],
    news: [],
    econ: [],
    deepdive: ['deepTitle','deepDeck','deepBody','deepTakeaway','deepGameAngle'],
    resources: [],
    spotlight: ['spotlightName','spotlightStory','spotlightLocation','spotlightCategory']
  };

  // Add dynamic news/econ/resource items
  document.querySelectorAll('#newsItems textarea, #newsItems input').forEach(el => {
    sections.news.push(null); // handled inline
  });

  let total = 0;

  ['intro','deepdive','spotlight'].forEach(s => {
    const w = sections[s].reduce((acc, id) => {
      const el = document.getElementById(id);
      return acc + (el ? countWords(el.value) : 0);
    }, 0);
    const wcEl = document.getElementById('wc-' + s);
    if (wcEl) wcEl.textContent = w + 'w';
    total += w;

    // Mark filled
    const navItem = document.querySelector(`[data-panel="${s}"]`);
    if (navItem) navItem.classList.toggle('filled', w > 20);
  });

  // Dynamic panels
  ['news','econ','resources'].forEach(s => {
    const containerId = s === 'resources' ? 'resourceItems' : (s + 'Items');
    const container = document.getElementById(containerId);
    let w = 0;
    if (container) {
      container.querySelectorAll('input, textarea').forEach(el => w += countWords(el.value));
    }
    const wcEl = document.getElementById('wc-' + s);
    if (wcEl) wcEl.textContent = w + 'w';
    total += w;
    const navItem = document.querySelector(`[data-panel="${s}"]`);
    if (navItem) navItem.classList.toggle('filled', w > 20);
  });

  document.getElementById('totalWC').textContent = total;
  const mins = Math.max(1, Math.round(total / 200));
  document.getElementById('rtBadge').textContent = `~${mins} min read`;

  updateChecklist();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECKLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateChecklist() {
  // Check all news + econ stories have a game angle filled
  const allNewsAngles = [...document.querySelectorAll('#newsItems .news-angle')].every(el => el.value.trim().length > 10);
  const allEconAngles = [...document.querySelectorAll('#econItems .news-angle')].every(el => el.value.trim().length > 10);
  const newsCount = document.querySelectorAll('#newsItems .news-item').length;
  const econCount = document.querySelectorAll('#econItems .news-item').length;

  const checks = [
    { label: 'Issue number set', done: !!document.getElementById('issueNumber').value.trim(), panel: null },
    { label: 'Issue date set', done: !!document.getElementById('issueDate').value.trim(), panel: null },
    { label: 'Editorial intro written', done: countWords(document.getElementById('introBody').value) > 20, panel: 'intro' },
    { label: 'Issue-wide Game Angle written', done: countWords(document.getElementById('introGameAngle').value) > 20, panel: 'intro' },
    { label: 'News stories added (2+)', done: newsCount >= 2, panel: 'news' },
    { label: 'All news Game Angles written', done: newsCount > 0 && allNewsAngles, panel: 'news' },
    { label: 'Economic stories added', done: econCount >= 1, panel: 'econ' },
    { label: 'All economics Game Angles written', done: econCount > 0 && allEconAngles, panel: 'econ' },
    { label: 'Deep dive written', done: countWords(document.getElementById('deepBody').value) > 80, panel: 'deepdive' },
    { label: 'Deep Dive Game Angle written', done: countWords(document.getElementById('deepGameAngle').value) > 20, panel: 'deepdive' },
    { label: 'Resources curated', done: document.querySelectorAll('#resourceItems .news-item').length >= 1, panel: 'resources' },
    { label: 'Spotlight written', done: countWords(document.getElementById('spotlightStory').value) > 30, panel: 'spotlight' },
  ];

  const html = checks.map(c => `
    <div class="check-row ${c.done ? 'done' : ''}" ${c.panel ? 'onclick="switchPanel(\'' + c.panel + '\', document.querySelector(\'[data-panel=' + c.panel + ']\'))" style="cursor:pointer;"' : ''}>
      <span class="check-icon">${c.done ? '‚úÖ' : '‚≠ï'}</span>
      <span class="check-label">${c.label}</span>
    </div>
  `).join('');

  document.getElementById('checklist').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ISSUE BADGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBadge() {
  const num = document.getElementById('issueNumber').value;
  const date = document.getElementById('issueDate').value;
  const badge = document.getElementById('issueBadge');
  badge.textContent = [num ? `Issue ${num}` : '', date].filter(Boolean).join(' ¬∑ ') || 'New Issue';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME ANGLE SUGGESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const angleSuggestions = {
  intro: [
    "When the cost of capital rises, the cost of staying in the game rises with it, but operators do not feel it in the P&L until 6 to 12 months later. That lag is where decisions go wrong.",
    "The RBA hike is a systems event, not just a financial one. It changes the risk appetite of landlords, banks, suppliers, and diners simultaneously. That is why the response cannot be a single-lever fix.",
    "In a game where margin was already paper-thin, a rate hike does not add to the problem. It reveals it. The businesses feeling this most are the ones who were already playing without a buffer."
  ],
  deep: [
    "The deeper behavioural pattern here is one of cognitive lag. Operators build their mental model of costs during calm periods and run that model for far too long after conditions change. The data catches up before the operator does.",
    "This story is about the gap between the game operators think they're playing (hospitality) and the game they're actually in (leveraged small business in a high-cost regulatory environment). Until that gap closes, the industry will keep producing the wrong solutions.",
    "What looks like a cost problem is often a pricing psychology problem. Operators resist repricing not because of the maths but because of identity. They do not want to be the expensive one. That is a behavioural constraint, not a financial one."
  ]
};

function suggestAngle(section) {
  const suggestions = angleSuggestions[section];
  const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
  const el = document.getElementById('angle-suggest-' + section);
  el.textContent = 'üí° ' + suggestion;
  el.classList.add('visible');
}

function useAngleSuggestion(fieldId, suggestionId) {
  const text = document.getElementById(suggestionId).textContent.replace('üí° ', '');
  document.getElementById(fieldId).value = text;
  document.getElementById(suggestionId).classList.remove('visible');
  updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD NEWS / ECON ITEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addNewsItem(containerId, type, data) {
  const container = document.getElementById(containerId);
  const count = container.querySelectorAll('.news-item').length + 1;
  const d = data || {};
  const item = document.createElement('div');
  item.className = 'news-item';
  item.innerHTML = `
    <div class="news-item-header">
      <span class="news-item-num">${type} Story #${count}</span>
      <button class="remove-btn" onclick="this.closest('.news-item').remove();updateCounts()">Remove</button>
    </div>
    <div class="inner-field">
      <div class="inner-label">Headline</div>
      <input class="inner-input news-headline" oninput="updateCounts()" placeholder="Story headline..."/>
    </div>
    <div class="inner-field">
      <div class="inner-label">Commentary <span style="font-weight:400;color:var(--grey);font-size:9px;">3 paragraphs ¬∑ 120-150 words total</span></div>
      <textarea class="inner-textarea news-blurb" oninput="updateCounts()" style="min-height:140px;" placeholder="Paragraph 1: What happened and the key facts (2-3 sentences). Paragraph 2: Why it matters to operators (2-3 sentences). Paragraph 3: What to do or watch now (1-2 sentences)."></textarea>
      <div class="format-hint">Formatting you can use in this field: &nbsp; <strong>[link text](url)</strong> creates a clickable hyperlink, e.g. <code>[Fair Work](https://fairwork.gov.au)</code> &nbsp;¬∑&nbsp; <strong>**bold text**</strong> wraps words in bold &nbsp;¬∑&nbsp; <strong>*italic text*</strong> wraps words in italic &nbsp;¬∑&nbsp; <strong>![description](image-url)</strong> inserts a centred image, e.g. <code>![Venue photo](https://example.com/photo.jpg)</code> &nbsp;¬∑&nbsp; Leave a blank line between paragraphs to separate them</div>
    </div>
    <div class="inner-field">
      <div class="inner-label">Direct Link <span style="font-weight:400;color:var(--green);font-size:9px;">always link directly to the article</span></div>
      <input class="inner-input news-url" placeholder="https://exact-article-url.com/story" oninput="var p=this.nextElementSibling;p.href=this.value;p.style.display=this.value?'inline-block':'none'"/>
      <a href="" target="_blank" style="display:none;font-size:10px;color:#e91e8c;margin-top:4px;text-decoration:underline;">Test link ‚Üó</a>
    </div>
    <div class="inner-field">
      <div class="inner-label">Paywall Reference <span style="font-weight:400;color:var(--grey);font-size:9px;">if paywalled, name the publication so readers can find it</span></div>
      <input class="inner-input news-ref" placeholder="e.g. Australian Financial Review, paywalled. Search: [headline keywords]"/>
    </div>
    <div class="inner-field" style="margin-bottom:0;background:rgba(233,30,140,0.07);border-left:4px solid #e91e8c;border-radius:0 8px 8px 0;padding:12px 14px;">
      <div class="angle-inner-label" style="margin-bottom:6px;">üéØ The Game Angle <span style="font-size:9px;color:rgba(233,30,140,0.6);text-transform:none;letter-spacing:0;font-weight:400;">every story needs one</span></div>
      <textarea class="inner-angle news-angle" oninput="updateCounts()" style="min-height:80px;background:rgba(255,255,255,0.04);" placeholder="What is the behavioural or systems-level insight this story reveals? What rule of the game does it expose, confirm, or challenge? Write it even if it is brief."></textarea>
    </div>
  `;
  container.appendChild(item);
  // Set values programmatically AFTER innerHTML is parsed - prevents URL mangling
  if (d.headline) item.querySelector('.news-headline').value = d.headline;
  if (d.blurb)    item.querySelector('.news-blurb').value   = d.blurb;
  if (d.url) {
    const urlInput = item.querySelector('.news-url');
    urlInput.value = d.url;
    const testLink = urlInput.nextElementSibling;
    if (testLink && testLink.tagName === 'A') {
      testLink.href = d.url;
      testLink.style.display = 'inline-block';
    }
  }
  if (d.ref)      item.querySelector('.news-ref').value     = d.ref;
  if (d.angle)    item.querySelector('.news-angle').value   = d.angle;
  updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD RESOURCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addResourceItem(data) {
  const container = document.getElementById('resourceItems');
  const count = container.querySelectorAll('.news-item').length + 1;
  const d = data || {};
  const item = document.createElement('div');
  item.className = 'news-item';
  item.innerHTML = `
    <div class="news-item-header">
      <span class="news-item-num">Resource #${count}</span>
      <button class="remove-btn" onclick="this.closest('.news-item').remove();updateCounts()">Remove</button>
    </div>
    <div class="two-col" style="margin-bottom:10px">
      <div>
        <div class="inner-label">Title</div>
        <input class="inner-input res-title" oninput="updateCounts()" placeholder="Resource name..."/>
      </div>
      <div>
        <div class="inner-label">Icon / Emoji</div>
        <input class="inner-input res-icon" placeholder="üìä" style="font-size:16px;"/>
      </div>
    </div>
    <div class="inner-field">
      <div class="inner-label">Description</div>
      <textarea class="inner-textarea res-desc" oninput="updateCounts()" placeholder="Why it's useful and who should read it..."></textarea>
    </div>
    <div class="inner-field" style="margin-bottom:0">
      <div class="inner-label">Link <span style="font-weight:400;color:var(--grey);font-size:9px;">direct URL</span></div>
      <input class="inner-input res-url" placeholder="https://..."/>
    </div>
  `;
  container.appendChild(item);
  // Set values programmatically AFTER innerHTML - prevents URL mangling
  if (d.title) item.querySelector('.res-title').value = d.title;
  if (d.icon)  item.querySelector('.res-icon').value  = d.icon;
  if (d.desc)  item.querySelector('.res-desc').value  = d.desc;
  if (d.url)   item.querySelector('.res-url').value   = d.url;
  updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GATHER DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gatherData() {
  const newsItems = [], econItems = [], resources = [];
  document.querySelectorAll('#newsItems .news-item').forEach(item => {
    newsItems.push({ headline: item.querySelector('.news-headline')?.value||'', blurb: item.querySelector('.news-blurb')?.value||'', url: item.querySelector('.news-url')?.value||'', ref: item.querySelector('.news-ref')?.value||'', angle: item.querySelector('.news-angle')?.value||'' });
  });
  document.querySelectorAll('#econItems .news-item').forEach(item => {
    econItems.push({ headline: item.querySelector('.news-headline')?.value||'', blurb: item.querySelector('.news-blurb')?.value||'', url: item.querySelector('.news-url')?.value||'', ref: item.querySelector('.news-ref')?.value||'', angle: item.querySelector('.news-angle')?.value||'' });
  });
  document.querySelectorAll('#resourceItems .news-item').forEach(item => {
    resources.push({ icon: item.querySelector('.res-icon')?.value||'üìå', title: item.querySelector('.res-title')?.value||'', desc: item.querySelector('.res-desc')?.value||'', url: item.querySelector('.res-url')?.value||'' });
  });
  // Raw values - escaping happens in buildNewsletterHTML at render time
  const esc = function(s) { return s; }; // identity - kept for structure
  const escItems = function(arr) {
    return arr.map(function(item) {
      return {
        headline: esc(item.headline),
        blurb:    item.blurb,   // formatBlurb handles escaping per-paragraph
        url:      item.url,     // formatLink handles URL escaping
        ref:      item.ref,     // formatLink handles ref escaping
        angle:    item.angle    // formatAngle handles angle escaping
      };
    });
  };

  return {
    issueNumber: esc(document.getElementById('issueNumber').value),
    issueDate:   esc(document.getElementById('issueDate').value),
    tagline: (function() {
      var angle = document.getElementById('deepGameAngle').value.trim();
      if (!angle) angle = document.getElementById('deepTitle').value.trim();
      if (!angle) return '';
      var first = angle.split(/[.!?]/)[0].trim();
      var result = first.length > 10 ? first : angle;
      return esc(result.length > 90 ? result.substring(0, 87) + '...' : result);
    })(),
    introHook:      esc(document.getElementById('introHook').value),
    introBody:      document.getElementById('introBody').value,      // uses .replace(\n) in template
    introSignoff:   esc(document.getElementById('introSignoff').value),
    introGameAngle: document.getElementById('introGameAngle').value, // uses .replace(\n) in template
    newsItems: escItems(newsItems), econItems: escItems(econItems),
    deepTitle:    esc(document.getElementById('deepTitle').value),
    deepUrl:      document.getElementById('deepUrl').value,
    deepDeck:     esc(document.getElementById('deepDeck').value),
    deepBody:     document.getElementById('deepBody').value,         // uses .replace(\n) in template
    deepTakeaway: esc(document.getElementById('deepTakeaway').value),
    deepGameAngle: document.getElementById('deepGameAngle').value,   // uses .replace(\n) in template
    resources,
    resourceNote:      esc(document.getElementById('resourceNote')?.value||''),
    spotlightName:     esc(document.getElementById('spotlightName').value),
    spotlightStory:    document.getElementById('spotlightStory').value, // uses .replace(\n) in template
    spotlightUrl:      document.getElementById('spotlightUrl').value,
    spotlightLocation: esc(document.getElementById('spotlightLocation').value),
    spotlightCategory: esc(document.getElementById('spotlightCategory').value)
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD NEWSLETTER HTML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Lightweight inline markdown ‚Äî runs on ALREADY-ESCAPED text
// Supports: ![alt](image-url)  [link text](url)  **bold**  *italic*
function renderMarkdown(escaped) {
  if (!escaped) return '';
  return escaped
    // Images: ![alt](url) ‚Äî must run BEFORE links. Always centred.
    .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(m, alt, url) {
      var cleanUrl = url.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
      return '<div style="text-align:center;margin:16px 0;"><img src="' + cleanUrl + '" alt="' + alt + '" style="max-width:100%;height:auto;border-radius:6px;"/></div>';
    })
    // Links: [text](url) ‚Äî URL was escaped, so &amp; etc need reverting inside href
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(m, text, url) {
      // Unescape the URL for the href attribute (it was escaped by escapeHtml)
      var cleanUrl = url.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
      return '<a href="' + cleanUrl + '" target="_blank" rel="noopener" style="color:#e91e8c;font-weight:600;text-decoration:underline;">' + text + '</a>';
    })
    // Bold: **text**
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    // Italic: *text*
    .replace(/\*([^*]+)\*/g, '<em>$1</em>');
}

function formatBlurb(text) {
  if (!text) return '';
  return text.split('\n\n').map(function(p) {
    return '<div style="font-size:13px;color:#555;line-height:1.65;margin-top:10px;">' + renderMarkdown(escapeHtml(p.trim())) + '</div>';
  }).join('');
}

function formatLink(url, ref) {
  if (url) {
    return '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener" style="font-size:11px;color:#e91e8c;text-decoration:none;display:inline-block;margin-top:10px;font-weight:600;">Read the full story ‚Üí</a>';
  }
  if (ref) {
    return '<div style="font-size:11px;color:#888;margin-top:8px;font-style:italic;">üì∞ ' + escapeHtml(ref) + '</div>';
  }
  return '';
}

function formatAngle(angle, exportMode) {
  if (exportMode && !angle) return '';
  var text = angle
    ? '<div style="font-size:13px;color:#1a1a2e;font-style:italic;line-height:1.7;">' + renderMarkdown(escapeHtml(angle)) + '</div>'
    : '<div style="font-size:12px;color:#bbb;font-style:italic;">Game Angle not yet written for this story.</div>';
  return '<div style="margin-top:12px;background:rgba(233,30,140,0.06);border-left:3px solid #e91e8c;padding:12px 14px;border-radius:0 8px 8px 0;"><span style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#e91e8c;font-weight:700;display:block;margin-bottom:6px;">üéØ The Game Angle</span>' + text + '</div>';
}

function buildNewsletterHTML(d, exportMode = false) {
  const byline = `A behavioural, systems-led explanation of why Australian hospitality feels harder than it should, because the rules of the game have changed and we are here to help master them.`;

  // Background colour rotation: anchored to Issue 8 = Dusty Rose
  const issueBgColours = { 1: '#d9cfc5', 2: '#e1c8d0', 0: '#cdc8d9' }; // warm sand, dusty rose, soft slate
  const issueNum = parseInt(d.issueNumber) || 0;
  const issueBg = issueBgColours[issueNum % 3] || '#cdc8d9';

  const newsHTML = d.newsItems.map(function(item, i) {
    return '<table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid #f5ecf8;"><tr>'
      + '<td style="width:38px;vertical-align:top;padding-right:12px;"><div style="width:26px;height:26px;background:#fce4ec;color:#e91e8c;border-radius:50%;text-align:center;line-height:26px;font-size:11px;font-weight:700;">' + (i+1) + '</div></td>'
      + '<td style="vertical-align:top;">'
      + '<div style="font-weight:600;font-size:14px;color:#0f1f38;margin-bottom:4px;">' + escapeHtml(item.headline||'Story headline') + '</div>'
      + formatBlurb(item.blurb)
      + formatLink(item.url, item.ref)
      + formatAngle(item.angle, exportMode)
      + '</td></tr></table>';
  }).join('');

  const econHTML = d.econItems.map(function(item, i) {
    return '<table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid #f5ecf8;"><tr>'
      + '<td style="width:38px;vertical-align:top;padding-right:12px;"><div style="width:26px;height:26px;background:#e8f0fe;color:#1565c0;border-radius:50%;text-align:center;line-height:26px;font-size:11px;font-weight:700;">' + (i+1) + '</div></td>'
      + '<td style="vertical-align:top;">'
      + '<div style="font-weight:600;font-size:14px;color:#0f1f38;margin-bottom:4px;">' + escapeHtml(item.headline||'Economic story') + '</div>'
      + formatBlurb(item.blurb)
      + formatLink(item.url, item.ref)
      + formatAngle(item.angle, exportMode)
      + '</td></tr></table>';
  }).join('');

  const resourcesHTML = d.resources.map(function(r) {
    var link = r.url ? ' <a href="' + escapeHtml(r.url) + '" target="_blank" rel="noopener" style="color:#e91e8c;font-weight:600;">Visit ‚Üí</a>' : '';
    return '<table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-bottom:10px;"><tr><td style="background:#fce4ec;border-radius:10px;border-left:3px solid #f4a7b9;padding:14px;">'
      + '<table cellpadding="0" cellspacing="0" border="0" width="100%"><tr>'
      + '<td style="width:32px;vertical-align:top;font-size:20px;">' + (r.icon||'üìå') + '</td>'
      + '<td style="vertical-align:top;">'
      + '<div style="font-weight:600;font-size:13px;color:#0f1f38;margin-bottom:3px;">' + escapeHtml(r.title||'Resource') + '</div>'
      + '<div style="font-size:12px;color:#555;line-height:1.5;">' + renderMarkdown(escapeHtml(r.desc||'')) + link + '</div>'
      + '</td></tr></table>'
      + '</td></tr></table>';
  }).join('');

  const angleStyle = `margin-top:20px;background:linear-gradient(135deg,rgba(233,30,140,0.07),rgba(244,167,185,0.04));border-left:4px solid #e91e8c;border-radius:0 10px 10px 0;padding:18px;`;
  const angleLabel = `<div style="font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#e91e8c;font-weight:700;margin-bottom:8px;">üéØ The Game Angle</div>`;

  return `
<div style="font-family:'DM Sans',Arial,sans-serif;color:#1a1a2e;max-width:660px;margin:0 auto;">

  <div style="background:#0f1f38;padding:34px 40px 28px;text-align:center;border-radius:12px 12px 0 0;">
    <div style="font-size:9px;letter-spacing:4px;text-transform:uppercase;color:#f4a7b9;margin-bottom:10px;">
      ${d.issueNumber?`Issue ${escapeHtml(d.issueNumber)}`:''} ${d.issueDate?'¬∑ '+d.issueDate:''} ¬∑ Australia's Hospitality Intelligence
    </div>
    <div style="font-family:Georgia,serif;font-size:36px;font-weight:900;color:#fff;line-height:1;">
      Food Game <span style="color:#f4a7b9;">Weekly Wrap</span>
    </div>
    ${d.tagline?`<div style="font-size:13px;color:rgba(255,255,255,0.5);margin-top:10px;font-style:italic;">${escapeHtml(d.tagline)}</div>`:''}
    <div style="margin-top:18px;padding-top:18px;border-top:1px solid rgba(244,167,185,0.2);font-size:11px;color:rgba(255,255,255,0.5);line-height:1.7;font-style:italic;max-width:460px;margin-left:auto;margin-right:auto;">${byline}</div>
  </div>

  <div style="background:${issueBg};padding:0 40px 40px;">

    <div style="padding:26px 0;border-bottom:1px solid #f0e8f4;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Editorial</div>
      ${d.introHook?`<p style="font-size:17px;font-weight:600;color:#0f1f38;margin:0 0 12px;line-height:1.45;">${escapeHtml(d.introHook)}</p>`:''}
      ${d.introBody?`<div style="font-size:14px;line-height:1.8;color:#333;margin:0 0 14px;">${renderMarkdown(escapeHtml(d.introBody)).split(/\n\n+/).map(p => '<p style="margin:0 0 12px;">' + p.replace(/\n/g,'<br>') + '</p>').join('')}</div>`:''}
      ${d.introSignoff?`<p style="font-size:13px;color:#888;margin:0;">‚Äî ${escapeHtml(d.introSignoff)}</p>`:''}
      ${d.introGameAngle?`<div style="${angleStyle}">${angleLabel}<div style="font-size:13px;line-height:1.75;color:#1a1a2e;font-style:italic;">${renderMarkdown(escapeHtml(d.introGameAngle)).split(/\n\n+/).map(p => '<p style="margin:0 0 10px;">' + p.replace(/\n/g,'<br>') + '</p>').join('')}</div></div>`:''}
    </div>

    ${d.newsItems.length>0?`
    <div style="padding:26px 0;border-bottom:1px solid #f0e8f4;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Industry News</div>
      <div style="font-family:Georgia,serif;font-size:20px;color:#0f1f38;margin-bottom:16px;">This Week's Top Stories</div>
      ${newsHTML}
    </div>`:''}

    ${d.econItems.length>0?`
    <div style="padding:26px 0;border-bottom:1px solid #f0e8f4;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#0f1f38;background:#f4a7b9;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Economics</div>
      <div style="font-family:Georgia,serif;font-size:20px;color:#0f1f38;margin-bottom:16px;">Economic Pulse</div>
      ${econHTML}
    </div>`:''}

    ${d.deepTitle?`
    <div style="padding:26px 0;border-bottom:1px solid #f0e8f4;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Deep Dive</div>
      <div style="font-size:11px;color:#e91e8c;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Feature Article</div>
      <div style="font-family:Georgia,serif;font-size:26px;font-weight:700;color:#0f1f38;line-height:1.2;margin-bottom:8px;">${escapeHtml(d.deepTitle)}</div>
      ${d.deepDeck?`<p style="font-size:14px;color:#555;font-style:italic;border-left:3px solid #f4a7b9;padding-left:14px;margin:0 0 16px;line-height:1.65;">${escapeHtml(d.deepDeck)}</p>`:''}
      ${d.deepBody?`<div style="font-size:14px;line-height:1.85;color:#333;">${renderMarkdown(escapeHtml(d.deepBody)).split(/\n\n+/).map(p => '<p style="margin:0 0 16px;">' + p.replace(/\n/g,'<br>') + '</p>').join('')}</div>`:''}
      ${d.deepUrl?`<a href="${escapeHtml(d.deepUrl)}" target="_blank" rel="noopener" style="font-size:11px;color:#e91e8c;text-decoration:none;display:inline-block;margin-top:10px;font-weight:600;">Read the full story ‚Üí</a>`:''}
      ${d.deepTakeaway?`<div style="margin-top:18px;background:#fce4ec;border-left:4px solid #e91e8c;padding:14px 16px;border-radius:0 8px 8px 0;font-size:14px;font-weight:600;color:#0f1f38;">üí° Key Takeaway: ${escapeHtml(d.deepTakeaway)}</div>`:''}
      ${d.deepGameAngle?`<div style="${angleStyle}">${angleLabel}<div style="font-size:13px;line-height:1.75;color:#1a1a2e;font-style:italic;">${renderMarkdown(escapeHtml(d.deepGameAngle)).split(/\n\n+/).map(p => '<p style="margin:0 0 10px;">' + p.replace(/\n/g,'<br>') + '</p>').join('')}</div></div>`:''}
    </div>`:''}

    ${d.resources.length>0?`
    <div style="padding:26px 0;border-bottom:1px solid #f0e8f4;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Resources</div>
      <div style="font-family:Georgia,serif;font-size:20px;color:#0f1f38;margin-bottom:8px;">Worth Bookmarking</div>
      ${d.resourceNote?`<p style="font-size:12px;color:#888;font-style:italic;margin-bottom:16px;">This week: ${escapeHtml(d.resourceNote)}</p>`:'<p style="font-size:12px;color:#aaa;font-style:italic;margin-bottom:16px;">Standing resources. Updated only when something significant arrives.</p>'}
      ${resourcesHTML}
    </div>`:''}

    ${d.spotlightName?`
    <div style="padding:26px 0;">
      <div style="display:inline-block;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:14px;">Community</div>
      <div style="background:linear-gradient(135deg,#0f1f38,#1a2f52);border-radius:12px;padding:24px;color:#fff;">
        <div style="font-size:9px;letter-spacing:3px;color:#f4a7b9;text-transform:uppercase;margin-bottom:8px;">Community Spotlight</div>
        <div style="font-family:Georgia,serif;font-size:20px;color:#fff;margin-bottom:4px;">${escapeHtml(d.spotlightName)}</div>
        ${d.spotlightCategory||d.spotlightLocation?`<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:14px;">${[d.spotlightCategory,d.spotlightLocation].filter(Boolean).join(' ¬∑ ')}</div>`:''}
        ${d.spotlightStory?`<div style="font-size:13px;line-height:1.75;color:rgba(255,255,255,0.78);">${renderMarkdown(escapeHtml(d.spotlightStory)).split(/\n\n+/).map(p => '<p style="margin:0 0 12px;">' + p.replace(/\n/g,'<br>') + '</p>').join('')}</div>`:''}
        ${d.spotlightUrl?`<a href="${escapeHtml(d.spotlightUrl)}" target="_blank" rel="noopener" style="font-size:11px;color:#f4a7b9;text-decoration:none;display:inline-block;margin-top:10px;font-weight:600;">Visit ‚Üí</a>`:''}
      </div>
    </div>`:''}

  </div>

  <div style="padding:28px 40px;border-top:1px solid #f0e8f4;">
    <div style="font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#e91e8c;font-weight:700;margin-bottom:16px;text-align:center;">About the Author</div>
    <table cellpadding="0" cellspacing="0" border="0" width="100%"><tr>
      <td style="width:122px;vertical-align:top;padding-right:22px;">
        <img src="${AUTHOR_PHOTO}" alt="Julian Blok" style="width:100px;height:100px;border-radius:50%;border:3px solid #f4a7b9;"/>
      </td>
      <td style="vertical-align:top;">
        <div style="font-family:Georgia,serif;font-size:16px;color:#0f1f38;font-weight:700;margin-bottom:8px;">Julian Blok</div>
        <div style="font-size:12px;color:#555;line-height:1.75;margin-bottom:10px;">Julian spent 16 years in banking, including Goldman Sachs, before stepping into hospitality in 2014 as the operator of a supplies business serving venues from single-site cafes to national chains. That role gave him something most commentators never get: a supplier's lens. Suppliers do not just see invoices. They see what breaks first, what gets ordered in a panic, and which problems keep showing up in different venues wearing different disguises. Over a decade he watched the same failure patterns repeat across thousands of businesses and started treating them as data, not bad luck.</div>
        <div style="font-size:12px;color:#555;line-height:1.75;">Today Julian works as an industry consultant helping hospitality operators use behavioural insight and systems-led change, digital and procedural, to build businesses that grow profit, not just revenue. That practitioner's lens is the foundation for <em>The Food Game</em>, his forthcoming book, and for this newsletter: a weekly attempt to name the patterns, question the defaults, and help the people doing the hard work see the game a little more clearly.</div>
      </td>
    </tr></table>
  </div>

  <div style="background:#0f1f38;padding:26px 40px;text-align:center;border-radius:0 0 12px 12px;">
    <div style="font-family:Georgia,serif;font-size:17px;color:#fff;margin-bottom:5px;">Food Game <span style="color:#f4a7b9;">Weekly Wrap</span></div>
    <div style="font-size:11px;color:rgba(255,255,255,0.4);line-height:1.6;">Australia's Hospitality Intelligence ¬∑ Published weekly</div>
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(244,167,185,0.15);">
      <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:8px;font-weight:600;">What is your read this week?</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.45);line-height:1.6;">Hit reply or <a href="{{post_url}}" target="_blank" rel="noopener" style="color:#f4a7b9;text-decoration:underline;">join the conversation in the comments</a>.</div>
    </div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(244,167,185,0.12);font-size:10px;color:rgba(255,255,255,0.2);">
      ¬© ${new Date().getFullYear()} Food Game Weekly Wrap ¬∑ {{unsubscribe_url}}
    </div>
  </div>

</div>
<!-- FGWW_ISSUE_DATA:${btoa(unescape(encodeURIComponent(JSON.stringify(d))))}:END_FGWW -->`.trim();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPreview() {
  var d = gatherData();
  // Diagnostic: log deep dive state
  console.log('[PREVIEW DEBUG] deepTitle:', JSON.stringify(d.deepTitle));
  console.log('[PREVIEW DEBUG] deepBody length:', (d.deepBody||'').length);
  console.log('[PREVIEW DEBUG] deepUrl:', JSON.stringify(d.deepUrl));
  console.log('[PREVIEW DEBUG] deepDeck:', JSON.stringify(d.deepDeck));
  console.log('[PREVIEW DEBUG] deepTakeaway:', JSON.stringify(d.deepTakeaway));
  console.log('[PREVIEW DEBUG] deepGameAngle length:', (d.deepGameAngle||'').length);
  if (!d.deepTitle) console.warn('[PREVIEW DEBUG] ‚ö†Ô∏è Deep Dive title is EMPTY ‚Äî section will not render');
  document.getElementById('previewFrame').innerHTML = buildNewsletterHTML(d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARCHIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveToArchive() {
  const d = gatherData();
  if (!d.issueNumber && !d.issueDate) { showToast('‚ö†Ô∏è Set an issue number or date first'); return; }
  const key = 'fgww_issue_' + Date.now();
  const archive = JSON.parse(localStorage.getItem('fgww_archive') || '[]');
  archive.unshift({ key, saved: new Date().toISOString(), data: d });
  localStorage.setItem('fgww_archive', JSON.stringify(archive));
  showToast('‚úÖ Issue saved to archive');
}

function renderArchive() {
  const archive = JSON.parse(localStorage.getItem('fgww_archive') || '[]');
  const grid = document.getElementById('archiveGrid');
  if (archive.length === 0) {
    grid.innerHTML = `<div class="archive-empty" style="grid-column:1/-1;"><div class="archive-empty-icon">üì≠</div><div>No saved issues yet. Save your first issue using the button in the sidebar.</div></div>`;
    return;
  }
  grid.innerHTML = archive.map((entry, idx) => {
    const d = entry.data;
    const title = d.deepTitle || d.introHook || 'Untitled Issue';
    const saved = new Date(entry.saved).toLocaleDateString('en-AU', {day:'numeric',month:'short',year:'numeric'});
    return `
      <div class="archive-card">
        <div class="archive-card-num">${d.issueNumber ? 'Issue ' + d.issueNumber : 'Draft'} ¬∑ ${d.issueDate || saved}</div>
        <div class="archive-card-title">${title.substring(0,60)}${title.length>60?'...':''}</div>
        <div class="archive-card-date">Saved ${saved}</div>
        <div class="archive-card-actions">
          <button class="archive-action" onclick="loadIssue(${idx})">Load</button>
          <button class="archive-action" onclick="previewArchiveIssue(${idx})">Preview</button>
          <button class="archive-action del" onclick="deleteIssue(${idx})">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

function loadIssue(idx) {
  const archive = JSON.parse(localStorage.getItem('fgww_archive') || '[]');
  const d = archive[idx].data;
  populateForm(d);
  hideEmptyState();
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  setMode('edit');
  showToast('üìÇ Issue loaded into editor.');
}

function previewArchiveIssue(idx) {
  const archive = JSON.parse(localStorage.getItem('fgww_archive') || '[]');
  populateForm(archive[idx].data);
  hideEmptyState();
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  setMode('preview');
  showToast('Issue loaded. Switch to Edit mode to make changes.');
}

function deleteIssue(idx) {
  if (!confirm('Delete this saved issue? This cannot be undone.')) return;
  const archive = JSON.parse(localStorage.getItem('fgww_archive') || '[]');
  archive.splice(idx, 1);
  localStorage.setItem('fgww_archive', JSON.stringify(archive));
  renderArchive();
  showToast('üóëÔ∏è Issue deleted');
}

function populateForm(d) {
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
  set('issueNumber', d.issueNumber); set('issueDate', d.issueDate);
  set('introHook', d.introHook); set('introBody', d.introBody); set('introSignoff', d.introSignoff); set('introGameAngle', d.introGameAngle);
  set('deepTitle', d.deepTitle); set('deepDeck', d.deepDeck); set('deepBody', d.deepBody); set('deepTakeaway', d.deepTakeaway); set('deepGameAngle', d.deepGameAngle); set('deepUrl', d.deepUrl);
  set('resourceNote', d.resourceNote);
  set('spotlightName', d.spotlightName); set('spotlightStory', d.spotlightStory); set('spotlightLocation', d.spotlightLocation); set('spotlightCategory', d.spotlightCategory); set('spotlightUrl', d.spotlightUrl);

  document.getElementById('newsItems').innerHTML = '';
  (d.newsItems || []).forEach(item => addNewsItem('newsItems', 'Industry', item));
  document.getElementById('econItems').innerHTML = '';
  (d.econItems || []).forEach(item => addNewsItem('econItems', 'Economics', item));
  document.getElementById('resourceItems').innerHTML = '';
  (d.resources || []).forEach(item => addResourceItem(item));

  updateBadge(); updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportHTML() {
  document.getElementById('exportCode').textContent = buildNewsletterHTML(gatherData(), true);
  document.getElementById('exportModal').classList.add('active');
}

function handleIssueUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const html = e.target.result;
      // Look for embedded issue data
      const match = html.match(/FGWW_ISSUE_DATA:([\s\S]*?):END_FGWW/);
      if (!match) {
        showToast('‚ö†Ô∏è No FGWW issue data found in this file. Only files exported from this editor can be imported.');
        return;
      }
      const d = JSON.parse(decodeURIComponent(escape(atob(match[1]))));
      if (!d.issueNumber && !d.introHook && !d.deepTitle) {
        showToast('‚ö†Ô∏è File does not contain valid issue data');
        return;
      }
      populateForm(d);
      hideEmptyState();
      document.getElementById('previewModeBtn').style.display = '';
      document.getElementById('archiveModeBtn').style.display = '';
      setMode('edit');
      showToast('üìÇ Issue imported from ' + file.name);
    } catch(err) {
      showToast('‚ö†Ô∏è Could not read file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function copyHTML() {
  navigator.clipboard.writeText(document.getElementById('exportCode').textContent).then(() => {
    showToast('‚úÖ Copied to clipboard');
    closeModal('exportModal');
  });
}

function downloadHTML() {
  const d = gatherData();
  const fn = `food-game-wrap${d.issueNumber?'-'+d.issueNumber:''}.html`;
  const full = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Food Game Weekly Wrap${d.issueNumber?' #'+d.issueNumber:''}</title><link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"></head><body style="margin:0;padding:40px 16px;background:#f0f0f0;">${buildNewsletterHTML(d, true)}</body></html>`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([full],{type:'text/html'}));
  a.download = fn; a.click();
  showToast('üì• Downloading HTML file');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetAll() {
  if (!confirm('Clear all content and start a new issue?')) return;
  // Clear all text fields
  document.querySelectorAll('.field-input,.field-textarea').forEach(el => el.value = '');
  // Clear dynamic item containers
  ['newsItems','econItems','resourceItems'].forEach(id => document.getElementById(id).innerHTML = '');
  // Reset date to nearest upcoming Friday
  selectedDate = nearestUpcomingFriday();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('issueDate').value = selectedDate.getDate() + ' ' + months[selectedDate.getMonth()] + ' ' + selectedDate.getFullYear();
  document.getElementById('issueNumber').value = '';
  setDateMode(selectedDate);
  renderCalendar();
  // Reset AI build state
  buildMasterList = [];
  buildSelected = {};
  buildWritten = [];
  communityList = [];
  communitySelected = null;
  _staged = {};
  // Show empty state since all content is cleared
  showEmptyState();
  document.getElementById('previewModeBtn').style.display = 'none';
  document.getElementById('archiveModeBtn').style.display = 'none';
  setMode('edit');
  updateBadge(); updateCounts();
  showToast('Cleared. Ready for a new issue.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRE-FILL: ISSUE 001 - WEEK OF 18 FEB 2026
// Real Australian news. Draft copy in JCS voice.
// All content is clearly a draft - edit and refine.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadDemoIssue() {
  document.getElementById('issueNumber').value = '001';
  document.getElementById('issueDate').value = '18 Feb 2026';
  // tagline is auto-generated from deep dive game angle

  document.getElementById('introHook').value = "The RBA pulled the trigger on Tuesday. First rate hike since 2023. Twenty-five basis points to 3.85%. And if you are running a hospitality business, you felt it before the announcement landed.";

  document.getElementById('introBody').value = "This week's issue lands in the middle of a moment that will define 2026 for Australian operators, workers, and investors. The rate hike is not just a borrowing story. It is a demand story, a sentiment story, and a margin story, all arriving in the same week. We are running the numbers, the implications, and the strategic read so you do not have to piece it together yourself.\n\nDining frequency is already down 12 percent from pre-2020 levels. Spend per head is up. The consumer has not disappeared. They have become deliberate. That is a different game. This issue is about what that game actually requires of the people playing it.\n\nWe open with the industry headlines, move through the economic pulse, and go deep on what this rate environment actually means for operators making real decisions right now. The Game Angle this week is consistent across almost every story we reviewed. Stay with us.";

  document.getElementById('introSignoff').value = 'JB';

  document.getElementById('introGameAngle').value = "The behavioural pattern inside this week's news is consistent across every story: operators are making decisions based on a cost model that was accurate eighteen months ago. The hike does not create a new problem. It reveals the lag between economic conditions and the mental models used to manage them. The businesses that are built for 2026 are the ones that updated their model before the data made it unavoidable.";

  // Industry news - expanded 2-3 paragraph commentary
  document.getElementById('newsItems').innerHTML = '';
  
  addNewsItem('newsItems', 'Industry', {
    headline: "Australian Dining Frequency Falls 12% From Pre-2020 Baseline as Spend Per Head Climbs",
    blurb: "Industry data now confirms what most operators have felt for twelve months. Australians are dining out less, but spending more when they do. Spend per head is up 8 to 15 percent depending on venue type. Walk-ins are declining. Advance bookings are growing. The occasional diner has become the intentional diner.\n\nThis matters because the volume model that underpinned so many hospitality businesses through the 2010s no longer holds. If your revenue forecast assumes a steady flow of casual trade, you are planning for a market that is shifting beneath you. The deliberate-occasion diner has higher expectations, lower tolerance for inconsistency, and more alternatives to choose from.\n\nThe operators who are adapting are tightening their menus, investing in the experience rather than the throughput, and communicating their offer with far more precision than before. The ones who are struggling are still waiting for the walk-in traffic to return. It is not coming back the way it was.",
    url: "",
    angle: "This is the hospitality version of the premiumisation trap. Operators who try to serve all occasions end up serving none of them well. The game now rewards clarity of offer over breadth of capacity."
  });

  addNewsItem('newsItems', 'Industry', {
    headline: "Executive Talent War Intensifies as 28% of Luxury Hotels Enter GM Succession Planning",
    blurb: "New research from the executive search firm People and Culture Leaders confirms that nearly a third of Australian luxury hotels, those with average daily rates above $800 per night, are actively engaged in some stage of general manager succession planning or transition for the 2026 operational year. This is not a routine turnover cycle. It is a structural shift in how the upper tier of the industry sources and retains leadership capability.\n\nThe drivers are multiple. Post-pandemic operational complexity has accelerated the retirement of a generation of experienced GMs. The expectation profile of the role has expanded significantly, with sustainability obligations, cultural authenticity requirements, and revenue complexity all demanding a different kind of leader than the industry produced ten years ago.\n\nFor operators outside the luxury tier, this creates a secondary effect: the talent pipeline that would normally feed mid-market properties is being absorbed upward. The war for hospitality leadership is not confined to the top end. It is felt all the way down the scale.",
    url: "",
    angle: "The executive talent story is a systems story. When the top tier of any industry absorbs the available leadership supply, it creates a scarcity that cascades downward. Mid-market operators who have been waiting for good managers to become available may be waiting longer than they planned."
  });

  addNewsItem('newsItems', 'Industry', {
    headline: "Hotel Sector Posts Record RevPAR on British and Irish Lions Tour Demand, Eyes 2027 Rugby World Cup",
    blurb: "The British and Irish Lions Tour delivered record revenue per available room across Australian capital cities in 2025, and the confirmed data is now in. Industry analysts at Acure Asset Management describe the result as the clearest evidence yet that event-driven demand remains the most powerful short-term lever available to the accommodation sector.\n\nThe forward-looking implication is significant. Preparations for the 2027 Rugby World Cup are already shaping investment and pricing strategies across the sector. Properties in Brisbane, Sydney, and Melbourne are the primary beneficiaries, but the effect is being felt in secondary markets through ancillary tourism.\n\nFor operators in event-adjacent markets, the question is not whether to prepare but how early. The venues that captured the Lions upside were the ones that repriced and repositioned twelve months in advance, not six weeks out.",
    url: "",
    angle: "Event-driven demand is the most predictable revenue uplift the accommodation sector has. The operators who capture it are the ones who start preparing when the event is announced, not when the bookings open. Twelve months of lead time is a competitive advantage. Six weeks is a scramble."
  });

  addNewsItem('newsItems', 'Industry', {
    headline: "Zero Alcohol Revenue Grows as Younger Australians Reshape the Drinks Category",
    blurb: "The data on Australian drinking behaviour has been trending in one direction for over a decade, and 2026 is accelerating it. The share of 18 to 24 year olds consuming wine monthly has halved since 2010, according to market analyst IWSR. Non-alcoholic options, protein-focused beverages, and low-ABV formats are filling the space. This is no longer a niche preference. It is a mainstream shift in how a growing segment of the population engages with hospitality.\n\nOperators who treat the no-and-low category as an afterthought are leaving margin on the table and signalling to a growing segment that they have not updated their offer. The venues that are getting this right are not just stocking one or two token alternatives. They are building considered non-alcoholic programs with the same intentionality they apply to their wine list.\n\nThe economics support the investment. Non-alcoholic products carry comparable or better margin to their alcohol equivalents in many categories, and the customer who feels genuinely catered to in this space tends to book again.",
    url: "",
    angle: "The shift away from alcohol is not just a health trend. It is a values signal. The venues treating it as a revenue opportunity rather than a compliance concession are building the loyalty of the next decade's core diner."
  });

  // Economics - expanded 2-3 paragraph commentary
  document.getElementById('econItems').innerHTML = '';

  addNewsItem('econItems', 'Economics', {
    headline: "RBA Hikes Cash Rate to 3.85%, First Increase Since November 2023",
    blurb: "The Reserve Bank raised the official cash rate by 25 basis points to 3.85% on 3 February, in a unanimous decision that reversed the easing cycle of 2025. The Board cited a material pick-up in inflation in the second half of last year, stronger-than-expected private demand, and a labour market it described as a little tight. Governor Michele Bullock confirmed the Board stands ready to act again if inflation does not moderate. Markets are pricing a second hike as early as May.\n\nFor hospitality operators, the mechanism matters as much as the number. The hike increases the cost of the equipment finance, leasehold improvement loans, and working capital facilities that many venues carried into 2026 assuming rates were done rising. It also increases the mortgage burden on the operators who leveraged property to fund fitouts or acquisitions during the 2024 easing window. Those decisions now cost more than they did six months ago.\n\nThe broader consumer effect compounds the direct cost. When household mortgage repayments rise, discretionary spending tightens. The dining and accommodation dollar is not the first thing to go, but it is among the first to be scrutinised. Operators who have not yet built a pricing and value communication strategy for a constrained consumer environment need one before the next quarter.",
    url: "",
    angle: "For operators who took on debt to fund fitouts or acquisitions when rates were falling, a reversal to 3.85% and climbing reopens a wound that had not fully healed. The operators who locked in fixed debt during the easing cycle may be sitting quietly satisfied right now. The lesson is not specific to this cycle."
  });

  addNewsItem('econItems', 'Economics', {
    headline: "RBA Forecasts Inflation to Peak at 4.2% Mid-2026, With No Return to Target Until 2028",
    blurb: "The RBA's February Statement on Monetary Policy projects headline inflation peaking at 4.2% in mid-2026, with underlying inflation at 3.7%. A return to the 2 to 3 percent target band is not expected until mid-2028. This is not a rounding error or a conservative estimate. It is the Bank's central case, and it has material implications for every business in the hospitality sector that is making multi-year pricing or investment decisions.\n\nThe input cost environment, energy, food, insurance, and labour, remains elevated and is not expected to normalise quickly. For operators who have been telling themselves the cost pressures of the past three years are temporary, the RBA's own forecast suggests otherwise. Eighteen to twenty-four months of above-target inflation means the cost base of 2024 is not a ceiling, it is a floor.\n\nThe strategic response is not to wait for relief. It is to build a business model that is viable at current costs, not one that depends on costs returning to where they were.",
    url: "",
    angle: "The RBA forecasts are not abstract economic projections. They are the planning assumptions your bank, your landlord, and your equipment supplier are already using. If you are making a three-year business decision without accounting for 18 to 24 months of above-target inflation, you are not planning. You are hoping."
  });

  addNewsItem('econItems', 'Economics', {
    headline: "Superannuation Guarantee Reaches 12% in 2026, Lifting the True Cost of Labour",
    blurb: "The Superannuation Guarantee reaches its legislated 12% ceiling in 2026, adding to the total employment cost burden for hospitality operators across the country. This is the final step in a multi-year schedule of increases that began at 9.5%. Combined with the national minimum wage rising to $24.95 per hour from 1 July 2025, the full-time award rate stack, and the complexity of weekend and public holiday penalties, the true cost of a casual Saturday night shift is materially higher than most operators' back-of-envelope calculations suggest.\n\nThe super increase does not show up in the hourly rate conversation. It shows up in the end-of-quarter reconciliation when the numbers do not add up the way they used to. This is particularly acute for operators who have not modelled the full employment cost stack recently, including super, leave loading, and the annualised wage obligations that apply if they have made those arrangements.\n\nFair Work's PACT tool and the updated pay guides for the Hospitality Industry General Award and the Restaurant Industry Award are the starting point for operators who want to verify their compliance. Getting this wrong is both expensive and reputationally damaging.",
    url: "",
    angle: "The super increase is the quiet cost. It does not arrive as a headline. It arrives as a slow-building gap between what operators think their labour costs are and what they actually are. Operators who have not remodelled this are making pricing decisions on incomplete data."
  });

  // Deep Dive
  document.getElementById('deepTitle').value = "The RBA Hike and the Hospitality Operator: Why This One Is Different";
  document.getElementById('deepDeck').value = "It is not just the rate. It is the sequence, and the fact that this hike arrives when the industry's buffer is already gone.";
  document.getElementById('deepBody').value = "When the RBA cut rates through 2024, Australian hospitality collectively exhaled. Lower borrowing costs, modest improvement in consumer confidence, a return to events-driven demand. The story looked like recovery.\n\nThen the second half of 2025 happened. Inflation picked back up. Private demand ran hotter than expected. And on 3 February 2026, the RBA did what it said it might have to do. It hiked. Twenty-five basis points to 3.85%.\n\nFor most industries, a quarter-point move is a pricing footnote. For hospitality, where average business lifespan is 4.2 years, debt is common, margins are thin, and labour costs are structurally rising, a rate hike does not just increase the cost of capital. It changes the calculus on almost every significant decision an operator faces.\n\nHere is the specific mechanism. The hike increases mortgage repayments for operators who leveraged property to fund their venues. It increases the cost of equipment finance. It tightens the lending appetite of banks who were already cautious about hospitality. And it puts a ceiling on consumer discretionary spend, which is where the dining and accommodation dollar sits.\n\nThe timing matters too. This hike arrives in a post-Lions Tour, post-stimulus moment where operators had just started to feel like the structural headwinds were easing. They were not. They were pausing.\n\nWhat is the strategic read? Three things.\n\nFirst, repricing is no longer optional. If your menu, your room rate, or your event pricing was set in 2024, it needs to be recalibrated for the cost environment of mid-2026. The operators who reprice proactively will feel this less than those who wait until the next quarterly numbers make it unavoidable.\n\nSecond, the demand shift is your advantage if you use it. Australians are dining and travelling less frequently but spending more intentionally. The venues that give them a reason, a genuine experience, a clear value proposition, a consistent standard, will capture that deliberate spend. Generalist operators will feel it harder.\n\nThird, the labour cost stack has changed permanently. With superannuation at 12%, minimum wages at their highest real rate in a decade, and award complexity growing, the true cost of a Saturday dinner service is not what it was three years ago. Operators who have not remodelled this are running on assumptions that will eventually produce a surprise.";

  document.getElementById('deepTakeaway').value = "The hike does not kill hospitality. It kills the business models that were already running on margins that could not absorb another pressure point. Know your stack, reprice your offer, and play the deliberate-occasion consumer rather than the volume game.";

  document.getElementById('deepGameAngle').value = "The deeper behavioural story here is one of optimism lag, the tendency of operators and humans generally to maintain the mental model of a favourable environment for 6 to 12 months after that environment has changed. The businesses that were thriving in the 2024 rate-cut cycle built systems, staffing levels, and pricing structures optimised for that cycle. The hike does not just change the economics. It punishes the delayed update. The operators who will navigate 2026 best are those who treat the hike not as an interruption to recovery but as new information that demands a new model.";

  // Resources - semi-permanent, only change when something significant appears
  document.getElementById('resourceItems').innerHTML = '';

  addResourceItem({
    icon: 'üè¶',
    title: "RBA Statement on Monetary Policy, February 2026",
    desc: "The full economic outlook, inflation forecasts, and rate rationale from the Reserve Bank. Required reading for anyone making a capital or pricing decision this year. Updated quarterly.",
    url: ""
  });
  addResourceItem({
    icon: 'üìã',
    title: "Fair Work Hospitality Award Pay Guide 2025/26",
    desc: "Current award rates under the Hospitality Industry General Award, effective from 1 July 2025. Verify your classifications and penalty rate calculations before your next payroll run.",
    url: ""
  });
  addResourceItem({
    icon: 'üçΩÔ∏è',
    title: "Dining in 2026: What Australian Operators Can Expect",
    desc: "A clear-eyed sector report from Restaurant and Catering Australia on the deliberate-occasion diner, the death of the walk-in, and what consistency will mean for operator survival this year.",
    url: ""
  });

  // Spotlight
  document.getElementById('spotlightName').value = "Future Food: Navigating the Deliberate-Occasion Diner";
  document.getElementById('spotlightStory').value = "This week's spotlight is not a single operator. It is a capability. The team at Future Food has spent 2025 working across some of Australia's largest cultural institutions and greenfield hospitality precincts, and their 2026 trend report is one of the more honest assessments of what is actually changing in how Australians eat and drink.\n\nTheir central argument: the differentiation between leading and following operations in 2026 will come from how well operators understand the specific context they are operating in, not from copying what is working in a different postcode or a global playbook. That is not a soft observation. It is a structural point about how competitive advantage works in a market where every trend arrives simultaneously and the operators who execute it well are the ones who filtered it properly.\n\nFor operators navigating the current environment, that framing is useful. The rate environment, the labour costs, the shift in consumer behaviour, none of it resolves the same way across every venue type. The operators building durable businesses are the ones who know exactly which game they are playing.";
  document.getElementById('spotlightLocation').value = "National";
  document.getElementById('spotlightCategory').value = "Hospitality Strategy and Consultancy";

  updateBadge();
  updateCounts();
  // Show preview button since content now exists
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  hideEmptyState();
  switchPanel('news', document.querySelector('[data-panel="news"]'));
  showToast('Issue 001 demo loaded. This is example content only.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  // Auto-select nearest upcoming Friday
  selectedDate = nearestUpcomingFriday();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('issueDate').value = selectedDate.getDate() + ' ' + months[selectedDate.getMonth()] + ' ' + selectedDate.getFullYear();
  setDateMode(selectedDate);

  renderCalendar();
  updateChecklist();
  updateCounts();
  updateBadge();

  // Hide Preview and Archive until content exists
  document.getElementById('previewModeBtn').style.display = 'none';
  document.getElementById('archiveModeBtn').style.display = 'none';

  // Show empty state prompt
  showEmptyState();

  // Close modal on outside click
  document.getElementById('exportModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('exportModal');
  });

  // Auto word count on any input in dynamic areas
  document.addEventListener('input', function() {
    updateCounts();
    checkShowPreviewBtn();
  });
});

function showEmptyState() {
  // Show the empty state panel, hide all section panels
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = 'flex';
}

function hideEmptyState() {
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = 'none';
}

function checkShowPreviewBtn() {
  const totalWords = parseInt(document.getElementById('totalWC').textContent) || 0;
  const previewBtn = document.getElementById('previewModeBtn');
  const archiveBtn = document.getElementById('archiveModeBtn');
  if (totalWords > 50) {
    previewBtn.style.display = '';
    archiveBtn.style.display = '';
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI SYSTEM - COMPLETE REBUILD
// Architecture:
//   Build This Issue: Scan 12 stories ‚Üí Select & classify ‚Üí Write selected
//   Community Finder: Scan 4 spotlight candidates ‚Üí Select one ‚Üí Write
//   Deep Dive: Derived from selected Build story flagged as Deep Dive
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ SHARED STATE ‚îÄ‚îÄ
let buildMasterList = [];    // 12 scanned stories
let buildSelected = {};      // { index: 'industry'|'economics'|'deepdive' }
let buildWritten = [];       // fully written story objects
let communityList = [];      // 4 spotlight candidates
let communitySelected = null;
let _staged = {};            // temp store for AI results awaiting user click

// ‚îÄ‚îÄ SHARED UTILITY ‚îÄ‚îÄ
function aiLog(containerId, msg, type) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const line = document.createElement('div');
  line.className = 'log-' + (type || 'info');
  line.textContent = msg;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function setProgress(barId, pct) {
  const el = document.getElementById(barId);
  if (el) el.style.width = pct + '%';
}

let lastApiCallTime = 0;
const API_COOLDOWN_MS = 180000;

async function waitForRateLimit(logId) {
  const elapsed = Date.now() - lastApiCallTime;
  if (lastApiCallTime > 0 && elapsed < API_COOLDOWN_MS) {
    const waitMs = API_COOLDOWN_MS - elapsed;
    let remaining = Math.ceil(waitMs / 1000);
    const msg = 'Rate limit cooldown: waiting ' + remaining + 's...';
    console.log(msg);
    if (logId) aiLog(logId, msg, 'active');

    // Live countdown
    await new Promise(resolve => {
      const interval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(interval);
          if (logId) aiLog(logId, 'Cooldown complete. Resuming...', 'active');
          resolve();
        } else {
          if (logId) aiLog(logId, 'Rate limit cooldown: ' + remaining + 's remaining...', 'active');
        }
      }, 1000);
    });
  }
}

async function callClaude(systemPrompt, userMsg, maxTokens, useSearch, model) {
  const PROXY_URL = 'https://young-fog-3045fgww-proxy.julian-68d.workers.dev';
  const PROXY_SECRET = 'foodgame2026';
  const tools = useSearch === false ? undefined : [{ type: 'web_search_20250305', name: 'web_search' }];
  const useModel = model || 'claude-sonnet-4-20250514';
  const maxRetries = 2;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    lastApiCallTime = Date.now();
    const response = await fetch(PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-FGWW-Auth': PROXY_SECRET
      },
      body: JSON.stringify(Object.assign({
        model: useModel,
        max_tokens: maxTokens || 1500,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMsg }]
      }, tools ? { tools: tools } : {}))
    });

    if (response.status === 429 && attempt < maxRetries) {
      const waitMsg = 'Rate limited. Auto-retrying in 90 seconds... (attempt ' + (attempt + 2) + '/' + (maxRetries + 1) + ')';
      console.log(waitMsg);
      document.querySelectorAll('.ai-log').forEach(el => {
        if (el.offsetParent !== null) el.innerHTML += '<div class="ai-log-line active">' + waitMsg + '</div>';
      });
      await new Promise(r => setTimeout(r, 90000));
      continue;
    }

    if (!response.ok) {
      const errBody = await response.text().catch(() => '');
      throw new Error('API returned ' + response.status + ': ' + (errBody.substring(0, 500) || 'Unknown error'));
    }
    const data = await response.json();
    if (!data.content || !Array.isArray(data.content)) {
      throw new Error('Unexpected API response format ‚Äî no content array');
    }
    const text = data.content.filter(b => b.type === 'text').map(b => b.text).join('');
    if (!text.trim()) {
      throw new Error('API returned empty text ‚Äî model may have only used tools.');
    }
    let cleaned = text.replace(/```json\s*/g, '').replace(/```/g, '').replace(/<\/?cite[^>]*>/g, '').trim();
    if (cleaned && cleaned[0] !== '[' && cleaned[0] !== '{') {
      const arrMatch = cleaned.match(/\[[\s\S]*\]/);
      const objMatch = cleaned.match(/\{[\s\S]*\}/);
      if (arrMatch) cleaned = arrMatch[0];
      else if (objMatch) cleaned = objMatch[0];
    }
    if (!cleaned) {
      throw new Error('Could not extract JSON from response. Raw: ' + text.substring(0, 200));
    }
    return cleaned;
  }
}

// Global cooldown to prevent rate limit stacking
let cooldownTimer = null;
function startCooldown(seconds) {
  const btns = ['buildScanBtn', 'buildWriteBtn'];
  const labels = {};
  btns.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) { labels[id] = btn.textContent; btn.disabled = true; }
  });
  let remaining = seconds;
  function tick() {
    btns.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.textContent = 'Cooldown ' + remaining + 's...';
    });
    if (remaining <= 0) {
      btns.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) { btn.textContent = labels[id]; btn.disabled = false; }
      });
      cooldownTimer = null;
      return;
    }
    remaining--;
    cooldownTimer = setTimeout(tick, 1000);
  }
  tick();
}

const AUTHOR_PHOTO = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCADwAPADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD6cnA7jNUzCwfIXrVs39tsI8xC31pY7hZFHK/nX53GLufQN6GVd27x/OtSTp52kTdztrUuY0eEBSucetUjDi0mRmABU969inK0dzz5r3tjxDUA4uplBxhj0FZdxNLnb5hH4Vo6q0kOsXA2sy7uMCs+dGZydrflXfFpoDLk1O7tpv3c2PwqnqWp3LJuZwxPtTtRjdXyAQPpWbcSCRMcjFbJR7Es09M1y68oRBlAP+zXdeFbub7Ncu21mXplfavM7OVYJASa9E8GS+ZZ3nI9h+FZ1Ixs3YuLeg+PxJfEYGz6baZP4gvgMbYt3+7VGyDsxwpPJrqfCvgS88QXDXlz/omkwnE11IOM9lUDlmPYCuJ+zjrJHouMtLGDF4k1+IGC0tRMZf4IoiSfyrS07RvFFx5Mt5YW2nQygust7J5QxnHTrn2xXoV940mgtP7O8JaYllEn7o3gjXzZSOvIyRnjjn6+iaX8MfEN65u9UungVxys+WkyQODz/M1yPEr7MTaOGb+JnB6lpGqwzvCbjTWdQPkjLsQPfis3Vpb3RPDd5LNa2013BIE2xEtnPII9uOtesXvw9tli2SXE7Sjo3GPf8PaqF34DAhTyLk5ClfLYcY56fnUxxCveSN3gm4+6fN178VdT37GsIAU4xzWYPi/fxy4NhAcHpk1674w+DB1q+e4h+zaXMdqyHY3k8DlvlBOT+tcBq3ws0ZHutOtb6/m16Jd8TS2yx20wHJC/MWB69fSvbpzoVFdHiVKNWm7MyJfjPfvC0YsYlU9gx5quPi9eNF5bafDj/eNZOv8Ag268M3cUFw0cplhSdHhO5SrDjn8xWLLCqseMEV1KnB6pHM21ozsYPijOikfYYuf9o12una/DqngS6v5LONZ0DkAH0rxfaAMgV6T4eG74YXj8jh/51nVhGMbpFQ1kZ0HxPuFhEYsIeB13Gqtx8S7ky82EX51y0Cd80s8QODiuXS9j0fZx7HVw/E+9tpGeK0jTcMEbqji+K2o227bawkt65rlRCR1FQvGc9KtJB7OPY6+b4uanImGtYB9M1NoHj99Wv2juLWPaFzkc81w88ZMeaueD492pXDFdwCVaimY1IqMdjfvfiNe213PDbQQiNWIBOajg+KerQgjyoPyriLy7J1K5wMAyHigzZX3rf2cbbGKPsIag2Q5nbPpVSHxNdC6dfPO0dBWROJVAGx930rHxc29yXZWAPcivnaMFqz1K+ySR2jeMb5cgSHaKhbxjeSIwMhwRg1zLSSnnHBpBKw6rzV1I22HSjF7o1DruxyWiDknJOetP/wCEgDAk24/OsZ1J+bGKh84q+O1EY6XNZKPNZI6W0vIb64hR7YYY4PNY/ia5ttM1B4VtB90HtVjSrjF9a89XxVLx/bv/AGspxyYxWkN7HPUguYzn1W2nVQLXBH0ro9C1qK0wywEAjkcVyFpCVIJFbNrL5fatZLSwo049UejeG7i21nUUt008yO5+6uBgdyT2HvW14x8TXF9q+l+CvCVob68uG8srAxEYPc57qozk9+fWvMvB/jhU1aezj3O88bJFbwn5pcfeZj2Qe/WvVvhPqqeEp7zW5QJtY1H5UmJ3GOEHjHpuPPHYCvPlTTlzT2R0RTbtTWp7V4R+Eth8MdFjkvHW41HZukuDyFOOiDsB09a5zX/ESXMzJA2VB7cj61j618Q73XwYWnOzPzEHBasMz8k9PXFaWjJ+6rI68Ph5RfNVd2aFzO7AkuTVAzNlhuwOtILncpJPNV5bgMD6Dr9aTpp9D2IysrE8dx5Uu4PggYHGf/1isfUoTp8r3tookgkUR3GntGrqE5zJFuyQRk5UepxxxU5lAQkj6VRurrHy5IFZ8koaowrU6dZWe5iXvw70Pxnpb3zvdWa6fb5JWJSH/iIPoAM/nXnkngXwbtlnaaVkQZYuGUCvQZ/Fk/h1JraaRjplyGwoGQJCuACSeAe35Vxutag+o+HLuxhn3vIxmZIowWkIztTr6130alSyuz5mtQUZNNHL3Hh7wI0DmK7AI/6amnRa/wCFdP8ADcujRzAqwI4Ynr715ZcNIk7gjbzyMdKqSMN2a9DlbXvM5FCN7o7q3sPC5OPPx/wM0XeneHfl8u5HXn95XEQuQc4p4lJb2pcmptqup6JpnhPQtXl2Jd42jLYkpL3wn4btjIjX3zqcH97XO+F52immZc52gVi6hP5tzKx5Jc5o5NbXFG76nUT6D4dVMfbcn/rrU3h0eH9EkuSJg7SDGS+a8/lIHIqJJ8OapqyumPl5tGzqD4Z0Sa6kle6Kh2LY8z1NWP8AhFvDan5r7j/rrXJPdE4GaieYbgO1EHOW7FOnGK0Pr1fGluNu6zyfwpmta1BcRKJbMRbuhwK4qa7WOENnDjnipDq0uoBd7A7egFfLKc1HU+hdCk5KyOlt7vTY4fnQE/7tNFxplwyoEA3HGcVzchJXrTYmZHU5OMjNR7So92bPD07aI7S6i0/SoD+7DFxx3rHWLTHIaRAGPP3aseJ7fGjQ3cbbsDtXMWE0k/LfrXVUlKyaZw0KcW2pas7Wws9CimhmYDcjBsYNX9fi8O6vMsrgZVcd64+CZxwRmklvBGCGHBrl55p7nY8LTbuaB0zw1v8A9YB/wI1dh0bw1InN0EHc7zXJyPGzZ21XkvEjzgZwK1VSb6kPCwSepjfDDTrU32v3cEzTNcXBt4pJBgJCGyAPfGDj6k54x7FDeAMqr8sajaO2AK81+Ht3aabockccW27nlZ2fAAjUnOF9M/n09K6q31AhFHc9s5rur9DkwWl2dvYXGZR6evatvzEZAH4J7CuU0m5V8ZO09a6BLiIoMsuayiem1cdJGvRW46jAqFuYnGPmFTSSqhUA8kHkdBUaSArz3P511ItNmXeSSRJ3z2GOKzp7tgME5bFbd/NEECtjgdzg9a56/eNpBjiraujKT1M3V7GPWtOns5R8siEAkfdPY/ga8u0oSabeGB2NvNE2T5bbQ2O+O/ANepythieSRzXlfxauBp0kFxCwSSYsp9yMY/ME/lRQXxQZ52L2UkYuv+FTLqlzJbyr5LuWQ4zweazoPAV1cycTJn6VPG88llCzsyyFQSATxVvRZrhrp1R5JG25wCa19rPY5fq+l7mXc+DLqFtgkQfgajTwfd/3kNa13qMvmMGdwc+tXra6dox+8b86yeInE1WGT0uT+D/BM/l3LSyqCcYAFYdz8ONSM0m3ayliQcGus06aVQSJG/OuitdTbytpJJ9zXPLGTi7msMEu55Bc/D/VY1IEYNZh8D6sZMCHn617Xc37hT81VbO9815MkcKT0qoY6cnaxU8EopyvsePN4G1bdzEvH+1TH8F6pyPKX67q6+/8RXK31wizHCsQBgU2LWbqRM+b+grtVaUTgdLmW56fdW8O4kLx16VZ020s4IxPMuE75FVL2YRKRg596jkv3TSimw8+1efBuejNKkfZ2aZ00Wp+H84dFx9KtwS+G5nGQuK8taY7hk8VftrzbgCodJLWxvGbejbPTNWv9JuLBbOEDy8Yz2rIXTNKC4SQAn/arn0ugIzTIrrD4J4rlkrnVTjy6JnSjSLNWXbN14+9Ud3o1oMgzYPX7wrLi1NLd0LHIzVbVNXSecFeBtxxUqndmkpyi7XFu9KiWT5Z+PqKzfEOnJp+hXd4J/mjTIGRyemP1qle3g3j5qjbGoW0kBOEkG0t2Ga6I0rNNmUpyadmYui3cljo1tNOyiWabC7DnC47fy//AFV6PpkiLHD5gUNjPvXzf44+I0WneH573w8k0mo2Mm1Uu7ctGiKxWSXHRsYxnOO9dj4T0zxT4i8L2Wqa14y1AXV7Esws9MSG2jiDDIUsELE4IzyK9CrSbXM3ZHDhqqg3G12e/Qa7p9l/rriKPHXc4B/KhvFujuWzqCxPjjeuB+dfPGvxeE/CUHl634j1yaYjLRQ6jKzE/wC6tee6h4h8M37bdM13xHax5x/pjiWMc4ydwJohh1JX1+46ZYqUHrb7z7Rh8UR4LGZGVRy6nrUcviMq9vI7nY7YDHgYr5N0zxrrvg7SbvV2WDxT4dsGja7SOQ286xs20MD8ysM4z061u65+2P4W1PT3W08N6pHLGoRY3uIdoOPUHOPwq44epe0dUW8bThH39GfRNxrUWpSsouY4lX+8cVNBbJJ+9W6jnjPQo2RXyNNrfiXUEW5vLyx0C3lRZPKdnndEPI3HKgHHaum0W7s2tY4W+KkSXB5FutthfYfM9b+zcVa6/E5Fied3SPpCQxMxQHDCvI/ispllMDgmOWLzozn+NTyPxGKo2+o+KNLfEOsWWrQHoLiB4wPfKMcfl3rlviF8TJtP1rR9O1/RzYXEchcXFrci4hmRht4OFYHOOCKzhSandBWrRdN82h066Lfz267ICeBjkZrqPhx4Wvba4vrm6hCjaANxBriF8YajbuV8wLjjDAHH41dTx3rUdqzrKgjI5wOcVmoyTM5ylKNhmrW9zLqV2TAVHmNjFQQC6Q7BGx/Cse88XXbMSGUnuTVCHxjepKSQmPxpeyci/bNdD0bTDcgfNE35cVpmSVBwjg/Sqv2y7XwVFfRqiyFVOWz1NcFJ8RtQSUo8aBgcHBNYPBuS5kXDGvax3088rAnY5/4DTLEXLtORG33PTFcPD8Q7qWdIyiKDwTuqze+PbzTZx5QRgw5BNOGEcfeKqYxyi4pGZPa3x1O5ZraYjzD/AAn1q35c6RZ8mUH/AHTTrfx/dSF2a2jJPfNRSeP7hWP+iof+BV1NNnIpy7H0bqOpadcsdkIH4VShW0uYmjkUKpPrWC8uwZzV20glmtTLuUD0PpXiqvO2iPQlhaa3bFvPCtizgpJgexyKlt/Bipam5DExjvVCcsg9aml8STx6Z9kAAXGN3tVRrt7jeHSs4s3P+EWtI7FJnm2hu+cVRbQLM8rdfhuFW/E1ylt4Pt5B1wvNeexaspkyScdqpwk9SacrrVne/wDCI2s0QZro9fUVn3/hBQQ0dwSAMdBXPRasTn5iBVxddVbRk5J55rJKcXudTgnrcqX3hOUvkT/pWDdaxfeHfEVpo6wR3NvPCZWOSCRzn27d6sXWsSGTAdgB71RupA95DqD5d7eORTnnORXRFz6muHglN37GvqXhDTtd0G6eGKPGo2skPlqB8pZWXp9f5VzvhCC+1P4deH5tN8tLg6fEjtKSFVlUI2ffKkYrY8Ja1LqemXT7FjgimWKEpwTgZYn8xVfRrxfA097Y3lrdtoktzJdWd5aQPOkAkbe8MqoCybXLFWwVKsBkEV1qo5Xitzknh+R3fmccfCmhaZFN/bmlyXOoSEvLcykHzT9CcAewqXSvA1v4hdYdO8Px21o+N00sagEZ9K9P/wCEq8B6jEGn1vSFf+EXFwkbJ+D4IqW4+J3grRbcMviGxuCq8Q2DG4c+wWMNW8J1baJmTpU01do5Dx94Mt4vB1j4PtY47ddZv7bTgkI2lkL+bM3/AAGONz+VdH8avhXoOo/Dy/0uy0OwtZY7RvsctvbIjxSKvyYIGewB9c1L4Itr3xl47sfF19E9joNvZyQaZb3WBKXkK75mGSAzKu0D+FcDqSB3/iq6s5N8ZcOgHXPFVRupWvtr8zvjRhKjJyW+nyPlmHwtbeO/Bmk6zFb/AGiSS1ikaEOQSQu1hx3BB4NST+C/A2owrtt5bG8IBkRzIPm69DkYz6VsaPe/8Ko1/VbPUFZfCt3dvcWV6iFktWfl0cAEhCxJDDoc5wCDXpOlW/h3xRGt1a3lheIerQTI+fyNd8uaOsWeDGmvhaVzyXw94cn8O3qw2F7c6lpcnDQtyYvdT6e1bPizwZZaz4t8JC5h89DLPdT5O4lIo1xn/gUi16Xe6TpuhRi4e4S1j7vLKFT8yRXM2Goxal4rm1qF0m0yC1FlbTqCVmZm3zuvTK5ESBhwSjEEiuVzfNzM2VK6UF/VjlvFC22p3IvdKs5IbRwVACYBKkjOB0ziufmN8sJi8qbZ/uGum1DXpPD839mrGjIhZyOmCzE/yxXQeHvEEVxpU9xLbISueA3pWabitUVi7KrJQ2ueRNb3Jc5hlx/uGoZIJwCRDIcf7Br1Of4gWlsufsAP0IqOL4n6ckR3acd34VopN9Dhk5LoW/FMtzafDiyjjEiMyxg4BrykwS5yyt+Ir2I/GGx1CySCXT2Ea444NUz4/wBFmb/jwOPXaKLuKtYmCa6HksyGNSSP0qKJmY8/rXrg8W6GxObI8/7AzWrp7+Hp9Jnv5bNdq5P3AcAU+fyLba1aPIbc4j44qvK7AkmvSpvFPhpmUraAD/rlU1t4m8JiQGS0UjOf9VUX12HzNdD2a6tNGkOVYD8avaX4fsbq1fbMRGOwauOmlXPyiur8KSK+nXYPBxn9K8CEuZpWPTqQcE3zEF3o+lupVbjn/erJm8PWZOBc8fUVyd5qPl3NwmfuuRWRcaxtb75/OtlTu9i7OKvznp3iSG3vfD8enxzgtjFcgfBMtpGCtwG+q1gJq7hch2P1NSJr00gKmVvzNXJzWxnCmlrc0ptBuIzjzFx9KgfTJ0XAcHNZUuszrIAZmxn1pbvWWRVxK2T3zWfvPWx1xXS4670maNiQy5otrCdkdSvmAjBRTyR3FY9zrMzHPmtn60zT/FUmnahbXDyM6xSBmXPUZ5rpgmON4TUrnZW2gnwtp62G8Opdp8jqN2Mg+4xWtYIy7XXHmDpntVW61yy1+RJ7GQSRhNreoPXmnQXAwVHXHJBrKad9TqTuzZ1u4lltIjG8bOmeJ1yGrxfx5d6nrVymmpK1xlsyJADtCZ6YHtXpGtaiyWzBATtp/grSYtNkEs6q19cjc5P8C9l/z61vSlyLmZFRKTtE57xV8V9W06/02xj8PXLWWwZK/IY06DaMYYj0yOlV9T8UOY5JpnmMaLuC9GY9h9e3NerXelK4LH7gBOAa841XwnHquoEYuUIz0HH410Yecb6oivKTjozlNI8Znxb4cvLC9sDY3HI8gv5mD/CyuAKq+FNF026nmhvtPtLmeM7SZ7dH3fiRmuli8NtpbMu07T03VSmtRHfLcxDbIDskA4yOxr05xaV0eSqicrSR1Vl4T8PW8Rlj0bTUfqGW0jJU+2RxRqNubqaOEM37wbRio7O7LRY6/XtU6ypHc20sjiOOJwWf+6M5zXFJO9zri0noeXeLlSTXtQmLlcPjb6YA61Nocsv/AAil3NHkqN/TpW/qmqaffX9zKbfIkkZgcDnJptt4qsNK06SyFqdj56KMc1s3zKyR5VXmcm/M8ybUmkTk1GbzjqK7cXmituYwAf8AABS2kvh+4njjaFfmYD/V1opLsY+8cZBdrtxuxn0NWknHY5rs9Y0fQLe+iCxooYZ4XApp0vQ9wKqgH0xUtouMnbY5D7YVGK7nTr1I/h5OzdSjHP41UfTdD34+XB9M10dxeaA3hQ6XFsDFdvBx+NZuxMnJ2SPJY7ncKsRyDqa6JPDOmL1n4/360LHwjo93Mkf2rBY44kp3TL5j2hrzTHxggD1zW5oGr6TaPIrSAK4x1ryGO+JAFW7e43kdq8O3Lqkek4c6s5HRa7odnPqE8lvJhHbdjPFc7ceHI0JzJ1qxJIYzkOcVm3940ikBjke9VCo77FypaWuW5PD3k2TTiQbR3rHaWGPGJFya24Jnl8I3RLMSobqa8afUZ3dsSuMe9d8aHtVc4vbSg3E76ezN2cpMg54qfU/DdxHDE63CN6ivNRrF5G/Fw4/GrH/CS6gVCm6cgdia3WGa2ZLru9zrZdGuFGdyH8ayrzR7rfkAHPYGsR/Ed90+0tmptH8SXk+qW8Ukm4Fx1FXGg1qN4htHY+B4rnTdRnhmQqk0eevcHj9Ca7uLAQ7B93v615tq/iGTTfE1gC4EQK7wPQnBr0uJ1SEAcqec1yVqdnfuehhqnPT1ILy2325djxnJPXjvXC+KPipceEvtN7Fol/qdtEdhktIiyIxGQWI5AruNUuibAQoNpZsZArofD9raWFikaxjY3LEjIcnqSKhOEEnNXNYqVSdouxyHh+68ReOEhaLXtLg3iB/LW9GUSQcZA5B/qMVq3HgzxvZNqsY16J7W1jVklQAmRipOD3A4HPvW/cw6IbV42s4kOc8qCv1xiuWn0LwzMWJ0+2kY8EeWRke4BxiummlJ3i9PQ2qUa1tKq+45Lx3qPiDwBp9xd6lfW17a2zLGVll2sWKFmAz3449awfCnju08ZhpIIprZ8BkWdCrfX3rs9U8JaFczK82n28rZ3fNGOvYnPNVZ9Et4b2O6hjVSqgbVHGK9NqPLvqeHJTjK0nf5GvbI0aJwMH+dVvE1yYdInPRnAUfjV5XVgnsKrX2oWNtKI7yIS7vmXIzt/CuOUbamsZaNo86N0yNn0rOvruSeXgcDvXpcsmg3WNsCg/7lXfEHhjQdC02C6kRB5mOq9c04yS6HJNvqeMXF20UbVX0S6kn1iziwcNKK9FlXwtICXEf5GoNPXwta38NyDEDE4Ycmt01bYwk2UvFuLS9tkYHcY88/Ws1JpfL3gcfWu18UXvhvxBPDKkqBo1xkNisb7LpJj2LcgD/fqElbVFRm7HP/AGzcTmp4JlYHJ5rUHh/T5pUWK4+ZjgfMK1rjwLFZIhNzjcO+Kl2NFI5a4ZEj3E8VT0u9U6zaqOm+upfwhFcIV+1n8hUugfDqGPWraWS9xGGPBAqVypA5aHrHkeGWZtroP+BVc0rwzourOywTDI54avEINVJ7133wvvGm1dwD1WvMVO7sds3yxumdHqOh6ZbXLQG5wy9t9Z03hiwkf5brg+4rivH188HimdScc9jWG2ttnCyMD25NdCw3YxVWVruR6v8A2Ta2+j3FotyCWzya8wk+GEp3tHdjr3FOTUXZQTM+T71Bc6tcRAhLhxn3rspxlBcpzyi5O9yi3w4vWLbbiPj1BqlL8PtQSMv5qkir0fiC5gDf6TJz71NqWuTx6erpO25sd66EpMzaa6nPN4Q1FTwFP41JpnhXUo9VtpDECFcEkNU9pruozzLFG7SOxwqquST7CvTvD3wZ+JniCBbmDSvsNsQG8/UHWBceuD836Vsqc5bIl3S1Zw+seANe8YeLrXT9HsZLy6mjzhSAiKOru54RQOSxIAr0M2raYG0+W7hvXgUIbi1YtFKQMEoSASM5wcV02rXkvhnwxN4a0adrs3JUX+oKu2S9kH8C/wB2JT0Hfqea4uKwuLCwihuGzcQMyOV5xyTj8M4rLE0XCKTWx6eGhaF29WaltGJdqk4IPat22DNhUJx0wRXF/wBpPA4DZ+uOorp9G1mNlXLc98968qdJpXZ1058shuoaLf3YbYj9cZAJ/WsO48PanA43IcE4wOpruptfRYQqHryQp4xWXPfxOS3mYz3HaunDx0Nqsrrc5dbOSBszKwY9c5JzSsHGJFbaynj6VrG+V96qTLjncR09qxry9WI8gZ5rt5Tx6kruyHoctuY+9WfEXg+217wJa+JtCnluru08yLVbU87QrnEsf+yB8rDtjPrWMbzEDSD7kYLH3wM1m/sw/EGbTLDVIbsi5EVx5pQNkMspIaNgenfg+voa6aFKM21JabCd4x8zBi1FogBg9RXU/Fu6ceGtNwSMsv8AKuv8W+CtE8NahNusZ49OZhJBcNE2wofmHz4xxnH4VFrus+Dtb0mG0nkRig4yawlRlTnZrY5Z1ue1j52mvWUYPU1Atxvb0r0rVPDPhSSYeTcKv0kotfh94fvZEjgu8yOcACWt7xS1Meds84W4GcGpUzITjAFem3Hwm0q0O2a7YEjIO8CktvhlpTK23UGB/wB4Vm5RexamlucDojGTW7GEE/NKortviVdvYXNlGHb5kJ61Ys/hla2OpW9zHqDHynDc4qbxv4VfWbqGVboHy1IxjNZycboaneaaODg1KTP+sYe26raanMTxNIP+BGtC3+H1xJz5y/lV62+HGoSSbY2RyR71lJxOxTRl6LqVlJgSEfia9E8F6/pmkXRlV1DEY614dp8+zHykD3rWjuwMEEg1Eo9kQo3Vmz0vxFZWfiLWHufP2lj2aqbeELIMMXHP+9XFJqbL0Y1paTb6l4ivorLTbae9vJeEhgUs7euAKuKk3ZIHTilozqpvBbpbGaGbdGOvesmbw48o4uAT9K9Z8E/BDx7q+jNYzaPNYF8gTXjhEUeuc5/Kuitf2R4NHeFtZ8aySODmS30+25+gZm4+uPwr0qeBxFV2hE4PbwhfmkeN+Fvgh4j8dTsmlQLJGn+tuZW2RRj3Y/yHNex2P7LeiaTp0C+INYfUrnALwWB8uNfbcRk/kK9phhttE0C30rR7YWGnW64VQcszd2dv4iSOT71jzSfareTrx1yev+f6V9ThMohTV62rOOWJc37uxT8KfD/w34QvIU0bS7Wz4z9oADy/i7ZNdD4s1qJ7O6sYLtTdSQs6QKfnMYHztj0HT8ar6RaQs5klxIyj5UI4rN8R6Al14i0rXWDeZZOwfZ3VgRg8cqc4NejVpwpx0WiJUud6nnei6dE8GoSyyw2rkbIp5ULGIYOSoHf3/rivNba+TUb/AFlEU4gujH83VsIo3fjivTrqykhu57JAflldQp78k5NeLR3g0rxh4hiEnnRren5gMZBVT/n6V83m1DloxSR7mDrXkXL23Vs8E4rLF3LaOdmTit+4w53xkMhHSsm5Xc+5RtI65HFfKx00PTnG+qK0viaRMZVsdPWkTXBIM7Xz/unmo7mJXUZTIPdaijhVRgKzGumPL0Rzyv1Zoxaq5UhFYZ/vcZqExtO/J3FjzUQiYj5RgetWomS2QDduf6cmtVHmOeWj0KWuXH2awkRSB8hzx2rA+Bmh3D6prskK4t5JbffhQcldzdfbIpPFupbYniDct1xXrH7NnhKY6KHKEz6jI1wqsPup0U/kM/iK9fCUFKSi9jnq1Glc9/0GTytD06CXDAx+WQwyGAJGCDweK8++JH7OGleK/MvvDpi0bVMkvDg/Z5T9B9w+449q9O1Kxhtr2ztoX3JBEVchv49xz0/zyKVLyVpjBAxORnJ5Pv8Azr7R4OliKa5keNKu6b0PkPXP2afH2mbnXTob9F/587lHb8FODXEaTpOpaB4rtrS/s57K5R8tFcRlGH4GvvyCySUb5JGbH8WeKg1jwho/ieOO31C1jvynMZkH7yM/7LdR+FeViMnpRg+Sdn5jhiJSeqPh3x1qzNqqoSeIxXLC/YPw7D8a+kfiT+yjqbX8uo6PNNe2rf8ALq8ZEyD2PRv0NeT3/wAHrrTZWiu/PtZR/BKm0/ka+WnRdD3Zo7lPmRx9vqcoOBK+P941p2urScDzn/76rXs/hdPPIVS5Bx3K0N8OrmCYr56Eg9xXJPkZtCdnZkcWuSwjiZx+NdJ4N8RTzahIPOLAJ3+tc/deB73b8rx/ma1fB3hm6sLqcyMuSgAwa4pRja5vKppoci+uaFJgBUA+lXtKtdL16fyrfbnGeBXlptpB/Cfyru/g/pGo614xtNL0+Iy3F0wRR0CjuxPYAZJNejCCk7WOCd4q6Z2fhX4eHxV4pg0Szhaa4lYA7VzsX+Jj6ADnNfbHg7wJoHww06Kz0Oxt7aVkMc1ycPcTHGQWbGeoPyjA6DFW/Avw70r4XaLttEWe+ugGutQx80zegPZR2H9aW9ndpAEPzFw3Tk+g/T9a+owOBUVztHBVruVo3Oo0zU1l0NriQKkicE5rzye4+2XpyxYse/5Va1O/ngtjaxOViYk7R6Hj+RH5VnWMLIWkI56j+f8AMGvqcPh1TvPuedOo3ojYZA0JGRgj+dc5cD7PK69AeePSttHwhz26fn/9eqOrwBovMx0/z/jV8uoU52dia3PkhXTjP+f/AK1WvPUnBwUYYIbuKyNOm86IKT8w/wA/zH61PPLtB7qf8/41yVqbSOynK7szimkiudYvZoixy52F8AlRxn9P89a8O+IXgyfw14uvL9WZ7LVX89GI+44ADJ+GBj2+hr6AXQgiMY/mlRshh3FZ/iHw3F4m0a60+VVEyjdG5HKOPun+n0NRjMCsThuRfEtUaUcR7Grfpsz5/wBOv3gOxskdq15rcXEBcD5iOo9ay3tfsNw8E0RSaFyki4+6QeRWzYHy1K4yvpX5hVpOL1ProTujHm05wVIxyMkGoPsE7OFQbs9ABXUPDFvDEcdjkYqSIRIcjHPpzWd7ByuRgx6FOq7nkUe1ZmrTLZIwAwTxkdzXU6jewxRkBiWI6AVyospdUv4liUzNI+xEAyWPQACumi29WKcEtEcjb+Hrvxd4htNLtlLzXL4JP8KgZZj9BmvtXwVolv4b02IqmwW8YAwPuoBgL9eBXJfDT4V23goNqtwgl1yZNrc5WFD1RfcnGT+A71219cmANCgBWUhz/L+f8q+vy/DyclFrV7+h4GKqJK6ZDZRLaxuEXbLNI0spzklmOTn8aubV2/JncOdynBFZMt6IgVBGe59auadHJcJljtXuTX3LiqUbHhr94+Zm7o1m98W3XDRww88gZJ9BXd6FZW+nWpdEXzH58xwM4wa4O0uFjmjjj4jyB9ea3rjWmSPP8A4RfXHf9a+fxcZzlydzshJW5uiOju9VhssDzSfRRzn6Z6dqy/EOg6R4vsPs2r6ZDcxyfdLj5lPseqn3BHUVl6bG0kguJySTyD/n8K2U1As+1R+GPr/+r8a5qmGjFcu/cmNaTd+h4Z41/ZrvPD80l14YvJLqKVSRYXEmJFPXCt0b8cH618v69e634e1y5tdSiu7G4RzmG4Uow/A1+jD3DrGPKjDkDgHjnjkHt2OfT6V5Z+0J4Ni+IPg25sobeO+12zTz4Z+FKEHLIp9CM8H2714tbLouDcFqdka7UrtnxZN4wvdwxcNj61a03xfdLKpac5rMn8E6icgFcjqD2qKLwbqyHIQMB6GvnpUY2Ov2yKsPiDTplAMHJ/2a+vf2WPAFponh2XxbPZA3OoqYbfeMEQZ5I9Nx7+g96+UfhT4APjD4j6JoU4KW93drFKwP8HVvxwDX6N/Zf7MuVsrSMWttCgSOIDCqgGFGPpXsYGhzy5mcVZqKsiO3uG08tEWMmnSfcDnJiPp9KjvI42RjGMOh5XPQjkf5+vvizfSfaI2iMagAdVHH41jmR1DqwxNEOQTyyf8A1sdfbPYCvrKUOnc85vr2Iri3N08bY5IwR6cEf0FPkjW3BJHH/wBf/wCyqOzvg0ZbHIPT3yBWf/ajStslGA3H6f8A1hXpw5nFX6HNNpOxNaXG59p69Mfh/iBV26RXhZf9nP1/yKxZHMN18vQ8j+Y/pWy824RsvQYH5f5FaVY2tJGMXfQ5uAmC5ZM85x/n8cVZuc7Cc+4/n/jUGpx+RfkLnB6f0/TFWVxJCG9OePz/AJE/lTnT5onRCpZle0aREcJgsv3QR1Hp/KqlgVv7qSSFijjKsjfeRvQ/5wRWjGPKYHoQf/rVzXj3Sb3T2GtaRK0NygywXkSL6MOhHH61wQlOjJ21Xb/I7WoVbJuz7nnvxW0JbfVYdTRPLS5Pl3CgdHA4I+oGPqK5GCLyVZkyFwDgGvXnnh+Ivh6WKRUivAPnTsrDlWHtkZ/MV41MJbe7mtJ4yjxEho2POQcEe/evlc2wy51Xh8MvzPZwVaUU6VTdCz3rRRAbA2ThAedxqjHqkhw8nyjds59u/wD9en3MjQsSATtwBjtmoNJ0HUfFmuQ2dgj3MpP3RwiL3Y+gH+ea8OFHndktz0JVuXUv20E2r3EKQQPLJK21Y0GWJ9q9j+HPw2TwxMl9eFZNQOcIuCIAeoB7sfUfQetb3gr4fWXg6z2L+/1CQDzrgj5j/srn7q+3U9TXVC2dXGzCsOSR1/Gvq8JlSpJTqb/keNXzB1LxhsRy5QHHVfmx24/z/nFczf3ZFzL/AA7flA+g5/XNamt6pDp1oRkPIclVPOff6DufwrmLC3uNYumCZYEks/4/zr6PCUVRcqsvkedUl7S0EX9Otmu58KCRnk10TEW0YhT72Oalt7SLSLQ7RhvX8f8A61V7IB988g4HT3NdalzXnI55NN8sdi/p1tmUGT5VT5ifQZpy3DahchVyFGAB2FV9RujbWscOT59y2Tz1Hp+lXLSJbOIAsNxAJx/n6GuJx/5evdhKV3yI1nu1iQBRgAcf5+nFL/acWm24kmDO7kZx79B/P9KzZZlWJpJPuqDx6nnA/OqUMF3fOzmUxM5O+VBgqD/AnpxgZ6n2HFZKmp6vYpy5FY1X1+6nldEUpcsu0QJgmMf3pD2POdvX1qaGz+zW2wEvLIcMT1NLp9nBp1uIoVWMd/Un606bU4NPcMymWYD5Ih1z6n0FS7LSKIu2fIv7SukXPw58dsbMmLTtRj+0Qp2Rs4dR7A8/jXH6B4iuJNAluJHBYbiCRX0b+0H4FPxC8CXt5IP+Jpp3+kwOB0XIDx/Qjn6qK+Z7bw7eW/hl7dQrSFT3r43GUFSqPz1PTjUUoo7H9lSBvE3xCe8ZCo0+2ecSD+GQ/Kh/Mk/hX2vZeILXUYRFqC/Yr8Db52MxSe+e34183/sheE18PeCrnVbqNlk1O6KK6jJEcYwPwLFvyr6FuLa2kjDR3EcoI4DfKR+FduEptQVtzGq1zW6F25sgq7g4fIzuU8EVgak5DKyjEydDjr2IP5CneZJYt5bE+QcAhWyO/wDiagu7hHGDzuHDE9DhT1+pH5H1r6ShBvc4Kk7bGNNemzWWSBfMUlZAhPYn/EAZ+pqt9uiuII5U+VW9RyCBzT7vbDcBS37tyVXcfXjB/Dbx2yawYJvLur+0OQYysig9cHIP6gfnXpwjZ2ezMpe/G6Oimy0Mb5GVOCf8/X9Ku2zl4dpPIGP8/wDfNUYG3WqluerHH+fTdToZjHKgLZOeR/P/ANBP51a96nY59pia2jfbAR1I/X/PH4VPBxCARlc4P+fowqW/hLyB/vMo5/D/AOuG/OpLe1yoUnj7v8x/VapSXIhX1KNwNkZOOTn+X+Iq6irfaYuQMBcfkR/TNVr/AOVCSOOo/Q/1NT+GSJ4LiA9VI/XK/wA65KnuyU0dUXzU2ux5pcaTL4b1xmgyoBOF7FT1X8xXJfFrRktdStNdt8pFcEJMFHIkxx+Y/Ue9exeJrJZJEmxnDZJHocH+tY3ivww3iPw5c6fbBRcNFvjaRsKsicqxPYccn0rkxeGU6TstH+DPTo1ueze6/I8EsNOvPEOopYWULTXF0Nqwgduu4+gHUntX0F4J8Gab8PtIbz50NxLh7q6JChiOig9Ao5wOp5JrndC0aHwPp8sOmBJLuUj7TqUqZeU/3UU/dQdgck9TzXPxafqPii6E88klzI3KmRicDrwO34VyYPLvYe/Je8/wNKtf2qsnoek3nxE0SyVkgka8PpCCQfx4H6muevfH2oakfKtoxaRk8ADe5/THp2pdL+Gc77WnkVAB0Xnt/hXc6P4Qs9HQGOINJ3duW7f417Puw33OBuEdjjdJ8L32qS+feu8atyS5y7cfpXdWFjBp8BjiRQADge+BV5LfaRx1wCB9SKgnAjj9yBj/AL5qXNzZlKbastDN1OZppdgPBP8AWrlhZCaaKHogIz+IFVYYfPu1OM4yR+VbVon2XzWIxwfw7f1ory5YqKHR7nJ65eGfxJCnRY8KMdj/AJNdQIMYc4PHQ/59DXCPKbrU/MPVpMjNdpe6iNPsGkkI4GeB+P8AiKdeLiowXYIWa5mVri5M96ExmCD5mx/FIR8o/AHd+VbljE4iGeZTySeAPT8M8f8AAaytI094rSGScYkch3A7sTnb+QAz7VrpHI8RO4gYyEX6A5J7niuNtRjyotq75mMuppFxFbDc5GN7duvT0+tMj0yK1G+eUburY5JNXBa21ghluWw5zgZ56/8A66geF9WLSrF9ntE5yRy1Cl2M5ambeSR6lG9mqbbWRWR/VsjH9a+Gdc1vUvD+u3+mzS/PazvCwI7qxH9K+6EQPMwjX5T8gA96+Rv2m/AN7p/xY1OeCL9zeRx3OegLMoDf+PKa8TNaSlTjPrc78LKzdz6f/Z30w6h8FdAQ4ttQSN5VR+C6s7FSPwrqLub7Ohjv7Q/9dY6a9jb6Np1k1uipZxxiDZHx5YHAx9Ka8t4cPDKLy3IyA5ya1wtN23MaskUZdOiviPst9t7BW69QP6/zqnPZalZKSdtxFjJU+mAT/LH51ol7G5bbND9nk7lfr/hn8hTZLSeBCbe481QDwx9m/wAG/Kvapx6nDOTW5z14v22B4ZFIznKg4Yck5U9ucn8vSsWBN+pozy77lYGhl3LtLgEMrY9flwfqD3rr76TeXE8Gx+fmA4z+8rjfEqNbSJf243zWzmQY6lQeV/EV6iXNG/VGMJ68vc6RW8q2IPRcA/5+gNJpUTS3Jd+QvU/z/kfzqmt8t1Y+cjh4pArK2eoI/wAAa1LfGn2KK3+sk5PHbpWCdqVhtWnc0N2eTz3P4c/+yn86FcJ8o5PQEjuOB+qr+dUbS9Mhzgccj68H+n61fjXcwCnJHT69B+oT86zuRaxDfIHj9j/LP+DCqXhubyNUkUnh4yQPUjn+hq7fAMCE+7jA+nQfoV/Ks3TFEOsWsjZwzhcegbg/zNKprSudFB6tdyzruCs0HcZA/MiqcbF9Mh8zKmZd7NuA+TPyj8ev0xV/Xbcz6nbxAlfPfaxx0BAJP4An8qiuoZL2WRbeMENyQEwUHYD1OMcDsatTVopvQpaRsc7qtt59tcNGhCpGxAHrgj+YFbOkaKuk28USqPNKgt69DitieCC00VttnK7SSQoG25zl1Yj2yAwq7Y6VIc3FzzMwyRngcHj9KVWunEUbrQrW6shG7nB5A+lXvOyp9Dnj/gP/ANalmt1BbAAGSfrwKqbiHIHQZ6/TFeZzX3N+VPYviMn0HJP/AI8P8arx6adQn2CQRqgGWIJxyew+lSpc7gScDg/+y/4Vb0+7gt5pDMCyPgceoZsVXM0m47mE00tCjZ6V9jvHU4fg7WHQjI5/WnXS7YLhjx8pH5jH9c/hWsb6G6ljaJTuCnK44A68H8KxNel+zWrZ4LHt+X/xVLmlUmubc1pu1Ntnm2jOJtUiDttRW3MT2A//AF10VvcHxFqCy4K6fCd5x/y0IyVUfjyfYD1rh9TeW0nurSDi4u7kW8Xsp+Yt+CDNeqaBpUcMEEMS4gjGxR/ePAyfrivRxckndG9KHKl3NSGN5pN7/LhvujgKNx4qxLd+RiG3UyTkbcAcA4K/4UNE7fu48KSCSfTgGt/w9pVvDdF2GVjbmRvXf/8AWrxZ1FFczHyN6Ioaf4XLj7dqcmVxvwxwOhP9Kq67qsEifZrNldQMYj6DjufzrXls5PFc7ySSGDS4sKoJ4c4H6c1lX+padp0nkaXCskgODcOM4+gqYTcp+9q+3RDcUivaWo0eza8n4lCHyIz1Zz/Fj0H86+df21b5/Dmr+FUgwJJNObzCwyWPmE5P/fVfS+iaPPr2pxGYtIiESSsx7DtXzl+3lpL6n4h0MQqDJFav3/hJBH6Vx5hK8eRvXf8Ay/U2pJLXoe5NdCGa4tWGYWY49BWYYp9OkMtq/wAh5Mfb8Kt3EXmyyMCMhj1p8StsA3Bh6H/P1r06EU4pPc4qj1IP7QtL/C3EQikJ54x3H+J/IVWliltoy0eZoivIB5Hyn/E1antIWJLKMf0yD/I/pVGWOWzX925IA5U/Q5/ka9GmmcbY17vz8lHDrnLI/Ucn/E1gasFaBxs2EjkfgP8ACte6aO6LNLG0coz844P8f+FZWpQOUYF1kBziQdevcfjXpUtNzB76FHwPbWtlpIW4maQrcSNHCfTPA+gwfzrRurx9Qv8Ar8ueg/4DXIeGriaDWNTt54ipgXzIiejB+hB+ua7PSbExqJpfvHn/AD+VcMrptHXJJu5qW1sIIVOOVGfyqeJmAwCM9B9eg/UJVeScucKMAVNCCiDJwexPr0/ntqIszkhJ3UL1wp/l/wDqYflWVczgSK+duDnjtzn/AOKqTUJw78fdP8v/ANR/So7PT31GdUC7iT0/z7g/nW1RWpMKT99HT31r9p1G2m29Ekbk9yvH/owflU1pZXC+bbExFH2svmEgo20DIx1GAOD6VatZEEsUZ+fbHjcvU/Ng4/Kr/lpb3KS87wy9fQZ/wryXNSjyyR1Tj0Kd5axW2m6bGSSq3UQ3E4zhZOcfUVaaSMrwf84eqmvT7NJLL1S4hZRjpyo/9mP51AZxtVgP4cdfZqtRco3M5MtNCpLHOc8ZP/AaoXFrk5HGfT6n/CrEV0xlUY7/ANVqeV1MYJx0yfyapcWhqfUw0ZkOCeCOtXgN+TnkEfzaobgAN/n0WoY7oRt1zgjOPxpRvGVjaVpxujd01EghLngEDn/gP/164bx14iWF9u4fLxj3/wD15rf1DVkt7JgrchSD+SivF/F893qqzyxNzkkHsa66NFzm5ISa0T2Ni2nF3qsd3jJSEY/3ycfyUD8a9Th1KLSdOjaWVIgigeZIQAPU8/Svnnwb4guV0+OS5h23Jkb5G6bVOAfocZrf1vVZtQiM15ctJgcKTwPoOgrxsyzWlTtTh70kezh8FKXvS0R6hL8TNMt2+zWEcl/OR80p+VDwAcE8noe1aulfEk37DT540i+0MMPASW5YE5B+pr51tdbe9vFtLC3kvbw/cjt1Jc++B2969I8IaE9gTc6new27rlXZHAjhyMFVP8b4PUcD3614+FlicVUU56RW/ax3VqeHo03G3vdO567ealca066bYHyLKD928gPyk5AIHqM81Na6dbadGAiCRyPvMcn/ADiuXj8eaRbRLBaSlwvIWJCcDLeuPUVsaVrNrfxMYpT5igExuMN06/nXtxrUW/Z05L79zxZUKyXPODsdz4elMOnPs+WR2Cg/U4H+f9qvjz9t7Wp7HxzojRtiKSwOAfaRv6EV9caW/l2qru5Azz6nA/kR/wB818r/ALbHhqXWIPDepW67nSSe3f6MFdf5GvLxELxnJGqaVkz3GMpLD5yYaNzkH0qqshDsCfoPepJrm2lgiv7Mj9+22S1xwzY6j0PT2ye2Kg3pdojxY5xj164r6ajG65lseZVHzrnhclTx/MfyZarPcecSNuWb19SR/wDFmpIbrysBwSAAevoAf/ZRSXFsrZKHGzpn2/8A3ZrtiktziaMq4juZ8PgEHnA98H/2Y1nrYyTuzTqdoUn9Dn+Va5Wa0yGyQvU/T/8AYNU72+lEbDAAxjg/7wrvg3sjFnnV/riWXxAjswf3QtxuHbJYkfyr0BL7dEoXpivnqbxnpM/xc1OyurxYLvzEWJZTtDrtGNp6HvXu9tZubZHjIdSOorire8+ZHbG1kmakMuOT+dWPPaTABJJ4Ht/kgVzst1PZsd6ErV6y1JLhQynnrx+dckJ62Y5w0ui1fBQwPVev9f5EVqySL4d8PXV6WAn8o7PUHIH9P1rOLLMQp6jj+Y/oKpeO7xE8PON4y6fd9/lNdtVOUEkc9OynqXPB+qG90SykEjOPsihmU4IOOf1zXSpLJLNuSdthfqw5+8f/AIqvLfAN+YdPuLdS3yONoHbII59sj9a6kalds24/NycEHP8AdNeVBcujPSqK7ujpr+RnsoUaVH3TwAj0+ZSf/Qaie7CQD2A/9B/+vWBf3rR29srKY2+0Jz1xjeev4U621MTAZPQcD8D/AIV2wirWOKadzoIZzuyTg5/qtMurzy7f73O3t9GqtbTBpMlgeSf1WqmoT722hs/5aqVO8rGaehZtbhpmOWJH9PlpkxCk8+vOaZbERQlj97H9FqO8uNkZPr/8VWVSPvaI6Kb0MfxHfbYXjDdc9Pqf8K8x1/X1a8/sm02s6IGnf+5noPqev0+tX/iZ4zXw/pMt0EM9w5EdvADzLIc7V/qT2AJrhvDYm0rS/M1GZLi/mYyzTAY3u3XHt0AHoBXmZpj3gqPs6b96X4I9bAYX20+aS0Rq+adNjO51VPU9fbHvVSVNR1pyHl+xWxzgYy5/Dt+NWoInupvOlA3D7iN/D7/WpJ2Fs3mBhxjq23HvmvzxSZ9Y30Og0PUJNO0/7DZbbS3K4kMIw83u79T9M49BU1wqeUCzfMBx7Vh2H226kBhi8pMY3yHCj6Dqa220BJoibm5kuHI/1Y+RPyHP61pKcp/E2zmXuvTQi03XEgu9sBMk5+XykG4kd813Hhee+udTjDwNECCqAleQevQ9AOfwrkrDbZ7RDGkapzsCgA12XhO3vtavILiEmK0gbc9xtwq4zkA/xHg8D05r0MDf2sXbZl13FUpXfQ9gs2aG2MbHLgYZvfnP83/IV45+1JazH4VXV/AP31jcRT4P90nY3/oQr0iTUgn7mHJxkE55Jxz/AOzfnWB8WtHn174V+KbaRFG6wlZSxxyu5v5qK+qqUWqcubqj5PnUp3P/2Q==";

const VOICE_RULES = `VOICE & STYLE ‚Äî Julian's Chapter Style (JCS). Follow every rule below.

VOICE:
- Calm, authoritative, and slightly dangerous
- Rory Sutherland-adjacent: contrarian, behavioural, insightful ‚Äî never imitative
- Confident without aggression, sharp without cruelty
- Write like a senior operator who has seen the game from every angle and finds some of its absurdities almost funny

STYLE:
- Mix short punchy sentences with longer ones. Vary rhythm. Never monotone staccato.
- Reframe before explaining. Show the reader the angle they did not expect.
- The sharpest observation can be delivered as an aside. Do not overemphasise. Let the reader feel the cut.
- Use analogies from outside hospitality when they illuminate ‚Äî behavioural science, economics, psychology, everyday life

CONTENT:
- Use real facts and behavioural observations. Evidence supports insight, never overwhelms.
- Translate every fact into what it means for operators running real businesses.
- Pressure is structural, not moral. No blame. Hospitality is "the Food Game" ‚Äî unequal, difficult, playable.
- Assume readers are experienced. Write toward solutions without giving them. No frameworks or checklists.
- Name what people know but do not say.

GAME ANGLE RULES:
- The Game Angle is the signature line. It must reframe the story so the reader sees something they did not see before.
- Think like Rory Sutherland: the interesting answer is almost never the obvious one. If everyone blames costs, ask what the real constraint is. If everyone celebrates growth, ask who is quietly losing. The best angle is the one that makes the obvious reading feel naive.
- Find the absurdity: where does rational behaviour at the individual level produce irrational outcomes at the system level? Where does a policy designed to help actually punish the people it targets? Where does the industry reward the wrong thing and then act surprised by the result?
- Use analogies from outside hospitality to make the point land. Compare a hospitality trap to airline pricing, to dating, to how supermarkets arrange shelves, to why people queue for brunch but not dinner. The best reframe borrows a lens from somewhere the reader was not expecting.
- Do NOT name psychological biases by their textbook terms (no "loss aversion", "status quo bias", "anchoring", etc). Instead, show the bias operating without labelling it. The reader should feel the mechanism, not read a Wikipedia entry.
- 2 to 3 sentences minimum. The first sentence flips the obvious reading. The second sentence shows the real dynamic operating in the specific story. The third sentence (if needed) lands the implication for operators.
- Bad: "This shows how regulation affects hospitality." Bad: "Operators need to adapt to change." These are empty.
- Good: "Every compliance cost that does not touch the customer is a tax on survival disguised as safety. The operator who spends Tuesday afternoon on paperwork instead of fixing the lunch service is not being responsible. They are being trained to mistake process for progress."
- Good: "The ghost kitchen pivot is the restaurant industry's version of the gym membership model in reverse. Delivery platforms sold operators on removing the dining room the same way gyms sell memberships to people who never show up. The money was in the abstraction, not the service. Now that operators want the customer back in the room, they are discovering that the room was the product all along."
- Good: "This is the hospitality equivalent of renovating your kitchen to increase the value of a house you cannot afford to keep. The fitout looks great on Instagram. The P&L tells a different story. The market rewards the appearance of success right up until it does not."
- Make the reader see their own situation differently. That is the test.

MECHANICAL:
- No em dashes (use commas, full stops, or restructure)
- No contractions ("is not" not "isn't", "do not" not "don't")
- No consultant jargon`;
const TODAY = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD THIS ISSUE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBuildModal() {
  buildMasterList = [];
  buildSelected = {};
  buildWritten = [];
  const modal = document.getElementById('buildModal');
  // Reset to scan phase
  document.getElementById('buildPhase1').style.display = 'block';
  document.getElementById('buildPhase2').style.display = 'none';
  document.getElementById('buildPhase3').style.display = 'none';
  document.getElementById('buildScanLog').innerHTML = '';
  document.getElementById('buildBar').style.width = '0%';
  document.getElementById('buildMasterList').innerHTML = '';
  document.getElementById('buildWrittenList').innerHTML = '';
  // Pre-fill issue fields
  const num = document.getElementById('issueNumber').value;
  const date = document.getElementById('issueDate').value;
  if (num) document.getElementById('buildIssueNum').value = num;
  if (date) document.getElementById('buildIssueDate').value = date;
  modal.classList.add('active');
}

function buildBackToPhase1() {
  document.getElementById('buildPhase2').style.display = 'none';
  document.getElementById('buildPhase1').style.display = 'block';
}

function buildBackToPhase2() {
  if (buildWritten.length > 0 && !confirm('Going back will discard written stories. Continue?')) return;
  buildWritten = [];
  document.getElementById('buildPhase3').style.display = 'none';
  document.getElementById('buildPhase2').style.display = 'block';
  document.getElementById('buildWriteBtn').disabled = false;
}

function closeBuildModal() {
  document.getElementById('buildModal').classList.remove('active');
}

async function runScan() {
  const btn = document.getElementById('buildScanBtn');
  const focus = document.getElementById('buildFocus').value.trim();
  btn.disabled = true;
  btn.textContent = 'Scanning...';
  document.getElementById('buildScanLog').innerHTML = '';
  setProgress('buildBar', 5);

  await waitForRateLimit('buildScanLog');

  // Determine date mode and build appropriate search instructions
  const friday = selectedDate || nearestUpcomingFriday();
  const mode = classifyDate(friday);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fridayLabel = friday.getDate() + ' ' + months[friday.getMonth()] + ' ' + friday.getFullYear();
  const weekStart = new Date(friday); weekStart.setDate(friday.getDate() - 6);
  const weekStartLabel = weekStart.getDate() + ' ' + months[weekStart.getMonth()] + ' ' + weekStart.getFullYear();

  let modeInstruction, modeBanner;

  if (mode === 'future') {
    aiLog('buildScanLog', 'Future date detected ‚Äî searching current week instead.', 'active');
    modeInstruction = 'Scan Australian news published in the past 7 days ending today (' + TODAY + ').';
    modeBanner = 'Note: The issue date is set to a future date. Searching the current week instead.';
  } else if (mode === 'current') {
    modeInstruction = 'Scan Australian news published in the 7 days ending ' + fridayLabel + ' (' + weekStartLabel + ' to ' + fridayLabel + ').';
    modeBanner = '';
  } else if (mode === 'historical') {
    modeInstruction = 'Search for Australian news articles that were published during the specific week of ' + weekStartLabel + ' to ' + fridayLabel + '. This is a historical issue ‚Äî find articles from that actual date range, not recent articles. Search for archived content from that period.';
    modeBanner = 'Historical mode: sourcing articles from the week of ' + weekStartLabel + ' to ' + fridayLabel + '. URLs may need verification.';
  } else {
    // retrospective
    modeInstruction = 'This is a retrospective issue for the week ending ' + fridayLabel + '. That date is more than 8 weeks in the past. Reconstruct the major Australian hospitality and economics stories from that week using your knowledge of that period and any archived sources available. For each story, attempt to find a real URL but mark uncertain ones clearly in the relevance field. Prioritise accuracy of content over URL certainty.';
    modeBanner = 'Retrospective mode: beyond reliable search range. Commentary will be strong ‚Äî verify every URL independently.';
  }

  if (modeBanner) aiLog('buildScanLog', modeBanner, mode === 'retrospective' ? 'error' : 'active');
  else aiLog('buildScanLog', 'Scanning week of ' + weekStartLabel + ' to ' + fridayLabel + '...', 'active');

  const focusLine = focus ? '\nThe editor wants to focus this issue on: ' + focus + '. Weight the selection toward this theme but do not exclude other significant stories.' : '';
  const prompt = `You are a research editor for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}. Issue covers week ending ${fridayLabel}.

${modeInstruction}

SCAN IN TWO PASSES:

PASS 1 ‚Äî MUST-SCAN SOURCES. Check these first:

Hospitality: Hospitality Magazine (hospitalitymagazine.com.au), PubTIC (pubtic.com.au), Australian Hotelier/TheShout (theshout.com.au), Bars and Clubs (intermedia.com.au), Australian Hospitality Directory (hospitalitydirectory.com.au), Venue Magazine (venue.net.au), Restaurant & Catering Australia (rca.asn.au), Australian Hotels Association (aha.org.au), Accommodation Australia (accommodationaustralia.com.au), Future Food (futurefood.com.au), Shopping Centre News (shoppingcentrenews.com.au)

Economics & Policy: AFR (afr.com), The Australian (theaustralian.com.au), The Conversation AU (theconversation.com/au), RBA (rba.gov.au), ABS (abs.gov.au), Fair Work (fairwork.gov.au), AFGC (afgc.org.au), Inside Retail (insideretail.com.au), Jobs & Skills Australia (jobsandskills.gov.au)

Supply Chain: Food & Drink Business (foodanddrinkbusiness.com.au), Food & Beverage Industry News (foodmag.com.au)

PASS 2 ‚Äî BROADER WEB. Search beyond the must-scan list: ABC, Guardian Australia, SMH, The Age, news.com.au, Broadsheet, Good Food, TimeOut, Delicious, state/regional media, and any other credible source.

RANKING ‚Äî From both passes, select the top 12. Rank by:
1. OPERATOR IMPACT ‚Äî How directly does this affect an independent hospitality operator's costs, revenue, decisions, or risk?
2. TIMELINESS ‚Äî Breaking, developing, or slow-burn reaching a decision point?
3. SYSTEMS SIGNIFICANCE ‚Äî Does it reveal a pattern in how the industry works, fails, or changes?
4. UNIQUENESS ‚Äî No duplicate angles. If multiple outlets covered it, pick the best source.

Final 12 should be approximately 8 hospitality (restaurants, hotels, cafes, bars, pubs, venues, operators, chefs, workforce, licensing, food trends) and 4 economics (rates, wages, inflation, spending, employment, policy affecting hospitality).
${focusLine}

For each story find the real article with direct URL (not a homepage).

CRITICAL: Respond ONLY with a valid JSON array. No preamble, no markdown. Start with [ end with ].
[{"headline":"exact headline from source","url":"https://direct-article-url","source":"Publication Name","section":"Industry","relevance":"one sentence on why this matters to operators"}]`;

  try {
    const raw = await callClaude(prompt, 'Scan Australian hospitality and economics news. Return top 12 stories as JSON array only.', 3000, true);
    buildMasterList = JSON.parse(raw);
    if (!Array.isArray(buildMasterList) || buildMasterList.length === 0) throw new Error('Empty list');

    setProgress('buildBar', 100);
    aiLog('buildScanLog', buildMasterList.length + ' stories found. Select 4 to 6 below.', 'done');

    // Auto-save scan to archive
    saveScanToArchive(buildMasterList, fridayLabel);

    renderMasterList();
    startCooldown(120);
    document.getElementById('buildPhase1').style.display = 'none';
    document.getElementById('buildPhase2').style.display = 'block';

  } catch(err) {
    aiLog('buildScanLog', 'Scan failed: ' + err.message + '. Try again.', 'error');
    startCooldown(120);
    btn.disabled = false;
    btn.textContent = 'Scan this week\'s news';
  }
}

function renderMasterList() {
  const container = document.getElementById('buildMasterList');
  container.innerHTML = buildMasterList.map(function(s, i) {
    const tagColor = s.section === 'Economics' ? '#1565c0' : '#880e4f';
    const tagBg = s.section === 'Economics' ? 'rgba(21,101,192,0.2)' : 'rgba(136,14,79,0.2)';
    return '<div class="master-card" id="mcard-' + i + '">'
      + '<div class="master-card-top">'
      + '<label class="master-check">'
      + '<input type="checkbox" onchange="toggleStory(' + i + ')" id="mcheck-' + i + '"/> '
      + '<span class="master-headline">' + escapeHtml(s.headline) + '</span>'
      + '</label>'
      + '<span class="master-tag" style="background:' + tagBg + ';color:' + tagColor + ';">' + escapeHtml(s.section) + '</span>'
      + '</div>'
      + '<div class="master-source">' + escapeHtml(s.source) + ' &nbsp;¬∑&nbsp; <a href="' + encodeURI(s.url||'#') + '" target="_blank" rel="noopener" style="color:#e91e8c;">Test link ‚Üó</a></div>'
      + '<div class="master-relevance">' + escapeHtml(s.relevance) + '</div>'
      + '<div class="master-classify" id="mclassify-' + i + '" style="display:none;">'
      + '<span style="font-size:10px;color:rgba(138,154,181,0.6);text-transform:uppercase;letter-spacing:1px;margin-right:10px;">Publish as</span>'
      + '<label class="classify-opt"><input type="radio" name="classify-' + i + '" value="industry" checked onchange="setClassify(' + i + ',\'industry\')"> Industry</label>'
      + '<label class="classify-opt"><input type="radio" name="classify-' + i + '" value="economics" onchange="setClassify(' + i + ',\'economics\')"> Economics</label>'
      + '<label class="classify-opt"><input type="radio" name="classify-' + i + '" value="deepdive" onchange="setClassify(' + i + ',\'deepdive\')"> Deep Dive</label>'
      + '</div>'
      + '</div>';
  }).join('');
}

function toggleStory(i) {
  const checked = document.getElementById('mcheck-' + i).checked;
  const classifyEl = document.getElementById('mclassify-' + i);
  const card = document.getElementById('mcard-' + i);

  if (checked) {
    // Default classification based on AI suggestion
    const defaultClass = (buildMasterList[i].section || 'Industry').toLowerCase();
    buildSelected[i] = defaultClass;
    // Pre-select the matching radio
    const radio = document.querySelector('input[name="classify-' + i + '"][value="' + defaultClass + '"]');
    if (radio) radio.checked = true;
    classifyEl.style.display = 'flex';
    card.style.borderColor = 'rgba(233,30,140,0.5)';
    card.style.background = 'rgba(233,30,140,0.05)';
  } else {
    delete buildSelected[i];
    classifyEl.style.display = 'none';
    card.style.borderColor = 'rgba(244,167,185,0.12)';
    card.style.background = 'rgba(255,255,255,0.04)';
  }
  updateSelectionCount();
}

function setClassify(i, val) {
  // Only one deep dive allowed
  if (val === 'deepdive') {
    Object.keys(buildSelected).forEach(function(k) {
      if (buildSelected[k] === 'deepdive' && parseInt(k) !== i) {
        buildSelected[k] = (buildMasterList[k].section || 'Industry').toLowerCase();
        const radio = document.querySelector('input[name="classify-' + k + '"][value="' + buildSelected[k] + '"]');
        if (radio) radio.checked = true;
      }
    });
  }
  buildSelected[i] = val;
  updateSelectionCount();
}

function updateSelectionCount() {
  const count = Object.keys(buildSelected).length;
  const countEl = document.getElementById('buildSelectionCount');
  if (countEl) countEl.textContent = count + ' selected';
  const writeBtn = document.getElementById('buildWriteBtn');
  if (writeBtn) writeBtn.disabled = count < 2 || count > 7;
}

async function runWriteSelected() {
  const indices = Object.keys(buildSelected);
  if (indices.length < 2) return;

  document.getElementById('buildPhase2').style.display = 'none';
  document.getElementById('buildPhase3').style.display = 'block';
  document.getElementById('buildWriteLog').innerHTML = '';
  setProgress('buildWriteBar', 0);
  buildWritten = [];
  window.buildFailed = [];
  document.getElementById('buildRetryBtn').style.display = 'none';

  const writeBtn = document.getElementById('buildWriteBtn');
  if (writeBtn) writeBtn.disabled = true;

  // Set issue number/date
  const num = document.getElementById('buildIssueNum').value.trim();
  const date = document.getElementById('buildIssueDate').value.trim();
  if (num) document.getElementById('issueNumber').value = num;
  if (date) document.getElementById('issueDate').value = date;

  // Smart rate limit wait before first write
  await waitForRateLimit('buildWriteLog');

  for (let idx = 0; idx < indices.length; idx++) {
    const i = parseInt(indices[idx]);
    const story = buildMasterList[i];
    const classification = buildSelected[i];
    const pct = Math.round(10 + (idx / indices.length) * 85);
    setProgress('buildWriteBar', pct);

    // Rate limit delay between stories (not before first one)
    if (idx > 0) {
      aiLog('buildWriteLog', 'Preparing next story... (' + (idx + 1) + '/' + indices.length + ')', 'active');
      await waitForRateLimit('buildWriteLog');
    }

    aiLog('buildWriteLog', 'Writing ' + classification + ': ' + story.headline.substring(0, 55) + '...', 'active');

    try {
      let written;
      if (classification === 'deepdive') {
        written = await writeDeepDive(story);
      } else {
        written = await writeNewsStory(story, classification);
      }
      written.classification = classification;
      buildWritten.push(written);
      aiLog('buildWriteLog', 'Done: ' + (written.headline||'').substring(0, 55) + '...', 'done');
    } catch(err) {
      aiLog('buildWriteLog', 'Failed: ' + story.headline.substring(0, 40) + '. Error: ' + (err.message || err).toString().substring(0, 150), 'error');
      console.error('Write failed for:', story.headline, err);
      if (!window.buildFailed) window.buildFailed = [];
      window.buildFailed.push({ index: i, story: story, classification: classification });
    }
  }

  setProgress('buildWriteBar', 100);
  startCooldown(120);
  const failCount = (window.buildFailed || []).length;
  if (failCount > 0) {
    aiLog('buildWriteLog', buildWritten.length + ' written, ' + failCount + ' failed.', failCount > 0 ? 'error' : 'done');
    document.getElementById('buildRetryBtn').style.display = '';
  } else {
    aiLog('buildWriteLog', 'All done. ' + buildWritten.length + ' stories written.', 'done');
  }
  renderWrittenPreview();
}

async function retryFailedWrites() {
  if (!window.buildFailed || window.buildFailed.length === 0) return;
  const failures = [...window.buildFailed];
  window.buildFailed = [];
  document.getElementById('buildRetryBtn').style.display = 'none';

  aiLog('buildWriteLog', 'Retrying ' + failures.length + ' failed stories...', 'active');
  await waitForRateLimit('buildWriteLog');

  for (let idx = 0; idx < failures.length; idx++) {
    const { story, classification } = failures[idx];

    if (idx > 0) {
      aiLog('buildWriteLog', 'Preparing next retry... (' + (idx + 1) + '/' + failures.length + ')', 'active');
      await waitForRateLimit('buildWriteLog');
    }

    aiLog('buildWriteLog', 'Retrying ' + classification + ': ' + story.headline.substring(0, 55) + '...', 'active');

    try {
      let written;
      if (classification === 'deepdive') {
        written = await writeDeepDive(story);
      } else {
        written = await writeNewsStory(story, classification);
      }
      written.classification = classification;
      buildWritten.push(written);
      aiLog('buildWriteLog', 'Done: ' + (written.headline||'').substring(0, 55) + '...', 'done');
    } catch(err) {
      aiLog('buildWriteLog', 'Retry failed: ' + story.headline.substring(0, 40) + '. Error: ' + (err.message || err).toString().substring(0, 150), 'error');
      window.buildFailed.push({ story: story, classification: classification });
    }
  }

  const stillFailed = (window.buildFailed || []).length;
  if (stillFailed > 0) {
    aiLog('buildWriteLog', stillFailed + ' still failed. You can retry again.', 'error');
    document.getElementById('buildRetryBtn').style.display = '';
  } else {
    aiLog('buildWriteLog', 'All retries succeeded. ' + buildWritten.length + ' stories total.', 'done');
  }
  renderWrittenPreview();
}

async function fetchArticleText(url) {
  try {
    const PROXY_URL = 'https://young-fog-3045fgww-proxy.julian-68d.workers.dev';
    const PROXY_SECRET = 'foodgame2026';
    const response = await fetch(PROXY_URL + '?fetch=' + encodeURIComponent(url), {
      headers: { 'X-FGWW-Auth': PROXY_SECRET }
    });
    if (!response.ok) return '';
    const html = await response.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    doc.querySelectorAll('script,style,nav,footer,header,aside,form,iframe').forEach(el => el.remove());
    const text = (doc.body ? doc.body.textContent : '').replace(/\s+/g, ' ').trim();
    return text.substring(0, 2000);
  } catch(e) {
    console.warn('Could not fetch article:', url, e);
    return '';
  }
}

async function writeNewsStory(story, section) {
  const sectionLabel = section === 'economics' ? 'Economics' : 'Industry';
  const articleText = await fetchArticleText(story.url);
  const articleContext = articleText
    ? '\nARTICLE TEXT (use this as primary source):\n' + articleText
    : '\n(Article could not be fetched. Write based on headline, source, and your knowledge.)';
  const prompt = `You are a staff writer for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

${VOICE_RULES}

Write a complete news story entry for this REAL article:
Headline: ${story.headline}
Source: ${story.source}
URL: ${story.url}
Section: ${sectionLabel}
${articleContext}

COMMENTARY: 3 short paragraphs separated by double newline. Total commentary must be 120 to 150 words. Be direct. No filler.
- Paragraph 1: What happened and the key facts (2-3 sentences)
- Paragraph 2: Why it matters to Australian hospitality operators (2-3 sentences)
- Paragraph 3: What to do or watch now (1-2 sentences)

GAME ANGLE: 2 to 3 sentences. The signature reframe. Flip the obvious reading of this story. Use an analogy from outside hospitality if it makes the point land harder. Show the hidden dynamic without naming any psychological bias by its textbook term. Make the reader see their own situation differently.
Example: "The ghost kitchen pivot is the restaurant industry's version of the gym membership model in reverse. The money was in the abstraction, not the service. Now that operators want the customer back in the room, they are discovering that the room was the product all along."

Return ONLY valid JSON, no markdown:
{"headline":"${story.headline}","url":"${story.url}","source":"${story.source}","commentary":"para 1\\n\\npara 2\\n\\npara 3","angle":"2-3 sentences. Flip the obvious reading. Use an unexpected analogy. Make the reader pause."}`;

  const raw = await callClaude(prompt, 'Write the story entry. Keep commentary to 120-150 words. Return JSON only.', 1400, true);
  return JSON.parse(raw);
}

async function writeDeepDive(story) {
  const articleText = await fetchArticleText(story.url);
  const articleContext = articleText
    ? '\nARTICLE TEXT (use this as primary source):\n' + articleText
    : '\n(Article could not be fetched. Write based on headline, source, and your knowledge.)';
  const prompt = `You are a senior staff writer for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

${VOICE_RULES}

Write a complete Deep Dive feature based on this REAL article as the hook:
Headline: ${story.headline}
Source: ${story.source}
URL: ${story.url}
${articleContext}

The Deep Dive goes beyond the news event into the systems-level analysis. It is the signature piece: long-form, a clear point of view, practical implications for operators.

STRUCTURE:
- headline: a strong editorial title (not a news headline)
- deck: one sentence that carries the weight of the whole piece
- body: 400 to 500 words. 5 to 6 paragraphs with double newline between. Open with the real situation from the article, build the systems analysis, name what operators get wrong, give a clear strategic read.
- takeaway: 1 to 2 sentences. The single most actionable conclusion.
- angle: The Game Angle. 2 to 3 sentences. Flip the obvious reading of this feature. Use an analogy from outside hospitality if it sharpens the point. Show where rational behaviour produces an absurd outcome without naming any psychological bias by its textbook term. Should feel like the smartest, most uncomfortable observation in the room. Make the reader see their own situation differently.
- source_url: "${story.url}"

Return ONLY valid JSON, no markdown:
{"headline":"...","deck":"...","body":"para 1\\n\\npara 2\\n\\n...","takeaway":"...","angle":"...","source_url":"${story.url}"}`;

  const raw = await callClaude(prompt, 'Write the complete Deep Dive. Return JSON only.', 2000, true);
  return JSON.parse(raw);
}

function renderWrittenPreview() {
  const container = document.getElementById('buildWrittenList');
  container.innerHTML = buildWritten.map(function(s, i) {
    const cls = s.classification;
    const tagLabel = cls === 'deepdive' ? 'Deep Dive' : cls === 'economics' ? 'Economics' : 'Industry';
    const tagClass = cls === 'economics' ? 'economics' : cls === 'deepdive' ? 'deepdive' : 'industry';
    const preview = cls === 'deepdive'
      ? (s.deck || (s.body||'').substring(0, 120))
      : (s.commentary||'').split('\n\n')[0];
    const urlDisplay = (s.source_url || s.url) ? '<a href="' + (s.source_url||s.url) + '" target="_blank" rel="noopener" style="color:#e91e8c;font-size:10px;">Test link ‚Üó</a>' : '';
    return '<div class="build-result-card">'
      + '<span class="build-result-tag ' + tagClass + '">' + tagLabel + '</span>'
      + '<div class="build-result-headline">' + escapeHtml(s.headline||'') + '</div>'
      + '<div class="build-result-url">' + urlDisplay + ' &nbsp;' + escapeHtml(s.source||'') + '</div>'
      + '<div class="build-result-preview">' + escapeHtml((preview||'').substring(0, 200)) + '...</div>'
      + '</div>';
  }).join('');

  document.getElementById('buildLoadBtn').style.display = 'block';
}

function loadAllIntoEditor() {
  // Warn if there's existing content that will be overwritten
  const existingNews = document.getElementById('newsItems').querySelectorAll('.news-item').length;
  const existingEcon = document.getElementById('econItems').querySelectorAll('.news-item').length;
  if (existingNews > 0 || existingEcon > 0) {
    if (!confirm('This will replace the ' + (existingNews + existingEcon) + ' stories currently in the editor. Continue?')) return;
  }

  document.getElementById('newsItems').innerHTML = '';
  document.getElementById('econItems').innerHTML = '';

  buildWritten.forEach(function(s) {
    const cls = s.classification;
    if (cls === 'deepdive') {
      console.log('[LOAD DEBUG] Deep Dive story found in buildWritten:', JSON.stringify({headline: s.headline, deck: s.deck, body_length: (s.body||'').length, url: s.source_url||s.url, angle_length: (s.angle||'').length}));
      if (s.headline) document.getElementById('deepTitle').value = s.headline;
      if (s.source_url || s.url) {
        document.getElementById('deepUrl').value = s.source_url || s.url;
        var deepTestLink = document.getElementById('deepUrl').nextElementSibling;
        if (deepTestLink && deepTestLink.tagName === 'A') { deepTestLink.href = s.source_url || s.url; deepTestLink.style.display = 'inline-block'; }
      }
      if (s.deck)     document.getElementById('deepDeck').value = s.deck;
      if (s.body)     document.getElementById('deepBody').value = s.body;
      if (s.takeaway) document.getElementById('deepTakeaway').value = s.takeaway;
      if (s.angle)    document.getElementById('deepGameAngle').value = s.angle;
    } else {
      const containerId = cls === 'economics' ? 'econItems' : 'newsItems';
      const type = cls === 'economics' ? 'Economics' : 'Industry';
      addNewsItem(containerId, type, {
        headline: s.headline || '',
        url: s.source_url || s.url || '',
        blurb: s.commentary || '',
        ref: '',
        angle: s.angle || ''
      });
    }
  });

  var deepDiveCount = buildWritten.filter(function(s){ return s.classification === 'deepdive'; }).length;
  console.log('[LOAD DEBUG] Total stories loaded:', buildWritten.length, '| Deep Dives:', deepDiveCount);
  if (deepDiveCount === 0) console.warn('[LOAD DEBUG] ‚ö†Ô∏è No story was classified as Deep Dive ‚Äî deep dive section will be empty');
  console.log('[LOAD DEBUG] deepTitle field value after load:', JSON.stringify(document.getElementById('deepTitle').value));

  updateBadge();
  updateCounts();
  closeBuildModal();
  hideEmptyState();
  // Show preview and archive buttons now that content exists
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  switchPanel('news', document.querySelector('[data-panel="news"]'));
  showToast(buildWritten.length + ' stories loaded. Review each section, then click Preview.');
  updateWorkflow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMUNITY SPOTLIGHT FINDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSpotlightFinder() {
  communityList = [];
  communitySelected = null;
  document.getElementById('spotlightPhase1').style.display = 'block';
  document.getElementById('spotlightPhase2').style.display = 'none';
  document.getElementById('spotlightPhase3').style.display = 'none';
  document.getElementById('spotlightScanLog').innerHTML = '';
  document.getElementById('spotlightCandidates').innerHTML = '';
  document.getElementById('spotlightWritten').innerHTML = '';
  document.getElementById('spotlightBar').style.width = '0%';
  document.getElementById('spotlightFinder').classList.add('active');
}

function closeSpotlightFinder() {
  document.getElementById('spotlightFinder').classList.remove('active');
}

async function runSpotlightScan() {
  const query = document.getElementById('spotlightQuery').value.trim();
  const btn = document.getElementById('spotlightScanBtn');
  btn.disabled = true;
  btn.textContent = 'Scanning...';
  document.getElementById('spotlightScanLog').innerHTML = '';
  setProgress('spotlightBar', 5);

  const searchLine = query
    ? 'Focus the search on: ' + query + '.'
    : 'Do a broad scan across Australian hospitality for anything genuinely interesting right now.';

  aiLog('spotlightScanLog', 'Scanning Australian hospitality for spotlight candidates...', 'active');

  // Wait for rate limit before API call ‚Äî show countdown in the log
  var elapsed = Date.now() - lastApiCallTime;
  if (lastApiCallTime > 0 && elapsed < API_COOLDOWN_MS) {
    var waitSec = Math.ceil((API_COOLDOWN_MS - elapsed) / 1000);
    aiLog('spotlightScanLog', 'Rate limit cooldown: waiting ' + waitSec + 's before scanning...', 'active');
  }
  await waitForRateLimit('spotlightScanLog');
  aiLog('spotlightScanLog', 'Calling AI to find spotlight candidates...', 'active');
  setProgress('spotlightBar', 15);

  const prompt = `You are a research editor for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

Find 4 REAL Australian hospitality operators, venues, chefs, or initiatives that are doing something genuinely interesting and worth the industry's attention right now. ${searchLine}

These must be real named people, venues, or initiatives that exist and can be verified. Look for recent news, openings, awards, innovative concepts, community impact, or operators navigating current challenges in interesting ways.

Return ONLY valid JSON array, no markdown:
[
  {"name":"Real name of person/venue/initiative","location":"City or region","category":"Independent Restaurant / Hotel / Bar / Consultancy / etc","hook":"one sentence on what makes them worth spotlighting right now"},
  ...4 items...
]`;

  try {
    const raw = await callClaude(prompt, 'Find 4 real Australian hospitality spotlight candidates. Return JSON array only.', 1500, true);
    communityList = JSON.parse(raw);
    if (!Array.isArray(communityList) || communityList.length === 0) throw new Error('Empty list');

    setProgress('spotlightBar', 100);
    aiLog('spotlightScanLog', communityList.length + ' candidates found. Pick one.', 'done');
    renderSpotlightCandidates();
    document.getElementById('spotlightPhase1').style.display = 'none';
    document.getElementById('spotlightPhase2').style.display = 'block';

  } catch(err) {
    aiLog('spotlightScanLog', 'Scan failed: ' + err.message + '. Try again.', 'error');
    btn.disabled = false;
    btn.textContent = 'Find spotlight candidates';
  }
}

function renderSpotlightCandidates() {
  const container = document.getElementById('spotlightCandidates');
  container.innerHTML = communityList.map(function(c, i) {
    return '<div class="master-card" style="cursor:pointer;" onclick="selectCandidate(' + i + ')">'
      + '<div class="master-card-top">'
      + '<span class="master-headline">' + escapeHtml(c.name) + '</span>'
      + '<span class="master-tag" style="background:rgba(76,175,80,0.15);color:#81c784;">' + escapeHtml(c.category) + '</span>'
      + '</div>'
      + '<div class="master-source">' + escapeHtml(c.location) + '</div>'
      + '<div class="master-relevance">' + escapeHtml(c.hook) + '</div>'
      + '<button class="ai-result-use-btn" style="margin-top:8px;" onclick="event.stopPropagation();selectCandidate(' + i + ')">Write this spotlight</button>'
      + '</div>';
  }).join('');
}

async function selectCandidate(i) {
  communitySelected = communityList[i];
  document.getElementById('spotlightPhase2').style.display = 'none';
  document.getElementById('spotlightPhase3').style.display = 'block';
  document.getElementById('spotlightWritten').innerHTML = '<div class="ai-finder-status">Writing the spotlight for ' + escapeHtml(communitySelected.name) + '...</div>';
  setProgress('spotlightBar', 30);

  // Wait for rate limit before API call ‚Äî show countdown
  var elapsed = Date.now() - lastApiCallTime;
  if (lastApiCallTime > 0 && elapsed < API_COOLDOWN_MS) {
    var waitSec = Math.ceil((API_COOLDOWN_MS - elapsed) / 1000);
    document.getElementById('spotlightWritten').innerHTML = '<div class="ai-finder-status">Rate limit cooldown: waiting ' + waitSec + 's before writing...</div>';
    await waitForRateLimit(null);
    document.getElementById('spotlightWritten').innerHTML = '<div class="ai-finder-status">Writing the spotlight for ' + escapeHtml(communitySelected.name) + '...</div>';
  }

  const c = communitySelected;
  const prompt = `You are a staff writer for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

${VOICE_RULES}
Also: write warmly but specifically. Make the subject real and three-dimensional. Avoid generic praise.

Write a complete Community Spotlight entry for this real Australian hospitality subject:
Name: ${c.name}
Location: ${c.location}
Category: ${c.category}
What makes them interesting: ${c.hook}

STORY: 3 paragraphs with double newline between:
- Paragraph 1: Who they are, what they do, and what makes it notable right now
- Paragraph 2: Why it matters to the wider industry at this moment
- Paragraph 3: What other operators can take from their approach

Return ONLY valid JSON, no markdown:
{"name":"${c.name}","story":"para 1\\n\\npara 2\\n\\npara 3","location":"${c.location}","category":"${c.category}"}`;

  try {
    const raw = await callClaude(prompt, 'Write the complete Community Spotlight. Return JSON only.', 1000, false);
    const r = JSON.parse(raw);
    setProgress('spotlightBar', 100);

    const preview = (r.story||'').split('\n\n')[0];
    _staged.spotlight = r;
    document.getElementById('spotlightWritten').innerHTML =
      '<div class="ai-result-card">'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#81c784;font-weight:700;margin-bottom:8px;">Spotlight Preview. Review before loading.</div>'
      + '<div class="ai-result-headline" style="font-size:15px;">' + escapeHtml(r.name||c.name) + '</div>'
      + '<div style="font-size:11px;color:rgba(138,154,181,0.7);margin-bottom:10px;">' + escapeHtml(c.location) + ' &nbsp;¬∑&nbsp; ' + escapeHtml(c.category) + '</div>'
      + '<div class="ai-result-desc">' + escapeHtml(preview) + '</div>'
      + '<button class="ai-result-use-btn" onclick="loadSpotlight(_staged.spotlight)" style="margin-top:12px;padding:8px 18px;font-size:11px;">Load into editor ‚Üí</button>'
      + '<button class="ai-result-use-btn" onclick="document.getElementById(\'spotlightPhase2\').style.display=\'block\';document.getElementById(\'spotlightPhase3\').style.display=\'none\';" style="margin-top:12px;margin-left:8px;padding:8px 18px;font-size:11px;background:rgba(255,255,255,0.1);">Pick a different one</button>'
      + '</div>';

  } catch(err) {
    document.getElementById('spotlightWritten').innerHTML = '<div class="ai-finder-status">Could not write the spotlight. Try a different candidate.</div>';
  }
}

function loadSpotlight(r) {
  if (r.name)     document.getElementById('spotlightName').value = r.name;
  if (r.story)    document.getElementById('spotlightStory').value = r.story;
  if (r.url) {
    document.getElementById('spotlightUrl').value = r.url;
    var stl = document.getElementById('spotlightUrl').nextElementSibling;
    if (stl && stl.tagName === 'A') { stl.href = r.url; stl.style.display = 'inline-block'; }
  }
  if (r.location) document.getElementById('spotlightLocation').value = r.location;
  if (r.category) document.getElementById('spotlightCategory').value = r.category;
  updateCounts();
  closeSpotlightFinder();
  switchPanel('spotlight', document.querySelector('[data-panel="spotlight"]'));
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  showToast('Spotlight loaded. Verify the subject is real and accurate before publishing.');
  updateWorkflow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEP DIVE FINDER (standalone - for when not using Build)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-BUILD HELPERS (used by Build This Issue flow)
async function autoWriteSpotlight() {
  // Scan for candidates
  const prompt1 = `You are a research editor for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

Find 4 REAL Australian hospitality operators, venues, chefs, or initiatives doing something genuinely interesting right now.
These must be real named people, venues, or initiatives that exist. Look for recent news, openings, awards, innovative concepts, community impact.

Return ONLY valid JSON array, no markdown:
[{"name":"Real name","location":"City","category":"Type","hook":"one sentence on why"}]`;

  const raw1 = await callClaude(prompt1, 'Find 4 real Australian hospitality spotlight candidates. Return JSON array only.', 1500, true);
  const candidates = JSON.parse(raw1);
  if (!Array.isArray(candidates) || candidates.length === 0) throw new Error('No candidates found');

  // Auto-select first candidate and write
  const c = candidates[0];
  await waitForRateLimit('buildWriteLog');

  const prompt2 = `You are a staff writer for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

${VOICE_RULES}
Also: write warmly but specifically. Make the subject real and three-dimensional. Avoid generic praise.

Write a complete Community Spotlight entry for this real Australian hospitality subject:
Name: ${c.name}
Location: ${c.location}
Category: ${c.category}
What makes them interesting: ${c.hook}

STORY: 3 paragraphs with double newline between:
- Paragraph 1: Who they are, what they do, and what makes it notable right now
- Paragraph 2: Why it matters to the wider industry at this moment
- Paragraph 3: What other operators can take from their approach

URL: A real, verifiable link for this subject ‚Äî their website, a news article about them, or their social media profile. Must be a genuine URL that exists.

Return ONLY valid JSON, no markdown:
{"name":"${c.name}","story":"para 1\\\\n\\\\npara 2\\\\n\\\\npara 3","url":"https://real-url-for-subject","location":"${c.location}","category":"${c.category}"}`;

  const raw2 = await callClaude(prompt2, 'Write the complete Community Spotlight. Return JSON only.', 1000, false);
  const r = JSON.parse(raw2);

  // Load into editor
  if (r.name)     document.getElementById('spotlightName').value = r.name;
  if (r.story)    document.getElementById('spotlightStory').value = r.story;
  if (r.location) document.getElementById('spotlightLocation').value = r.location;
  if (r.category) document.getElementById('spotlightCategory').value = r.category;
  updateCounts();
}

async function autoWriteEditorial() {
  const signoff = 'JCS';
  const summary = gatherStorySummary();
  const friday = selectedDate || nearestUpcomingFriday();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fridayLabel = friday.getDate() + ' ' + months[friday.getMonth()] + ' ' + friday.getFullYear();

  const prompt = `You are the editor-in-chief of Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}. This issue covers the week ending ${fridayLabel}.

Here is the full content of this week's issue:

${summary}

${VOICE_RULES}

Write the EDITORIAL INTRO and the ISSUE-WIDE GAME ANGLE for this issue.

EDITORIAL INTRO has three parts:
1. HOOK ‚Äî One punchy opening sentence. It frames the entire issue. Make the reader lean in.
2. BODY ‚Äî 2 to 4 sentences. Your editorial voice reading the week. What connects these stories. Why it matters right now. Do not summarise each story individually.
3. SIGN-OFF ‚Äî Use: "${signoff}"

ISSUE-WIDE GAME ANGLE:
This is the behavioural or systems-level insight that ties the whole issue together. 2 to 4 sentences. Name the pattern, not just events. Help the reader see something they would not see from reading the stories alone. Be specific and sharp.

CRITICAL: Return ONLY valid JSON, no markdown, no preamble. Start with { and end with }.
{"hook":"the opening sentence","body":"the editorial body","signoff":"${signoff}","angle":"the issue-wide game angle"}`;

  const raw = await callClaude(prompt, 'Write the editorial intro and issue-wide game angle. Return JSON only.', 1500, false);
  const r = JSON.parse(raw);

  // Load into editor
  if (r.hook) document.getElementById('introHook').value = r.hook;
  if (r.body) document.getElementById('introBody').value = r.body;
  if (r.signoff) document.getElementById('introSignoff').value = r.signoff;
  if (r.angle) document.getElementById('issueAngle').value = r.angle;
  updateCounts();
}

async function runAutoResources(btn) {
  const origText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Finding resources...';

  // Gather current issue context for relevance
  const summary = gatherStorySummary();

  const prompt = `You are a curator for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}.

Here is this week's issue content for context:
${summary.substring(0, 1500)}

Suggest 3 genuinely useful standing resources for Australian hospitality operators. These should be real, verifiable tools, guides, reports, or references that help operators run better businesses. They should be relevant to the themes in this week's issue where possible.

Each resource needs:
- title: clear name
- icon: one relevant emoji
- desc: 1-2 sentences on why it is useful and who should use it. Written in the newsletter voice ‚Äî direct, no fluff.
- url: a real, verifiable URL (government sites, industry bodies, established tools preferred)

Return ONLY valid JSON array, no markdown:
[{"title":"...","icon":"...","desc":"...","url":"..."}]`;

  try {
    await waitForRateLimit(null);
    const raw = await callClaude(prompt, 'Suggest 3 real Australian hospitality resources. Return JSON array only.', 1000, true);
    const resources = JSON.parse(raw);
    if (!Array.isArray(resources) || resources.length === 0) throw new Error('No resources returned');

    // Clear existing and load new
    document.getElementById('resourceItems').innerHTML = '';
    resources.forEach(function(r) {
      addResourceItem({ title: r.title, icon: r.icon, desc: r.desc, url: r.url });
    });
    showToast(resources.length + ' resources loaded. Verify links and edit before publishing.');
    updateWorkflow();
  } catch(err) {
    showToast('Resource suggestion failed: ' + (err.message || err).toString().substring(0, 80));
  }
  btn.disabled = false;
  btn.textContent = origText;
}

function openDeepDiveFinder() {
  document.getElementById('deepDiveQuery').value = '';
  document.getElementById('deepDiveResults').innerHTML = '';
  document.getElementById('deepDiveBtn').disabled = false;
  document.getElementById('deepDiveBtn').textContent = 'Find and write the Deep Dive';
  document.getElementById('deepDiveFinder').classList.add('active');
  document.getElementById('deepDiveQuery').focus();
}

async function runDeepDiveSearch() {
  const query = document.getElementById('deepDiveQuery').value.trim();
  if (!query) return;
  const btn = document.getElementById('deepDiveBtn');
  const results = document.getElementById('deepDiveResults');
  btn.disabled = true;
  btn.textContent = 'Researching and writing...';
  results.innerHTML = '<div class="ai-finder-status">Finding a real story and writing the full deep dive. This takes 20 to 40 seconds...</div>';

  try {
    const story = { headline: query, source: '', url: '' };
    const r = await writeDeepDive(story);

    _staged.deepdive = r;
    document.getElementById('deepDiveResults').innerHTML =
      '<div class="ai-result-card">'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#f4a7b9;font-weight:700;margin-bottom:10px;">Deep Dive Preview. Review before loading.</div>'
      + '<div class="ai-result-headline" style="font-size:15px;margin-bottom:6px;">' + escapeHtml(r.headline||'') + '</div>'
      + '<div style="font-size:12px;color:rgba(138,154,181,0.8);font-style:italic;margin-bottom:10px;">' + escapeHtml(r.deck||'') + '</div>'
      + '<div class="ai-result-desc">' + escapeHtml((r.body||'').split('\n\n')[0]) + '</div>'
      + '<div style="margin-top:10px;background:rgba(233,30,140,0.08);border-left:3px solid #e91e8c;padding:10px 12px;border-radius:0 6px 6px 0;font-size:11px;color:rgba(255,255,255,0.8);font-style:italic;">'
      + '<span style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#e91e8c;font-weight:700;font-style:normal;display:block;margin-bottom:4px;">The Game Angle</span>'
      + escapeHtml(r.angle||'') + '</div>'
      + '<button class="ai-result-use-btn" onclick="loadDeepDive(_staged.deepdive)" style="margin-top:12px;padding:8px 18px;font-size:11px;">Load into editor</button>'
      + '<button class="ai-result-use-btn" onclick="runDeepDiveSearch()" style="margin-top:12px;margin-left:8px;padding:8px 18px;font-size:11px;background:rgba(255,255,255,0.1);">Try again</button>'
      + '</div>';

  } catch(err) {
    results.innerHTML = '<div class="ai-finder-status">Could not generate the deep dive. Try a more specific topic.</div>';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Find and write the Deep Dive';
  }
}

function loadDeepDive(r) {
  if (r.headline)   document.getElementById('deepTitle').value = r.headline;
  if (r.source_url) {
    document.getElementById('deepUrl').value = r.source_url;
    var dtl = document.getElementById('deepUrl').nextElementSibling;
    if (dtl && dtl.tagName === 'A') { dtl.href = r.source_url; dtl.style.display = 'inline-block'; }
  }
  if (r.deck)       document.getElementById('deepDeck').value = r.deck;
  if (r.body)     document.getElementById('deepBody').value = r.body;
  if (r.takeaway) document.getElementById('deepTakeaway').value = r.takeaway;
  if (r.angle)    document.getElementById('deepGameAngle').value = r.angle;
  updateCounts();
  document.getElementById('deepDiveFinder').classList.remove('active');
  switchPanel('deepdive', document.querySelector('[data-panel="deepdive"]'));
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  showToast('Deep Dive loaded. Read it fully and make it yours before publishing.');
  updateWorkflow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI STORY FINDER (individual story for News/Econ)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let aiFinderTarget = null; // 'newsItems' or 'econItems'
let aiFinderType = null;   // 'Industry' or 'Economics'

function openAIFinder(containerId, type) {
  aiFinderTarget = containerId;
  aiFinderType = type;
  document.getElementById('aiFinderQuery').value = '';
  document.getElementById('aiFinderResults').innerHTML = '';
  document.getElementById('aiFinderBtn').disabled = false;
  document.getElementById('aiFinderBtn').textContent = 'Find and write the story';
  document.getElementById('aiFinderTitle').textContent = '‚ú¶ AI Find ' + type + ' Story';
  document.getElementById('aiFinderModal').classList.add('active');
  document.getElementById('aiFinderQuery').focus();
}

function closeAIFinder() {
  document.getElementById('aiFinderModal').classList.remove('active');
}

async function runAIFinderSearch() {
  const query = document.getElementById('aiFinderQuery').value.trim();
  if (!query) return;
  const btn = document.getElementById('aiFinderBtn');
  const results = document.getElementById('aiFinderResults');
  btn.disabled = true;
  btn.textContent = 'Researching and writing...';
  results.innerHTML = '<div class="ai-finder-status">Finding a real ' + aiFinderType.toLowerCase() + ' story and writing the full entry. This takes 15 to 30 seconds...</div>';

  const friday = selectedDate || nearestUpcomingFriday();
  const mode = classifyDate(friday);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fridayLabel = friday.getDate() + ' ' + months[friday.getMonth()] + ' ' + friday.getFullYear();

  let dateContext;
  if (mode === 'current' || mode === 'future') {
    dateContext = 'Find a real article published in the past 7 days.';
  } else if (mode === 'historical') {
    const weekStart = new Date(friday); weekStart.setDate(friday.getDate() - 6);
    const weekStartLabel = weekStart.getDate() + ' ' + months[weekStart.getMonth()] + ' ' + weekStart.getFullYear();
    dateContext = 'Find a real article published between ' + weekStartLabel + ' and ' + fridayLabel + '. This is a historical issue.';
  } else {
    dateContext = 'This is a retrospective issue for the week ending ' + fridayLabel + '. Reconstruct the story from knowledge of that period. Flag if URL is uncertain.';
  }

  const sectionLabel = aiFinderType === 'Economics' ? 'Economics' : 'Industry';

  const prompt = `You are a research editor and staff writer for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}. This issue covers the week ending ${fridayLabel}.

${dateContext}

Find ONE real Australian ${sectionLabel.toLowerCase()} story matching this topic: "${query}"

Then write it up as a complete newsletter entry.

${VOICE_RULES}

COMMENTARY: 3 short paragraphs separated by double newline. Total commentary must be 120 to 150 words. Be direct. No filler.
- Paragraph 1: What happened and the key facts (2-3 sentences)
- Paragraph 2: Why it matters to Australian hospitality operators (2-3 sentences)
- Paragraph 3: What to do or watch now (1-2 sentences)

GAME ANGLE: 2 to 3 sentences. Flip the obvious reading. Use an analogy from outside hospitality if it sharpens the point. Show the hidden dynamic without naming any psychological bias by its textbook term. Make the reader pause.
Return ONLY valid JSON, no markdown:
{"headline":"exact headline from the article","url":"https://direct-article-url","source":"Publication Name","commentary":"para 1\\n\\npara 2\\n\\npara 3","angle":"2-3 sentences. Flip the obvious reading. Use an unexpected analogy."}`;

  try {
    const raw = await callClaude(prompt, 'Find and write one real Australian ' + sectionLabel.toLowerCase() + ' story about: ' + query + '. Keep commentary to 120-150 words. Return JSON only.', 1000, true);
    const r = JSON.parse(raw);

    const preview = (r.commentary||'').split('\n\n')[0];
    const urlDisplay = r.url ? '<a href="' + encodeURI(r.url) + '" target="_blank" rel="noopener" style="color:#e91e8c;font-size:10px;">Test link ‚Üó</a>' : '';

    _staged.finder = r;
    results.innerHTML =
      '<div class="ai-result-card">'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#f4a7b9;font-weight:700;margin-bottom:10px;">' + escapeHtml(sectionLabel) + ' Story Preview. Review before loading.</div>'
      + '<div class="ai-result-headline" style="font-size:15px;margin-bottom:6px;">' + escapeHtml(r.headline||'') + '</div>'
      + '<div class="ai-result-url">' + urlDisplay + ' &nbsp;' + escapeHtml(r.source||'') + '</div>'
      + '<div class="ai-result-desc">' + escapeHtml(preview) + '</div>'
      + '<div style="margin-top:10px;background:rgba(233,30,140,0.08);border-left:3px solid #e91e8c;padding:10px 12px;border-radius:0 6px 6px 0;font-size:11px;color:rgba(255,255,255,0.8);font-style:italic;">'
      + '<span style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#e91e8c;font-weight:700;font-style:normal;display:block;margin-bottom:4px;">The Game Angle</span>'
      + escapeHtml(r.angle||'') + '</div>'
      + '<button class="ai-result-use-btn" onclick="loadAIFinderStory(_staged.finder)" style="margin-top:12px;padding:8px 18px;font-size:11px;">Load into editor ‚Üí</button>'
      + '<button class="ai-result-use-btn" onclick="runAIFinderSearch()" style="margin-top:12px;margin-left:8px;padding:8px 18px;font-size:11px;background:rgba(255,255,255,0.1);">Try again</button>'
      + '</div>';

  } catch(err) {
    results.innerHTML = '<div class="ai-finder-status">Could not find or write the story. Try a more specific topic.</div>';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Find and write the story';
  }
}

function loadAIFinderStory(r) {
  addNewsItem(aiFinderTarget, aiFinderType, {
    headline: r.headline || '',
    url: r.url || '',
    blurb: r.commentary || '',
    ref: '',
    angle: r.angle || ''
  });
  updateCounts();
  closeAIFinder();
  hideEmptyState();
  document.getElementById('previewModeBtn').style.display = '';
  document.getElementById('archiveModeBtn').style.display = '';
  const panelId = aiFinderTarget === 'econItems' ? 'econ' : 'news';
  switchPanel(panelId, document.querySelector('[data-panel="' + panelId + '"]'));
  showToast('Story loaded. Verify the source and make it yours before publishing.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITORIAL WRITER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditorialWriter() {
  // Check there's content to work with
  const newsCount = document.getElementById('newsItems').querySelectorAll('.news-item').length;
  const econCount = document.getElementById('econItems').querySelectorAll('.news-item').length;
  const hasDeep = document.getElementById('deepTitle').value.trim().length > 0;

  if (newsCount === 0 && econCount === 0 && !hasDeep) {
    showToast('Add some stories first. The editorial reads the issue to write the intro.');
    return;
  }

  document.getElementById('editorialPhase1').style.display = 'block';
  document.getElementById('editorialPhase2').style.display = 'none';
  document.getElementById('editorialLog').innerHTML = '';
  document.getElementById('editorialBar').style.width = '0%';
  document.getElementById('editorialWriteBtn').disabled = false;
  document.getElementById('editorialWriteBtn').textContent = 'Write the Editorial';

  // Pre-fill sign-off from existing value
  const existing = document.getElementById('introSignoff').value.trim();
  if (existing) document.getElementById('editorialSignoff').value = existing;

  document.getElementById('editorialWriterModal').classList.add('active');
}

function closeEditorialWriter() {
  document.getElementById('editorialWriterModal').classList.remove('active');
}

function gatherStorySummary() {
  // Build a text summary of all content in the issue for the AI to read
  var lines = [];

  // News stories
  document.getElementById('newsItems').querySelectorAll('.news-item').forEach(function(item, i) {
    var h = item.querySelector('.news-headline')?.value || '';
    var b = item.querySelector('.news-blurb')?.value || '';
    var a = item.querySelector('.inner-angle')?.value || '';
    if (h) lines.push('INDUSTRY STORY ' + (i+1) + ': ' + h + '\n' + b.substring(0, 300) + (a ? '\nGame Angle: ' + a : ''));
  });

  // Econ stories
  document.getElementById('econItems').querySelectorAll('.news-item').forEach(function(item, i) {
    var h = item.querySelector('.news-headline')?.value || '';
    var b = item.querySelector('.news-blurb')?.value || '';
    var a = item.querySelector('.inner-angle')?.value || '';
    if (h) lines.push('ECONOMICS STORY ' + (i+1) + ': ' + h + '\n' + b.substring(0, 300) + (a ? '\nGame Angle: ' + a : ''));
  });

  // Deep dive
  var deepTitle = document.getElementById('deepTitle').value.trim();
  var deepDeck = document.getElementById('deepDeck').value.trim();
  var deepAngle = document.getElementById('deepGameAngle').value.trim();
  if (deepTitle) lines.push('DEEP DIVE: ' + deepTitle + (deepDeck ? '\nDeck: ' + deepDeck : '') + (deepAngle ? '\nGame Angle: ' + deepAngle : ''));

  // Spotlight
  var spotName = document.getElementById('spotlightName').value.trim();
  if (spotName) lines.push('COMMUNITY SPOTLIGHT: ' + spotName);

  return lines.join('\n\n');
}

async function runEditorialWriter() {
  const btn = document.getElementById('editorialWriteBtn');
  const signoff = document.getElementById('editorialSignoff').value.trim() || 'JB';
  const tone = document.getElementById('editorialTone').value.trim();
  const summary = gatherStorySummary();

  btn.disabled = true;
  btn.textContent = 'Writing...';
  setProgress('editorialBar', 10);
  aiLog('editorialLog', 'Reading the issue content...', 'active');

  const friday = selectedDate || nearestUpcomingFriday();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fridayLabel = friday.getDate() + ' ' + months[friday.getMonth()] + ' ' + friday.getFullYear();

  const toneLine = tone ? '\nTone guidance from the editor: ' + tone : '';

  const prompt = `You are the editor-in-chief of Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ${TODAY}. This issue covers the week ending ${fridayLabel}.

Here is the full content of this week's issue:

${summary}

${VOICE_RULES}

Write the EDITORIAL INTRO and the ISSUE-WIDE GAME ANGLE for this issue.
${toneLine}

EDITORIAL INTRO has three parts:
1. HOOK ‚Äî One punchy opening sentence. It frames the entire issue. Make the reader lean in.
2. BODY ‚Äî 2 to 4 sentences. Your editorial voice reading the week. What connects these stories. Why it matters right now. What the reader should pay attention to. Do not summarise each story individually.
3. SIGN-OFF ‚Äî Use: "${signoff}"

ISSUE-WIDE GAME ANGLE:
This is the behavioural or systems-level insight that ties the whole issue together. 2 to 4 sentences. It should name the pattern, not just describe events. It should help the reader see something they would not see from reading the stories alone. This is the intellectual signature of the newsletter.

CRITICAL: Return ONLY valid JSON, no markdown, no preamble. Start with { and end with }.
{"hook":"the opening sentence","body":"the editorial body","signoff":"${signoff}","angle":"the issue-wide game angle"}`;

  setProgress('editorialBar', 30);
  aiLog('editorialLog', 'Writing the editorial and game angle...', 'active');

  try {
    const raw = await callClaude(prompt, 'Read the issue content and write the editorial intro and issue-wide game angle. Return JSON only.', 1500, false);
    const r = JSON.parse(raw);
    _staged.editorial = r;

    setProgress('editorialBar', 100);
    aiLog('editorialLog', 'Done. Review below.', 'done');

    // Render preview
    document.getElementById('editorialPreview').innerHTML =
      '<div class="ai-result-card">'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#f4a7b9;font-weight:700;margin-bottom:12px;">Editorial Preview</div>'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(138,154,181,0.6);margin-bottom:6px;">Opening Hook</div>'
      + '<div style="font-size:15px;font-weight:600;color:#fff;margin-bottom:14px;line-height:1.4;">' + escapeHtml(r.hook||'') + '</div>'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(138,154,181,0.6);margin-bottom:6px;">Editorial Body</div>'
      + '<div style="font-size:12px;color:rgba(255,255,255,0.8);line-height:1.7;margin-bottom:14px;">' + escapeHtml(r.body||'').replace(/\n/g,'<br>') + '</div>'
      + '<div style="font-size:11px;color:rgba(138,154,181,0.5);margin-bottom:16px;">‚Äî ' + escapeHtml(r.signoff||signoff) + '</div>'
      + '<div style="background:rgba(233,30,140,0.08);border-left:3px solid #e91e8c;padding:12px 14px;border-radius:0 6px 6px 0;">'
      + '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#e91e8c;font-weight:700;margin-bottom:6px;">üéØ Issue-wide Game Angle</div>'
      + '<div style="font-size:12px;color:rgba(255,255,255,0.8);line-height:1.7;font-style:italic;">' + escapeHtml(r.angle||'') + '</div>'
      + '</div>'
      + '</div>';

    document.getElementById('editorialPhase1').style.display = 'none';
    document.getElementById('editorialPhase2').style.display = 'block';

  } catch(err) {
    setProgress('editorialBar', 0);
    aiLog('editorialLog', 'Failed: ' + err.message + '. Try again.', 'error');
    btn.disabled = false;
    btn.textContent = 'Write the Editorial';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKFLOW PROGRESS TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var workflowState = { stories: false, editorial: false, resources: false, spotlight: false };

function updateWorkflow() {
  var bar = document.getElementById('workflowBar');
  var status = document.getElementById('workflowStatus');
  var actions = document.getElementById('workflowActions');

  workflowState.stories = document.getElementById('newsItems').querySelectorAll('.news-item').length > 0
    || document.getElementById('econItems').querySelectorAll('.news-item').length > 0
    || !!document.getElementById('deepTitle').value.trim();
  workflowState.editorial = !!document.getElementById('introHook').value.trim() && !!document.getElementById('introBody').value.trim();
  workflowState.resources = document.getElementById('resourceItems').querySelectorAll('.resource-item, .news-item').length > 0;
  workflowState.spotlight = !!document.getElementById('spotlightName').value.trim() && !!document.getElementById('spotlightStory').value.trim();

  if (!workflowState.stories) { bar.classList.remove('active'); return; }
  bar.classList.add('active');

  var steps = [
    { key: 'stories', label: 'Stories loaded' },
    { key: 'editorial', label: 'Editorial written' },
    { key: 'resources', label: 'Resources added' },
    { key: 'spotlight', label: 'Spotlight written' }
  ];

  var statusHTML = steps.map(function(s) {
    return workflowState[s.key]
      ? '<span class="done">‚úì ' + s.label + '</span>'
      : '<span class="pending">‚óã ' + s.label + '</span>';
  }).join(' &nbsp;‚Üí&nbsp; ');
  status.innerHTML = statusHTML;

  var actionsHTML = '';
  if (!workflowState.editorial) {
    actionsHTML = '<button class="wf-btn" onclick="openEditorialWriter()">‚ú¶ Write Editorial</button>'
      + '<button class="wf-btn secondary" onclick="hideWorkflowBar()">Dismiss</button>';
  } else if (!workflowState.resources) {
    actionsHTML = '<button class="wf-btn" onclick="wfRunResources()">‚ú¶ Write Resources</button>'
      + '<button class="wf-btn secondary" onclick="switchPanel(\'resources\', document.querySelector(\'[data-panel=resources]\'))">Edit Resources manually</button>'
      + '<button class="wf-btn secondary" onclick="hideWorkflowBar()">Dismiss</button>';
  } else if (!workflowState.spotlight) {
    actionsHTML = '<button class="wf-btn" onclick="openSpotlightFinder()">‚ú¶ Find Spotlight</button>'
      + '<button class="wf-btn secondary" onclick="switchPanel(\'spotlight\', document.querySelector(\'[data-panel=spotlight]\'))">Edit Spotlight manually</button>'
      + '<button class="wf-btn secondary" onclick="hideWorkflowBar()">Dismiss</button>';
  } else {
    actionsHTML = '<button class="wf-btn" onclick="showPreview()">All sections complete ‚Äî Preview Issue ‚Üí</button>'
      + '<button class="wf-btn secondary" onclick="hideWorkflowBar()">Dismiss</button>';
  }
  actions.innerHTML = actionsHTML;
}

function hideWorkflowBar() {
  document.getElementById('workflowBar').classList.remove('active');
}

async function wfRunResources() {
  // Show loading state on the workflow bar button
  var actions = document.getElementById('workflowActions');
  var origHTML = actions.innerHTML;
  actions.innerHTML = '<button class="wf-btn" disabled style="opacity:0.6;">Finding resources...</button>';

  // Check rate limit and show countdown in a toast if waiting
  var elapsed = Date.now() - lastApiCallTime;
  if (lastApiCallTime > 0 && elapsed < API_COOLDOWN_MS) {
    var waitSec = Math.ceil((API_COOLDOWN_MS - elapsed) / 1000);
    showToast('Rate limit cooldown: waiting ' + waitSec + 's before API call...');
  }

  try {
    await waitForRateLimit(null);
    // Now call runAutoResources but inline the logic so we control feedback
    var summary = gatherStorySummary();
    var prompt = 'You are a curator for Food Game Weekly Wrap, an Australian hospitality newsletter. Today is ' + TODAY + '.\n\nHere is this week\'s issue content for context:\n' + summary.substring(0, 1500) + '\n\nSuggest 3 genuinely useful standing resources for Australian hospitality operators. These should be real, verifiable tools, guides, reports, or references that help operators run better businesses. They should be relevant to the themes in this week\'s issue where possible.\n\nEach resource needs:\n- title: clear name\n- icon: one relevant emoji\n- desc: 1-2 sentences on why it is useful and who should use it. Written in the newsletter voice ‚Äî direct, no fluff.\n- url: a real, verifiable URL (government sites, industry bodies, established tools preferred)\n\nReturn ONLY valid JSON array, no markdown:\n[{"title":"...","icon":"...","desc":"...","url":"..."}]';

    var raw = await callClaude(prompt, 'Suggest 3 real Australian hospitality resources. Return JSON array only.', 1000, true);
    var resources = JSON.parse(raw);
    if (!Array.isArray(resources) || resources.length === 0) throw new Error('No resources returned');

    document.getElementById('resourceItems').innerHTML = '';
    resources.forEach(function(r) {
      addResourceItem({ title: r.title, icon: r.icon, desc: r.desc, url: r.url });
    });
    showToast(resources.length + ' resources loaded. Verify links and edit before publishing.');
    updateWorkflow();
  } catch(err) {
    showToast('Resource suggestion failed: ' + (err.message || err).toString().substring(0, 80));
    updateWorkflow();
  }
}

function loadEditorial() {
  const r = _staged.editorial;
  if (!r) return;

  if (r.hook)    document.getElementById('introHook').value = r.hook;
  if (r.body)    document.getElementById('introBody').value = r.body;
  if (r.signoff) document.getElementById('introSignoff').value = r.signoff;
  if (r.angle)   document.getElementById('introGameAngle').value = r.angle;

  updateCounts();
  closeEditorialWriter();
  setMode('edit');
  switchPanel('intro', document.querySelector('[data-panel="intro"]'));
  showToast('Editorial and Game Angle loaded. Review and refine before publishing.');
  updateWorkflow();
}

</script>

<!-- BUILD THIS ISSUE MODAL -->
<div class="ai-modal" id="buildModal">
  <div class="ai-box">
    <div class="ai-box-title">‚ö° Build This Issue</div>

    <div id="buildPhase1">
      <div class="ai-box-sub">Configure the issue. The AI scans the past 7 days and returns 12 real Australian hospitality and economics stories. You select 4 to 6, classify each one, and it writes everything in newsletter voice.</div>
      <div class="ai-config">
        <div class="ai-field"><label>Issue Number</label><input type="text" id="buildIssueNum" placeholder="002"/></div>
        <div class="ai-field"><label>Issue Date</label><input type="text" id="buildIssueDate" placeholder="25 Feb 2026"/></div>
        <div class="ai-field" style="grid-column:1/-1;"><label>Focus or theme this week (optional)</label><input type="text" id="buildFocus" placeholder="e.g. rising costs, post-summer trading. Leave blank for a broad scan."/></div>
      </div>
      <button class="ai-run-btn" id="buildScanBtn" onclick="runScan()">Scan this week's news</button>
      <div class="ai-progress-wrap"><div class="ai-progress-bar" id="buildBar"></div></div>
      <div class="ai-log" id="buildScanLog"></div>
    </div>

    <div id="buildPhase2" style="display:none;">
      <div class="ai-box-sub">Select 4 to 6 stories. Classify each as Industry, Economics, or Deep Dive. Only one story can be the Deep Dive.</div>
      <div class="selection-bar">
        <span class="selection-count" id="buildSelectionCount">0 selected</span>
        <span class="selection-hint">Select 4 to 6. One can be Deep Dive.</span>
      </div>
      <div id="buildMasterList"></div>
      <div class="ai-actions">
        <button class="ai-close-btn" onclick="buildBackToPhase1()">‚Üê Back to scan</button>
        <button class="ai-accept-btn" id="buildWriteBtn" onclick="runWriteSelected()" disabled>Write selected stories ‚Üí</button>
        <button class="ai-close-btn" onclick="closeBuildModal()">Cancel</button>
      </div>
    </div>

    <div id="buildPhase3" style="display:none;">
      <div class="ai-box-sub">Writing all selected stories in newsletter voice. Review below then load into editor.</div>
      <div class="ai-progress-wrap"><div class="ai-progress-bar" id="buildWriteBar"></div></div>
      <div class="ai-log" id="buildWriteLog"></div>
      <div id="buildWrittenList"></div>
      <div class="ai-actions" style="margin-top:16px;">
        <button class="ai-close-btn" onclick="buildBackToPhase2()">‚Üê Back to selection</button>
        <button class="ai-run-btn" id="buildRetryBtn" onclick="retryFailedWrites()" style="display:none;">Retry failed stories</button>
        <button class="ai-accept-btn" id="buildLoadBtn" onclick="loadAllIntoEditor()" style="display:none;">Load all into editor ‚Üí</button>
        <button class="ai-close-btn" onclick="closeBuildModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- COMMUNITY SPOTLIGHT FINDER -->
<div class="ai-modal" id="spotlightFinder">
  <div class="ai-box" style="width:640px;">
    <div class="ai-box-title">‚ú¶ Community Spotlight</div>
    <div id="spotlightPhase1">
      <div class="ai-box-sub">Type a search prompt to steer the scan, or leave blank for an open scan across Australian hospitality this week. The AI finds 4 real candidates.</div>
      <input class="ai-finder-input" id="spotlightQuery" placeholder="e.g. Melbourne bar, regional NSW, First Nations hospitality, zero alcohol... or leave blank" onkeydown="if(event.key==='Enter')runSpotlightScan()"/>
      <button class="ai-run-btn" id="spotlightScanBtn" onclick="runSpotlightScan()">Find spotlight candidates</button>
      <div class="ai-progress-wrap"><div class="ai-progress-bar" id="spotlightBar"></div></div>
      <div class="ai-log" id="spotlightScanLog"></div>
      <button class="ai-close-btn" onclick="closeSpotlightFinder()" style="margin-top:8px;">Cancel</button>
    </div>
    <div id="spotlightPhase2" style="display:none;">
      <div class="ai-box-sub">Pick one to write the full spotlight entry.</div>
      <div id="spotlightCandidates"></div>
      <button class="ai-close-btn" onclick="closeSpotlightFinder()" style="margin-top:8px;">Cancel</button>
    </div>
    <div id="spotlightPhase3" style="display:none;">
      <div id="spotlightWritten"></div>
      <button class="ai-close-btn" onclick="closeSpotlightFinder()" style="margin-top:8px;">Cancel</button>
    </div>
  </div>
</div>

<!-- DEEP DIVE FINDER -->
<div class="ai-modal" id="deepDiveFinder">
  <div class="ai-box" style="width:620px;">
    <div class="ai-box-title">‚ú¶ AI Deep Dive</div>
    <div class="ai-box-sub">Type a topic or theme. The AI researches it and writes the complete feature: headline, deck, 400 to 500 word body, takeaway, and Game Angle.</div>
    <input class="ai-finder-input" id="deepDiveQuery" placeholder="e.g. operator pricing psychology, what rate rises do to venue debt, the real cost of casual labour..." onkeydown="if(event.key==='Enter')runDeepDiveSearch()"/>
    <button class="ai-run-btn" id="deepDiveBtn" onclick="runDeepDiveSearch()">Find and write the Deep Dive</button>
    <div class="ai-finder-results" id="deepDiveResults"></div>
    <button class="ai-close-btn" onclick="document.getElementById('deepDiveFinder').classList.remove('active')" style="margin-top:8px;">Cancel</button>
  </div>
</div>

<!-- AI STORY FINDER -->
<div class="ai-modal" id="aiFinderModal">
  <div class="ai-box" style="width:620px;">
    <div class="ai-box-title" id="aiFinderTitle">‚ú¶ AI Find Story</div>
    <div class="ai-box-sub">Type a topic, event, or keyword. The AI finds a real article, writes the commentary and Game Angle, and loads it into the editor.</div>
    <input class="ai-finder-input" id="aiFinderQuery" placeholder="e.g. wage theft crackdown, visa worker shortage, pub closures regional..." onkeydown="if(event.key==='Enter')runAIFinderSearch()"/>
    <button class="ai-run-btn" id="aiFinderBtn" onclick="runAIFinderSearch()">Find and write the story</button>
    <div class="ai-finder-results" id="aiFinderResults"></div>
    <button class="ai-close-btn" onclick="closeAIFinder()" style="margin-top:8px;">Cancel</button>
  </div>
</div>

<!-- EDITORIAL WRITER -->
<div class="ai-modal" id="editorialWriterModal">
  <div class="ai-box" style="width:660px;">
    <div class="ai-box-title">‚ú¶ Write Editorial & Issue-wide Game Angle</div>
    <div id="editorialPhase1">
      <div class="ai-box-sub">The AI reads all stories currently in the editor and writes the Editorial Intro (hook, body, sign-off) and the Issue-wide Game Angle. Run this after editing is complete, before Preview.</div>
      <div style="margin:12px 0;">
        <div class="ai-field" style="margin-bottom:8px;"><label style="font-size:11px;color:rgba(138,154,181,0.7);">Sign-off name</label><input type="text" id="editorialSignoff" value="JB" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:8px 12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;width:100%;box-sizing:border-box;"/></div>
        <div class="ai-field"><label style="font-size:11px;color:rgba(138,154,181,0.7);">Tone guidance (optional)</label><input type="text" id="editorialTone" placeholder="e.g. urgent this week, cautiously optimistic, reflective..." style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:8px 12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;width:100%;box-sizing:border-box;"/></div>
      </div>
      <button class="ai-run-btn" id="editorialWriteBtn" onclick="runEditorialWriter()">Write the Editorial</button>
      <div class="ai-progress-wrap"><div class="ai-progress-bar" id="editorialBar"></div></div>
      <div class="ai-log" id="editorialLog"></div>
      <button class="ai-close-btn" onclick="closeEditorialWriter()" style="margin-top:8px;">Cancel</button>
    </div>
    <div id="editorialPhase2" style="display:none;">
      <div class="ai-box-sub">Review the editorial below. Load it into the editor to replace the current intro fields, or try again.</div>
      <div id="editorialPreview"></div>
      <div class="ai-actions" style="margin-top:12px;">
        <button class="ai-accept-btn" onclick="loadEditorial()">Load into editor ‚Üí</button>
        <button class="ai-close-btn" onclick="document.getElementById('editorialPhase1').style.display='block';document.getElementById('editorialPhase2').style.display='none';" style="margin-left:8px;">Try again</button>
        <button class="ai-close-btn" onclick="closeEditorialWriter()" style="margin-left:8px;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ PWA SERVICE WORKER (inline blob) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'fgww-v1';
    self.addEventListener('install', e => {
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(keys =>
        Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
      ));
    });
    self.addEventListener('fetch', e => {
      // Cache-first for same-origin, network-first for API calls
      if (e.request.url.includes('workers.dev') || e.request.url.includes('anthropic.com')) {
        return; // always go to network for API
      }
      e.respondWith(
        caches.match(e.request).then(cached => {
          if (cached) return cached;
          return fetch(e.request).then(resp => {
            if (resp && resp.status === 200 && resp.type === 'basic') {
              const clone = resp.clone();
              caches.open(CACHE).then(c => c.put(e.request, clone));
            }
            return resp;
          }).catch(() => cached);
        })
      );
    });
  `;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}
</script>
</body></html>
